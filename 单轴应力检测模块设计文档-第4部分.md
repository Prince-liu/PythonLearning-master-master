# å•è½´åº”åŠ›æ£€æµ‹æ¨¡å—è®¾è®¡æ–‡æ¡£ v1.0 - ç¬¬4éƒ¨åˆ†

> **åŒ…å«ç« èŠ‚**ï¼šç¬¬9ç«  APIæ¥å£è®¾è®¡ã€ç¬¬10ç«  å®ç°è®¡åˆ’  
> **ä¸Šä¸€éƒ¨åˆ†**ï¼š[ç¬¬3éƒ¨åˆ†](./å•è½´åº”åŠ›æ£€æµ‹æ¨¡å—è®¾è®¡æ–‡æ¡£-ç¬¬3éƒ¨åˆ†.md)  
> **è¿”å›é¦–é¡µ**ï¼š[ç¬¬1éƒ¨åˆ†](./å•è½´åº”åŠ›æ£€æµ‹æ¨¡å—è®¾è®¡æ–‡æ¡£.md)

---

## 9. API æ¥å£è®¾è®¡

### 9.0 é”™è¯¯ç å®šä¹‰

#### é”™è¯¯ç è§„èŒƒ

**è®¾è®¡åŸåˆ™**ï¼š
- ä½¿ç”¨4ä½æ•°å­—é”™è¯¯ç 
- ç¬¬1ä½è¡¨ç¤ºé”™è¯¯ç±»åˆ«ï¼ˆ1=å‚æ•°é”™è¯¯ï¼Œ2=ä¸šåŠ¡é”™è¯¯ï¼Œ3=ç³»ç»Ÿé”™è¯¯ï¼‰
- ç¬¬2-4ä½è¡¨ç¤ºå…·ä½“é”™è¯¯

**é”™è¯¯ç è¡¨**ï¼š

```python
class ErrorCode:
    """é”™è¯¯ç å®šä¹‰"""
    
    # æˆåŠŸ
    SUCCESS = 0
    
    # 1xxx - å‚æ•°é”™è¯¯
    INVALID_PARAMS = 1001           # å‚æ•°æ— æ•ˆ
    MISSING_REQUIRED_PARAM = 1002   # ç¼ºå°‘å¿…éœ€å‚æ•°
    PARAM_OUT_OF_RANGE = 1003       # å‚æ•°è¶…å‡ºèŒƒå›´
    INVALID_SHAPE_CONFIG = 1004     # å½¢çŠ¶é…ç½®æ— æ•ˆ
    INVALID_LAYOUT_CONFIG = 1005    # å¸ƒç‚¹é…ç½®æ— æ•ˆ
    INVALID_CALIBRATION_DATA = 1006 # æ ‡å®šæ•°æ®æ— æ•ˆ
    
    # 2xxx - ä¸šåŠ¡é”™è¯¯
    EXPERIMENT_NOT_FOUND = 2001     # å®éªŒä¸å­˜åœ¨
    EXPERIMENT_ALREADY_EXISTS = 2002 # å®éªŒå·²å­˜åœ¨
    EXPERIMENT_COMPLETED = 2003     # å®éªŒå·²å®Œæˆï¼ˆä¸å¯ä¿®æ”¹ï¼‰
    POINT_NOT_FOUND = 2004          # æµ‹ç‚¹ä¸å­˜åœ¨
    POINT_ALREADY_MEASURED = 2005   # æµ‹ç‚¹å·²æµ‹é‡
    CALIBRATION_NOT_LOADED = 2006   # æ ‡å®šæ•°æ®æœªåŠ è½½
    SHAPE_NOT_DEFINED = 2007        # å½¢çŠ¶æœªå®šä¹‰
    POINTS_NOT_GENERATED = 2008     # æµ‹ç‚¹æœªç”Ÿæˆ
    BASELINE_NOT_CAPTURED = 2009    # åŸºå‡†æ³¢å½¢æœªé‡‡é›†
    INSUFFICIENT_POINTS = 2010      # æµ‹ç‚¹æ•°ä¸è¶³ï¼ˆæ— æ³•æ’å€¼ï¼‰
    INVALID_POINT_STATUS = 2011     # æµ‹ç‚¹çŠ¶æ€æ— æ•ˆ
    
    # 3xxx - ç¤ºæ³¢å™¨é€šä¿¡é”™è¯¯
    SCOPE_NOT_CONNECTED = 3001      # ç¤ºæ³¢å™¨æœªè¿æ¥
    SCOPE_COMMUNICATION_ERROR = 3002 # ç¤ºæ³¢å™¨é€šä¿¡å¤±è´¥
    SCOPE_TIMEOUT = 3003            # ç¤ºæ³¢å™¨å“åº”è¶…æ—¶
    WAVEFORM_CAPTURE_FAILED = 3004  # æ³¢å½¢é‡‡é›†å¤±è´¥
    WAVEFORM_QUALITY_LOW = 3005     # æ³¢å½¢è´¨é‡è¿‡ä½
    
    # 4xxx - æ•°æ®å¤„ç†é”™è¯¯
    DENOISE_FAILED = 4001           # é™å™ªå¤„ç†å¤±è´¥
    CORRELATION_FAILED = 4002       # äº’ç›¸å…³è®¡ç®—å¤±è´¥
    INTERPOLATION_FAILED = 4003     # æ’å€¼è®¡ç®—å¤±è´¥
    CONTOUR_GENERATION_FAILED = 4004 # äº‘å›¾ç”Ÿæˆå¤±è´¥
    
    # 5xxx - æ•°æ®åº“é”™è¯¯
    DATABASE_ERROR = 5001           # æ•°æ®åº“æ“ä½œå¤±è´¥
    DATABASE_CONNECTION_ERROR = 5002 # æ•°æ®åº“è¿æ¥å¤±è´¥
    RECORD_NOT_FOUND = 5003         # è®°å½•ä¸å­˜åœ¨
    DUPLICATE_RECORD = 5004         # è®°å½•é‡å¤
    
    # 6xxx - æ–‡ä»¶IOé”™è¯¯
    FILE_NOT_FOUND = 6001           # æ–‡ä»¶ä¸å­˜åœ¨
    FILE_READ_ERROR = 6002          # æ–‡ä»¶è¯»å–å¤±è´¥
    FILE_WRITE_ERROR = 6003         # æ–‡ä»¶å†™å…¥å¤±è´¥
    FILE_FORMAT_ERROR = 6004        # æ–‡ä»¶æ ¼å¼é”™è¯¯
    HDF5_ERROR = 6005               # HDF5æ–‡ä»¶æ“ä½œå¤±è´¥
    
    # 9xxx - æœªçŸ¥é”™è¯¯
    UNKNOWN_ERROR = 9999            # æœªçŸ¥é”™è¯¯
```

**é”™è¯¯ç ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
from enum import IntEnum

class ErrorCode(IntEnum):
    """é”™è¯¯ç æšä¸¾"""
    SUCCESS = 0
    INVALID_PARAMS = 1001
    EXPERIMENT_NOT_FOUND = 2001
    SCOPE_NOT_CONNECTED = 3001
    # ... å…¶ä»–é”™è¯¯ç 

# ä½¿ç”¨ç¤ºä¾‹
def create_field_experiment(self, name, description):
    """åˆ›å»ºå®éªŒ"""
    try:
        # å‚æ•°éªŒè¯
        if not name or len(name) > 100:
            return {
                "success": False,
                "error_code": ErrorCode.INVALID_PARAMS,
                "message": "å®éªŒåç§°æ— æ•ˆï¼ˆé•¿åº¦1-100å­—ç¬¦ï¼‰"
            }
        
        # ä¸šåŠ¡é€»è¾‘
        exp_id = self.dm.create_experiment(name, description)
        
        return {
            "success": True,
            "error_code": ErrorCode.SUCCESS,
            "data": {"exp_id": exp_id}
        }
        
    except DatabaseError as e:
        logger.error(f"åˆ›å»ºå®éªŒå¤±è´¥ - æ•°æ®åº“é”™è¯¯: {str(e)}", exc_info=True)
        return {
            "success": False,
            "error_code": ErrorCode.DATABASE_ERROR,
            "message": f"æ•°æ®åº“æ“ä½œå¤±è´¥: {str(e)}"
        }
    except Exception as e:
        logger.error(f"åˆ›å»ºå®éªŒå¤±è´¥ - æœªçŸ¥é”™è¯¯: {str(e)}", exc_info=True)
        return {
            "success": False,
            "error_code": ErrorCode.UNKNOWN_ERROR,
            "message": f"æœªçŸ¥é”™è¯¯: {str(e)}"
        }
```

**å‰ç«¯é”™è¯¯å¤„ç†**ï¼š

```javascript
async function createExperiment(name, description) {
    const response = await pywebview.api.create_field_experiment(name, description);
    
    if (!response.success) {
        // æ ¹æ®é”™è¯¯ç æ˜¾ç¤ºä¸åŒæç¤º
        switch (response.error_code) {
            case 1001: // INVALID_PARAMS
                showToast(`âŒ å‚æ•°é”™è¯¯: ${response.message}`, 'error');
                break;
            case 2002: // EXPERIMENT_ALREADY_EXISTS
                showToast(`âš ï¸ å®éªŒå·²å­˜åœ¨: ${response.message}`, 'warning');
                break;
            case 5001: // DATABASE_ERROR
                showToast(`âŒ æ•°æ®åº“é”™è¯¯: ${response.message}`, 'error');
                break;
            default:
                showToast(`âŒ æ“ä½œå¤±è´¥: ${response.message}`, 'error');
        }
        return null;
    }
    
    return response.data;
}
```

---

### 9.1 é”™è¯¯æ—¥å¿—è§„èŒƒ

#### æ—¥å¿—çº§åˆ«

```python
import logging

# æ—¥å¿—çº§åˆ«å®šä¹‰
# DEBUG: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
# INFO: ä¸€èˆ¬ä¿¡æ¯ï¼ˆæ­£å¸¸æ“ä½œï¼‰
# WARNING: è­¦å‘Šä¿¡æ¯ï¼ˆå¯èƒ½çš„é—®é¢˜ï¼‰
# ERROR: é”™è¯¯ä¿¡æ¯ï¼ˆåŠŸèƒ½å¤±è´¥ï¼‰
# CRITICAL: ä¸¥é‡é”™è¯¯ï¼ˆç³»ç»Ÿçº§é—®é¢˜ï¼‰
```

#### æ—¥å¿—é…ç½®

```python
import logging
import os
from datetime import datetime

def setup_logger():
    """é…ç½®æ—¥å¿—ç³»ç»Ÿ"""
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    log_dir = 'logs'
    os.makedirs(log_dir, exist_ok=True)
    
    # æ—¥å¿—æ–‡ä»¶åï¼ˆæŒ‰æ—¥æœŸï¼‰
    log_file = os.path.join(log_dir, f'stress_detection_{datetime.now().strftime("%Y%m%d")}.log')
    
    # é…ç½®æ—¥å¿—æ ¼å¼
    log_format = '%(asctime)s - %(name)s - %(levelname)s - %(funcName)s:%(lineno)d - %(message)s'
    date_format = '%Y-%m-%d %H:%M:%S'
    
    # é…ç½®æ ¹æ—¥å¿—å™¨
    logging.basicConfig(
        level=logging.INFO,
        format=log_format,
        datefmt=date_format,
        handlers=[
            # æ–‡ä»¶å¤„ç†å™¨
            logging.FileHandler(log_file, encoding='utf-8'),
            # æ§åˆ¶å°å¤„ç†å™¨ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
            logging.StreamHandler()
        ]
    )
    
    # åˆ›å»ºæ¨¡å—æ—¥å¿—å™¨
    logger = logging.getLogger('stress_detection_uniaxial')
    logger.setLevel(logging.DEBUG)
    
    return logger

# åˆå§‹åŒ–æ—¥å¿—å™¨
logger = setup_logger()
```

#### æ—¥å¿—è®°å½•è§„èŒƒ

**1. å®éªŒç®¡ç†æ—¥å¿—**

```python
class FieldExperiment:
    def __init__(self, data_manager):
        self.dm = data_manager
        self.logger = logging.getLogger('stress_detection_uniaxial.experiment')
    
    def create_experiment(self, name, description):
        """åˆ›å»ºå®éªŒ"""
        self.logger.info(f"å¼€å§‹åˆ›å»ºå®éªŒ - åç§°: {name}")
        
        try:
            # å‚æ•°éªŒè¯
            if not name:
                self.logger.warning(f"åˆ›å»ºå®éªŒå¤±è´¥ - å®éªŒåç§°ä¸ºç©º")
                return {"success": False, "error_code": ErrorCode.INVALID_PARAMS}
            
            # åˆ›å»ºå®éªŒ
            exp_id = self.dm.create_experiment(name, description)
            
            self.logger.info(f"å®éªŒåˆ›å»ºæˆåŠŸ - ID: {exp_id}, åç§°: {name}")
            return {"success": True, "data": {"exp_id": exp_id}}
            
        except Exception as e:
            self.logger.error(f"åˆ›å»ºå®éªŒå¤±è´¥ - åç§°: {name}, é”™è¯¯: {str(e)}", exc_info=True)
            return {"success": False, "error_code": ErrorCode.DATABASE_ERROR}
    
    def load_experiment(self, exp_id):
        """åŠ è½½å®éªŒ"""
        self.logger.info(f"å¼€å§‹åŠ è½½å®éªŒ - ID: {exp_id}")
        
        try:
            data = self.dm.load_experiment(exp_id)
            
            if not data:
                self.logger.warning(f"åŠ è½½å®éªŒå¤±è´¥ - å®éªŒä¸å­˜åœ¨: {exp_id}")
                return {"success": False, "error_code": ErrorCode.EXPERIMENT_NOT_FOUND}
            
            self.logger.info(f"å®éªŒåŠ è½½æˆåŠŸ - ID: {exp_id}, æµ‹ç‚¹æ•°: {len(data.get('points', []))}")
            return {"success": True, "data": data}
            
        except Exception as e:
            self.logger.error(f"åŠ è½½å®éªŒå¤±è´¥ - ID: {exp_id}, é”™è¯¯: {str(e)}", exc_info=True)
            return {"success": False, "error_code": ErrorCode.DATABASE_ERROR}
```

**2. æ•°æ®é‡‡é›†æ—¥å¿—**

```python
class FieldCapture:
    def __init__(self, oscilloscope, data_manager, signal_processor):
        self.osc = oscilloscope
        self.dm = data_manager
        self.sp = signal_processor
        self.logger = logging.getLogger('stress_detection_uniaxial.capture')
    
    def capture_point(self, exp_id, point_id, auto_denoise=True):
        """é‡‡é›†å•ä¸ªæµ‹ç‚¹"""
        self.logger.info(f"å¼€å§‹é‡‡é›†æµ‹ç‚¹ - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}")
        
        try:
            # 1. æ£€æŸ¥ç¤ºæ³¢å™¨è¿æ¥
            if not self.osc.is_connected():
                self.logger.error(f"é‡‡é›†å¤±è´¥ - ç¤ºæ³¢å™¨æœªè¿æ¥ - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}")
                return {"success": False, "error_code": ErrorCode.SCOPE_NOT_CONNECTED}
            
            # 2. é‡‡é›†æ³¢å½¢
            self.logger.debug(f"é‡‡é›†RAWæ³¢å½¢ - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}")
            waveform = self.osc.capture_raw_waveform()
            
            if waveform is None:
                self.logger.error(f"æ³¢å½¢é‡‡é›†å¤±è´¥ - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}")
                return {"success": False, "error_code": ErrorCode.WAVEFORM_CAPTURE_FAILED}
            
            self.logger.debug(f"æ³¢å½¢é‡‡é›†æˆåŠŸ - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}, é•¿åº¦: {len(waveform)}")
            
            # 3. é™å™ªå¤„ç†
            if auto_denoise:
                self.logger.debug(f"å¼€å§‹é™å™ªå¤„ç† - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}")
                denoised = self.sp.apply_denoise(waveform)
                self.logger.debug(f"é™å™ªå®Œæˆ - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}")
            else:
                denoised = waveform
            
            # 4. äº’ç›¸å…³è®¡ç®—
            self.logger.debug(f"å¼€å§‹äº’ç›¸å…³è®¡ç®— - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}")
            baseline = self.dm.load_baseline(exp_id)
            time_diff = self.sp.calculate_correlation(baseline, denoised)
            
            # 5. è®¡ç®—åº”åŠ›
            calibration = self.dm.load_calibration(exp_id)
            stress = calibration['k'] * time_diff
            
            self.logger.info(f"æµ‹ç‚¹é‡‡é›†æˆåŠŸ - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}, "
                           f"æ—¶é—´å·®: {time_diff:.2f}ns, åº”åŠ›: {stress:.2f}MPa")
            
            # 6. ä¿å­˜æ•°æ®
            self.dm.save_point_data(exp_id, point_id, denoised, time_diff, stress)
            self.logger.debug(f"æµ‹ç‚¹æ•°æ®å·²ä¿å­˜ - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}")
            
            return {
                "success": True,
                "data": {
                    "time_diff": time_diff,
                    "stress": stress,
                    "quality_score": 0.95
                }
            }
            
        except Exception as e:
            self.logger.error(f"é‡‡é›†æµ‹ç‚¹å¤±è´¥ - å®éªŒ: {exp_id}, æµ‹ç‚¹: {point_id}, "
                            f"é”™è¯¯: {str(e)}", exc_info=True)
            return {"success": False, "error_code": ErrorCode.UNKNOWN_ERROR}
```

**3. æ•°æ®å¤„ç†æ—¥å¿—**

```python
class ContourGenerator:
    def __init__(self):
        self.logger = logging.getLogger('stress_detection_uniaxial.contour')
    
    def generate_contour(self, points, shape_config, method='cubic'):
        """ç”Ÿæˆäº‘å›¾"""
        self.logger.info(f"å¼€å§‹ç”Ÿæˆäº‘å›¾ - æµ‹ç‚¹æ•°: {len(points)}, æ–¹æ³•: {method}")
        
        try:
            # æ£€æŸ¥æµ‹ç‚¹æ•°
            if len(points) < 3:
                self.logger.warning(f"æµ‹ç‚¹æ•°ä¸è¶³ - å½“å‰: {len(points)}, æœ€å°‘éœ€è¦: 3")
                return {"success": False, "error_code": ErrorCode.INSUFFICIENT_POINTS}
            
            # æ’å€¼è®¡ç®—
            self.logger.debug(f"å¼€å§‹æ’å€¼è®¡ç®— - æµ‹ç‚¹æ•°: {len(points)}, æ–¹æ³•: {method}")
            xi, yi, zi = self._interpolate(points, method)
            
            self.logger.info(f"äº‘å›¾ç”ŸæˆæˆåŠŸ - æµ‹ç‚¹æ•°: {len(points)}, "
                           f"ç½‘æ ¼å¤§å°: {xi.shape}, åº”åŠ›èŒƒå›´: [{zi.min():.2f}, {zi.max():.2f}]MPa")
            
            return {
                "success": True,
                "data": {"xi": xi, "yi": yi, "zi": zi}
            }
            
        except Exception as e:
            self.logger.error(f"äº‘å›¾ç”Ÿæˆå¤±è´¥ - æµ‹ç‚¹æ•°: {len(points)}, "
                            f"é”™è¯¯: {str(e)}", exc_info=True)
            return {"success": False, "error_code": ErrorCode.CONTOUR_GENERATION_FAILED}
```

#### æ—¥å¿—æŸ¥çœ‹å’Œåˆ†æ

**æ—¥å¿—æ–‡ä»¶ä½ç½®**ï¼š
```
logs/
â”œâ”€â”€ stress_detection_20251220.log  # å½“å¤©æ—¥å¿—
â”œâ”€â”€ stress_detection_20251219.log  # æ˜¨å¤©æ—¥å¿—
â””â”€â”€ ...
```

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```
2025-12-20 14:30:15 - stress_detection_uniaxial.experiment - INFO - create_experiment:25 - å¼€å§‹åˆ›å»ºå®éªŒ - åç§°: é“æ¿åº”åŠ›åˆ†å¸ƒæµ‹è¯•
2025-12-20 14:30:15 - stress_detection_uniaxial.experiment - INFO - create_experiment:35 - å®éªŒåˆ›å»ºæˆåŠŸ - ID: FIELD001, åç§°: é“æ¿åº”åŠ›åˆ†å¸ƒæµ‹è¯•
2025-12-20 14:32:10 - stress_detection_uniaxial.capture - INFO - capture_point:15 - å¼€å§‹é‡‡é›†æµ‹ç‚¹ - å®éªŒ: FIELD001, æµ‹ç‚¹: 1
2025-12-20 14:32:10 - stress_detection_uniaxial.capture - DEBUG - capture_point:23 - é‡‡é›†RAWæ³¢å½¢ - å®éªŒ: FIELD001, æµ‹ç‚¹: 1
2025-12-20 14:32:11 - stress_detection_uniaxial.capture - DEBUG - capture_point:30 - æ³¢å½¢é‡‡é›†æˆåŠŸ - å®éªŒ: FIELD001, æµ‹ç‚¹: 1, é•¿åº¦: 10000
2025-12-20 14:32:11 - stress_detection_uniaxial.capture - DEBUG - capture_point:35 - å¼€å§‹é™å™ªå¤„ç† - å®éªŒ: FIELD001, æµ‹ç‚¹: 1
2025-12-20 14:32:11 - stress_detection_uniaxial.capture - DEBUG - capture_point:37 - é™å™ªå®Œæˆ - å®éªŒ: FIELD001, æµ‹ç‚¹: 1
2025-12-20 14:32:11 - stress_detection_uniaxial.capture - INFO - capture_point:48 - æµ‹ç‚¹é‡‡é›†æˆåŠŸ - å®éªŒ: FIELD001, æµ‹ç‚¹: 1, æ—¶é—´å·®: 12.35ns, åº”åŠ›: 45.30MPa
2025-12-20 14:32:11 - stress_detection_uniaxial.capture - DEBUG - capture_point:52 - æµ‹ç‚¹æ•°æ®å·²ä¿å­˜ - å®éªŒ: FIELD001, æµ‹ç‚¹: 1
```

**æ—¥å¿—åˆ†æå·¥å…·**ï¼ˆå¯é€‰ï¼‰ï¼š
```python
# ç»Ÿè®¡é”™è¯¯æ—¥å¿—
grep "ERROR" logs/stress_detection_20251220.log | wc -l

# æŸ¥çœ‹ç‰¹å®šå®éªŒçš„æ—¥å¿—
grep "FIELD001" logs/stress_detection_20251220.log

# æŸ¥çœ‹é‡‡é›†å¤±è´¥çš„æ—¥å¿—
grep "é‡‡é›†å¤±è´¥" logs/stress_detection_20251220.log
```

---

### 9.2 åç«¯ APIï¼ˆPythonï¼‰

#### å®éªŒç®¡ç†
```python
class StressDetectionUniaxial:
    """åº”åŠ›æ£€æµ‹æ¨¡å— API"""
    
    def create_field_experiment(self, name, calibration_exp_id, 
                               calibration_direction, shape_config):
        """åˆ›å»ºåº”åŠ›åœºå®éªŒ"""
        return {
            "success": True,
            "data": {
                "experiment_id": "FIELD001",
                "name": name,
                "created_at": "2025-12-19 14:30:00"
            }
        }
    
    def load_field_experiment(self, experiment_id):
        """åŠ è½½å®éªŒ"""
        return {
            "success": True,
            "data": {
                "experiment_id": experiment_id,
                "name": "å¹³æ¿åº”åŠ›åˆ†å¸ƒæµ‹è¯•",
                "shape_config": {...},
                "point_layout": [...],
                "measured_points": [...]
            }
        }
    
    def delete_field_experiment(self, experiment_id):
        """åˆ é™¤å®éªŒ"""
        return {"success": True, "message": "å®éªŒå·²åˆ é™¤"}
```

#### å½¢çŠ¶å’Œå¸ƒç‚¹
```python
    def validate_shape(self, shape_config):
        """éªŒè¯å½¢çŠ¶é…ç½®"""
        return {
            "success": True,
            "data": {
                "is_valid": True,
                "area": 15000.0,
                "warnings": []
            }
        }
    
    def generate_point_layout(self, shape_config, layout_type, params):
        """ç”Ÿæˆæµ‹ç‚¹å¸ƒå±€"""
        return {
            "success": True,
            "data": {
                "points": [
                    {"id": 1, "x": 10.0, "y": 10.0},
                    {"id": 2, "x": 30.0, "y": 10.0},
                    # ...
                ],
                "total_count": 25,
                "valid_count": 23
            }
        }
    
    def optimize_point_order(self, points, strategy='zigzag'):
        """ä¼˜åŒ–æµ‹ç‚¹é¡ºåº"""
        return {
            "success": True,
            "data": {
                "optimized_points": [...],
                "total_distance": 450.5
            }
        }
```

#### æ•°æ®é‡‡é›†
```python
    def capture_field_point(self, experiment_id, point_id):
        """é‡‡é›†å•ä¸ªæµ‹ç‚¹"""
        return {
            "success": True,
            "data": {
                "point_id": point_id,
                "time_diff": 45.23,
                "stress": 120.5,
                "quality_score": 0.95
            }
        }
    
    def skip_field_point(self, experiment_id, point_id):
        """è·³è¿‡æµ‹ç‚¹"""
        return {"success": True, "message": f"æµ‹ç‚¹ #{point_id} å·²è·³è¿‡"}
    
    def retry_field_point(self, experiment_id, point_id):
        """é‡æµ‹æµ‹ç‚¹"""
        return {
            "success": True,
            "data": {
                "point_id": point_id,
                "time_diff": 46.12,
                "stress": 125.3
            }
        }
```

#### äº‘å›¾ç”Ÿæˆ
```python
    def update_field_contour(self, experiment_id):
        """æ›´æ–°äº‘å›¾"""
        return {
            "success": True,
            "data": {
                "mode": "contour",  # 'points_only' | 'contour'
                "grid": {
                    "xi": [[...]],
                    "yi": [[...]],
                    "zi": [[...]]
                },
                "method": "cubic",
                "confidence": "full"
            }
        }
    
    def export_field_contour_image(self, experiment_id, format='png'):
        """å¯¼å‡ºäº‘å›¾å›¾ç‰‡"""
        return {
            "success": True,
            "data": {
                "file_path": "data/exports/field_001.png"
            }
        }
    
    def export_field_data(self, experiment_id, format='csv'):
        """å¯¼å‡ºæ•°æ®"""
        return {
            "success": True,
            "data": {
                "file_path": "data/exports/field_001_data.csv"
            }
        }
```

#### ç»Ÿè®¡åˆ†æ
```python
    def get_field_statistics(self, experiment_id):
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        return {
            "success": True,
            "data": {
                "n_measured": 23,
                "n_total": 25,
                "max_stress": 158.7,
                "max_stress_point": 3,
                "min_stress": 0.0,
                "min_stress_point": 1,
                "mean_stress": 78.3,
                "std_stress": 42.1
            }
        }
```

### 9.2 å‰ç«¯è°ƒç”¨ç¤ºä¾‹

#### åˆ›å»ºå®éªŒ
```javascript
async function createFieldExperiment() {
    const result = await pywebview.api.create_field_experiment(
        "å¹³æ¿åº”åŠ›åˆ†å¸ƒæµ‹è¯•",
        "EXP003",
        "0Â°",
        shapeConfig
    );
    
    if (result.success) {
        experimentId = result.data.experiment_id;
        console.log("å®éªŒåˆ›å»ºæˆåŠŸ:", experimentId);
    }
}
```

#### ç”Ÿæˆæµ‹ç‚¹
```javascript
async function generatePoints() {
    const result = await pywebview.api.generate_point_layout(
        shapeConfig,
        'grid',
        {rows: 5, cols: 5, margin: 10}
    );
    
    if (result.success) {
        points = result.data.points;
        drawPointsPreview(points);
    }
}
```

#### é‡‡é›†å¾ªç¯
```javascript
async function startCapture() {
    for (const point of points) {
        if (point.status === 'pending') {
            // æç¤ºç”¨æˆ·
            showMessage(`è¯·ç§»åŠ¨æ¢å¤´åˆ°æµ‹ç‚¹ #${point.id} (${point.x}, ${point.y})`);
            
            // é‡‡é›†
            const result = await pywebview.api.capture_field_point(experimentId, point.id);
            
            if (result.success) {
                // æ›´æ–°æ•°æ®
                point.stress = result.data.stress;
                point.status = 'measured';
                updateTable(point);
                
                // æ›´æ–°äº‘å›¾
                await updateContour();
            }
        }
    }
}
```

#### å®æ—¶äº‘å›¾æ›´æ–°
```javascript
async function updateContour() {
    const result = await pywebview.api.update_field_contour(experimentId);
    
    if (result.success) {
        if (result.data.mode === 'contour') {
            ContourDrawing.drawContourMap(canvas, result.data.grid, shapeConfig);
            
            if (result.data.confidence === 'preview') {
                showWarning('æ•°æ®ç‚¹è¾ƒå°‘ï¼Œäº‘å›¾ä»…ä¾›å‚è€ƒ');
            }
        } else {
            drawDiscretePoints(points);
        }
    }
}
```

---

## 10. å®æ–½è®¡åˆ’

### 10.0 å‰ç½®å‡†å¤‡ï¼šæ¸…ç†æ—§ä»£ç 

âš ï¸ **é‡è¦**ï¼šæœ¬æ¨¡å—ä¸ºå®Œå…¨é‡å†™ç‰ˆæœ¬ï¼Œéœ€å…ˆåˆ é™¤æ—§ä»£ç ï¼Œå†åˆ›å»ºæ–°æ–‡ä»¶ã€‚

#### ç¬¬0æ­¥ï¼šåˆ é™¤æ—§æ–‡ä»¶

**åç«¯ï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰**ï¼š
```bash
# åˆ é™¤æ—§çš„å•ç‚¹æ£€æµ‹ä»£ç 
rm modules/stress_detection_uniaxial/stress_detection_uniaxial.py
rm -rf modules/stress_detection_uniaxial/__pycache__
```

**å‰ç«¯ï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰**ï¼š
```bash
# åˆ é™¤æ—§çš„å•ç‚¹æ£€æµ‹UI
rm static/js/stress-detection-uniaxial/stress-detection-uniaxial.js
```

**è¯´æ˜**ï¼š
- æ—§ç‰ˆæœ¬ä¸ºå•ç‚¹å®æ—¶æ£€æµ‹åŠŸèƒ½ï¼Œå·²åºŸå¼ƒ
- æ–°ç‰ˆæœ¬ä¸ºåº”åŠ›åœºæµ‹ç»˜åŠŸèƒ½ï¼Œå®Œå…¨é‡æ–°è®¾è®¡
- `__init__.py` ä¿ç•™ä½†éœ€è¦æ›´æ–°å¯¼å‡ºå†…å®¹

---

### 10.1 MVP ç‰ˆæœ¬ï¼ˆç¬¬ä¸€ç‰ˆï¼‰

#### æ ¸å¿ƒåŠŸèƒ½
- âœ… çŸ©å½¢è¯•ä»¶å½¢çŠ¶å®šä¹‰
- âœ… ç½‘æ ¼å¸ƒç‚¹ï¼ˆæ”¯æŒå‡åŒ€é—´è·å’Œå˜é—´è·ï¼‰
- âœ… ç½‘æ ¼å¸ƒç‚¹æ”¯æŒåˆ†åˆ«è®¾ç½®å››è¾¹è¾¹è·
- âœ… æ‰‹åŠ¨é€ç‚¹é‡‡é›†ï¼ˆåŠè‡ªåŠ¨æ¨¡å¼ï¼‰
- âœ… è‡ªåŠ¨é™å™ªï¼ˆsym6å°æ³¢ï¼Œ5å±‚ï¼Œsofté˜ˆå€¼ï¼Œheursureæ¨¡å¼ï¼‰
- âœ… åŸºç¡€äº‘å›¾æ˜¾ç¤ºï¼ˆcubicæ’å€¼ï¼‰
- âœ… æ•°æ®è¡¨æ ¼æ˜¾ç¤º
- âœ… CSV å¯¼å‡º

#### æŠ€æœ¯å®ç°
```
åç«¯æ¨¡å—ï¼ˆ6ä¸ªæ–‡ä»¶ï¼‰:
  modules/stress_detection_uniaxial/
    â”œâ”€â”€ __init__.py                  (æ›´æ–°å¯¼å‡º)
    â”œâ”€â”€ field_experiment.py          (æ–°å»º - å®éªŒç®¡ç†)
    â”œâ”€â”€ field_capture.py             (æ–°å»º - é‡‡é›†æ§åˆ¶)
    â”œâ”€â”€ shape_utils.py               (æ–°å»º - å½¢çŠ¶å·¥å…·)
    â”œâ”€â”€ point_generator.py           (æ–°å»º - æµ‹ç‚¹ç”Ÿæˆ)
    â”œâ”€â”€ interpolation.py             (æ–°å»º - æ’å€¼ç®—æ³•)
    â””â”€â”€ contour_generator.py         (æ–°å»º - äº‘å›¾ç”Ÿæˆ)

å‰ç«¯æ¨¡å—ï¼ˆ7ä¸ªæ–‡ä»¶ï¼‰:
  static/js/stress-detection-uniaxial/
    â”œâ”€â”€ stress-detection-uniaxial.js      (æ–°å»º - ä¸»æ¨¡å—)
    â”œâ”€â”€ field-experiment-manager.js       (æ–°å»º - å®éªŒç®¡ç†UI)
    â”œâ”€â”€ field-calibration-panel.js        (æ–°å»º - æ ‡å®šé¢æ¿)
    â”œâ”€â”€ field-shape-panel.js              (æ–°å»º - å½¢çŠ¶é¢æ¿)
    â”œâ”€â”€ field-layout-panel.js             (æ–°å»º - å¸ƒç‚¹é¢æ¿)
    â”œâ”€â”€ field-capture-panel.js            (æ–°å»º - é‡‡é›†é¢æ¿)
    â”œâ”€â”€ field-canvas.js                   (æ–°å»º - é¢„è§ˆç”»å¸ƒ)
    â””â”€â”€ field-contour.js                  (æ–°å»º - äº‘å›¾æ˜¾ç¤º)

æ ·å¼:
  static/css/stress-detection.css
```

#### æ–‡ä»¶æ›´æ–°æ¸…å•

**éœ€è¦æ›´æ–°çš„ç°æœ‰æ–‡ä»¶**ï¼š
1. `modules/stress_detection_uniaxial/__init__.py` - æ›´æ–°æ¨¡å—å¯¼å‡º
2. `web_gui.py` - åˆ é™¤æ—§APIï¼Œæ·»åŠ æ–°API
3. `static/index.html` - æ›´æ–°æ¨¡å—å¼•ç”¨å’ŒHTMLç»“æ„

**å®Œå…¨æ›¿æ¢ï¼Œä¸€ç‚¹ä¸ç•™ï¼**

#### æ•°æ®åº“
```sql
-- æ–°å¢ä¸‰ä¸ªè¡¨
CREATE TABLE field_experiments (...);
CREATE TABLE field_points (...);
CREATE TABLE field_metadata (...);
```

#### å¼€å‘æ—¶é—´ä¼°ç®—
- åç«¯ APIï¼š2-3å¤©
- å‰ç«¯ UIï¼š3-4å¤©
- äº‘å›¾ç®—æ³•ï¼š2å¤©
- æµ‹è¯•è°ƒè¯•ï¼š2å¤©
- **æ€»è®¡ï¼š9-11å¤©**

### 10.2 ç¬¬äºŒç‰ˆåŠŸèƒ½

#### æ–°å¢åŠŸèƒ½
- âœ… åœ†å½¢è¯•ä»¶æ”¯æŒ
- âœ… å¸ƒå°”è¿ç®—ï¼ˆå­”æ´/ç¼ºå£ï¼‰
- âœ… æåæ ‡å¸ƒç‚¹
- âœ… å˜é—´è·å¸ƒç‚¹
- âœ… ç»å¯¹åº”åŠ›æ¨¡å¼ï¼ˆæ”¯æŒè¾“å…¥åŸºå‡†ç‚¹åº”åŠ›å€¼ï¼‰
- âœ… å®æ—¶äº‘å›¾æ›´æ–°ï¼ˆé‡‡é›†è¿‡ç¨‹ä¸­ï¼‰
- âœ… æµ‹ç‚¹é¡ºåºä¼˜åŒ–
- âœ… è‡ªåŠ¨é‡‡é›†æ¨¡å¼
- âœ… å¼‚å¸¸æ£€æµ‹å’Œé‡æµ‹
- âœ… ç­‰å€¼çº¿æ˜¾ç¤º
- âœ… Excel å¯¼å‡º
- âœ… é¢„è§ˆç”»å¸ƒç½‘æ ¼æ˜¾ç¤ºï¼ˆè‡ªé€‚åº”é—´è· + åˆ»åº¦æ ‡æ³¨ï¼‰

#### æŠ€æœ¯å¢å¼º
```python
# æ–°å¢ä¾èµ–
requirements.txt:
  shapely>=2.0.0      # å‡ ä½•è¿ç®—
  openpyxl>=3.0.0     # Excelå¯¼å‡º
```

#### å¼€å‘æ—¶é—´ä¼°ç®—
- å½¢çŠ¶ç¼–è¾‘å™¨ï¼š3å¤©
- é«˜çº§å¸ƒç‚¹ï¼š2å¤©
- å®æ—¶æ›´æ–°ï¼š2å¤©
- è‡ªåŠ¨åŒ–åŠŸèƒ½ï¼š2å¤©
- ç½‘æ ¼æ˜¾ç¤ºï¼š0.5å¤©
- ç»å¯¹åº”åŠ›æ¨¡å¼ï¼š0.5å¤©
- **æ€»è®¡ï¼š10å¤©**

### 10.3 ç¬¬ä¸‰ç‰ˆåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

#### é«˜çº§åŠŸèƒ½
- âœ… è‡ªå®šä¹‰å¤šè¾¹å½¢
- âœ… å¯¼å…¥ DXF/SVG è½®å»“
- âœ… æ‰‹åŠ¨ç»˜åˆ¶è½®å»“
- âœ… å¤šæ¬¡æµ‹é‡å¯¹æ¯”
- âœ… å†å²è®°å½•ç®¡ç†
- âœ… 3D åº”åŠ›åœºæ˜¾ç¤º
- âœ… åŠ¨ç”»æ¼”ç¤ºï¼ˆé‡‡é›†è¿‡ç¨‹å›æ”¾ï¼‰
- âœ… æŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆï¼ˆPDFï¼‰

#### æŠ€æœ¯æ ˆæ‰©å±•
```python
# æ–°å¢ä¾èµ–
requirements.txt:
  ezdxf>=1.0.0        # DXFæ–‡ä»¶è¯»å–
  svgpathtools>=1.5.0 # SVGè·¯å¾„è§£æ
  reportlab>=4.0.0    # PDFç”Ÿæˆ
  matplotlib>=3.5.0   # é«˜çº§ç»˜å›¾
```

#### å¼€å‘æ—¶é—´ä¼°ç®—
- æ–‡ä»¶å¯¼å…¥ï¼š3å¤©
- å¤šæ¬¡å¯¹æ¯”ï¼š2å¤©
- 3Dæ˜¾ç¤ºï¼š4å¤©
- æŠ¥å‘Šç”Ÿæˆï¼š3å¤©
- **æ€»è®¡ï¼š12å¤©**

### 10.4 å¼€å‘ä¼˜å…ˆçº§

#### P0ï¼ˆå¿…é¡»ï¼‰- MVP
1. çŸ©å½¢ + ç½‘æ ¼å¸ƒç‚¹
2. æ‰‹åŠ¨é‡‡é›†
3. åŸºç¡€äº‘å›¾
4. æ•°æ®è¡¨æ ¼

#### P1ï¼ˆé‡è¦ï¼‰- ç¬¬äºŒç‰ˆ
1. åœ†å½¢æ”¯æŒ
2. å­”æ´/ç¼ºå£
3. å®æ—¶æ›´æ–°
4. è‡ªåŠ¨æ¨¡å¼

#### P2ï¼ˆå¯é€‰ï¼‰- ç¬¬ä¸‰ç‰ˆ
1. è‡ªå®šä¹‰å¤šè¾¹å½¢
2. æ–‡ä»¶å¯¼å…¥
3. 3Dæ˜¾ç¤º
4. é«˜çº§æŠ¥å‘Š

### 10.5 æ³¨æ„äº‹é¡¹

#### ç›¸å¯¹åº”åŠ›è¯´æ˜
âš ï¸ **æœ¬æ¨¡å—æµ‹é‡çš„æ˜¯ç›¸å¯¹åº”åŠ›åˆ†å¸ƒï¼Œè€Œéç»å¯¹åº”åŠ›å€¼**

- ä»¥åŸºå‡†æµ‹ç‚¹ï¼ˆé»˜è®¤#1ï¼‰ä¸ºå‚è€ƒé›¶ç‚¹
- æ˜¾ç¤ºå„æµ‹ç‚¹ç›¸å¯¹äºåŸºå‡†ç‚¹çš„åº”åŠ›å·®
- å¦‚éœ€ç»å¯¹åº”åŠ›ï¼Œè¯·åœ¨"åŸºå‡†åº”åŠ›"ä¸­è¾“å…¥å·²çŸ¥å€¼è¿›è¡Œæ ¡å‡†
- å¯¹äºæ®‹ä½™åº”åŠ›æœªçŸ¥çš„å¤ææ¿ï¼Œå»ºè®®å…³æ³¨åº”åŠ›æ¢¯åº¦è€Œéç»å¯¹å€¼

#### åº”åŠ›æ­£è´Ÿè¯´æ˜

**ç‰©ç†æ„ä¹‰**ï¼š
- **æ‹‰åº”åŠ›**ï¼šæ­£å€¼ï¼ˆ+ï¼‰ï¼Œææ–™å—æ‹‰ä¼¸
- **å‹åº”åŠ›**ï¼šè´Ÿå€¼ï¼ˆ-ï¼‰ï¼Œææ–™å—å‹ç¼©
- **é›¶åº”åŠ›**ï¼šåŸºå‡†ç‚¹ï¼Œç›¸å¯¹åº”åŠ›ä¸º0

**è®¡ç®—å…¬å¼**ï¼š
```
Ïƒ = k Ã— Î”t

å…¶ä¸­:
- Ïƒ: åº”åŠ›å€¼ï¼ˆMPaï¼‰
- k: åº”åŠ›ç³»æ•°ï¼ˆç”±æ ‡å®šå®éªŒæ‹Ÿåˆå¾—åˆ°ï¼Œå¯æ­£å¯è´Ÿï¼‰
- Î”t: å£°æ—¶å·®ï¼ˆnsï¼Œç›¸å¯¹äºåŸºå‡†æ³¢å½¢ï¼‰
```

**ç³»æ•°æ­£è´Ÿç”±æ ‡å®šå†³å®š**ï¼š

**æƒ…å†µ1**ï¼ˆå¸¸è§ææ–™ï¼‰ï¼š
- æ ‡å®šæ—¶ï¼šæ‹‰åº”åŠ› â†’ å£°æ—¶å¢åŠ  â†’ Î”t > 0
- æ‹Ÿåˆå¾—åˆ°ï¼šk > 0ï¼ˆæ­£ç³»æ•°ï¼‰
- æ£€æµ‹æ—¶ï¼š
  - Î”t > 0 â†’ Ïƒ > 0ï¼ˆæ‹‰åº”åŠ›ï¼‰
  - Î”t < 0 â†’ Ïƒ < 0ï¼ˆå‹åº”åŠ›ï¼‰

**æƒ…å†µ2**ï¼ˆç‰¹æ®Šææ–™ï¼‰ï¼š
- æ ‡å®šæ—¶ï¼šæ‹‰åº”åŠ› â†’ å£°æ—¶å‡å°‘ â†’ Î”t < 0
- æ‹Ÿåˆå¾—åˆ°ï¼šk < 0ï¼ˆè´Ÿç³»æ•°ï¼‰
- æ£€æµ‹æ—¶ï¼š
  - Î”t > 0 â†’ Ïƒ < 0ï¼ˆå‹åº”åŠ›ï¼‰
  - Î”t < 0 â†’ Ïƒ > 0ï¼ˆæ‹‰åº”åŠ›ï¼‰

**ç³»ç»Ÿå¤„ç†**ï¼š
- æ ‡å®šæ¨¡å—è‡ªåŠ¨æ‹Ÿåˆåº”åŠ›ç³»æ•° kï¼ˆä¿ç•™æ­£è´Ÿï¼‰
- æ£€æµ‹æ¨¡å—ç›´æ¥ä½¿ç”¨ Ïƒ = k Ã— Î”t è®¡ç®—
- è‡ªåŠ¨ä¿ç•™åº”åŠ›å€¼çš„æ­£è´Ÿå·
- äº‘å›¾æ ¹æ®åº”åŠ›æ­£è´Ÿæ˜¾ç¤ºä¸åŒé¢œè‰²

**äº‘å›¾é…è‰²æ–¹æ¡ˆ**ï¼š
```
æ‹‰åº”åŠ›åŒºåŸŸï¼ˆæ­£å€¼ï¼‰ï¼š
  +100 MPa â–  çº¢è‰²ï¼ˆæœ€å¤§æ‹‰åº”åŠ›ï¼‰
   +50 MPa â–  æ©™è‰²
   +25 MPa â–  é»„è‰²
  
é›¶åº”åŠ›åŒºåŸŸï¼š
     0 MPa â–  ç»¿è‰²ï¼ˆåŸºå‡†ï¼‰
  
å‹åº”åŠ›åŒºåŸŸï¼ˆè´Ÿå€¼ï¼‰ï¼š
   -25 MPa â–  é’è‰²
   -50 MPa â–  è“è‰²
  -100 MPa â–  ç´«è‰²ï¼ˆæœ€å¤§å‹åº”åŠ›ï¼‰
```

**è¡¨æ ¼æ˜¾ç¤ºç¤ºä¾‹**ï¼š
```
# â”‚ X(mm) â”‚ Y(mm) â”‚ Î”t(ns) â”‚ Ïƒ(MPa) â”‚çŠ¶æ€â”‚
1 â”‚ 10.0  â”‚ 10.0  â”‚  0.00  â”‚   0.0  â”‚ âœ“  â”‚ â† åŸºå‡†ç‚¹
2 â”‚ 30.0  â”‚ 10.0  â”‚ +12.3  â”‚ +45.2  â”‚ âœ“  â”‚ â† æ‹‰åº”åŠ›
3 â”‚ 50.0  â”‚ 10.0  â”‚ -8.5   â”‚ -28.5  â”‚ âœ“  â”‚ â† å‹åº”åŠ›
```

**æ³¨æ„äº‹é¡¹**ï¼š
- ç³»ç»Ÿä¸å‡è®¾åº”åŠ›ä¸å£°æ—¶å·®çš„æ­£è´Ÿå…³ç³»
- å®Œå…¨ç”±æ ‡å®šæ•°æ®å†³å®šåº”åŠ›ç³»æ•°çš„æ­£è´Ÿ
- é€‚ç”¨äºå„ç§ææ–™å’Œæµ‹è¯•æ¡ä»¶
- äº‘å›¾è‡ªåŠ¨é€‚é…æ­£è´Ÿå€¼èŒƒå›´

#### æ•°æ®è´¨é‡
- å‰3ä¸ªæµ‹ç‚¹ï¼šä¸ç”Ÿæˆäº‘å›¾ï¼Œä»…æ˜¾ç¤ºç¦»æ•£ç‚¹
- 4-8ä¸ªæµ‹ç‚¹ï¼šä½¿ç”¨çº¿æ€§æ’å€¼ï¼Œæ ‡æ³¨"é¢„è§ˆæ¨¡å¼"
- 9ä¸ªä»¥ä¸Šæµ‹ç‚¹ï¼šä½¿ç”¨ä¸‰æ¬¡æ’å€¼ï¼Œå®Œæ•´äº‘å›¾

#### æµ‹ç‚¹å¸ƒç½®å»ºè®®
- åº”åŠ›æ¢¯åº¦å¤§çš„åŒºåŸŸå¢åŠ æµ‹ç‚¹å¯†åº¦
- è¾¹è·å»ºè®® â‰¥ 5mmï¼ˆé¿å…è¾¹ç•Œæ•ˆåº”ï¼‰
- å­”æ´å‘¨å›´å»ºè®®åŠ å¯†å¸ƒç‚¹
- æ€»æµ‹ç‚¹æ•°å»ºè®® 16-49 ä¸ªï¼ˆå¹³è¡¡ç²¾åº¦å’Œæ•ˆç‡ï¼‰

---

### 10.6 æ•°æ®éªŒè¯è§„åˆ™ï¼ˆé—®é¢˜8.2ï¼‰

#### æ³¢å½¢è´¨é‡è¯„ä¼°æ ‡å‡†ï¼ˆé—®é¢˜2ï¼šä¸¥é‡é—®é¢˜ï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š
- æ¯é‡‡é›†ä¸€ä¸ªæµ‹ç‚¹ï¼Œç«‹å³è¯„ä¼°æ³¢å½¢è´¨é‡
- å®æ—¶åé¦ˆç»™ç”¨æˆ·ï¼Œè´¨é‡å·®çš„ç‚¹å¯ç«‹å³é‡æµ‹
- ç¡®ä¿æœ€ç»ˆäº‘å›¾åŸºäºé«˜è´¨é‡æ•°æ®

**è´¨é‡è¯„ä¼°æŒ‡æ ‡**ï¼š

```python
def calculate_snr(voltage):
    """è®¡ç®—ä¿¡å™ªæ¯” (Signal-to-Noise Ratio)
    
    æ–¹æ³•ï¼šå°†æ³¢å½¢åˆ†ä¸ºä¿¡å·åŒºå’Œå™ªå£°åŒº
    - ä¿¡å·åŒºï¼šå³°å€¼é™„è¿‘çš„ä¸»è¦æ³¢åŒ…
    - å™ªå£°åŒºï¼šæ³¢å½¢å‰åçš„å¹³å¦åŒºåŸŸ
    
    å‚æ•°:
        voltage: ç”µå‹æ•°ç»„
    
    è¿”å›:
        snr: ä¿¡å™ªæ¯” (dB)
    """
    # 1. æ‰¾åˆ°å³°å€¼ä½ç½®
    peak_idx = np.argmax(np.abs(voltage))
    
    # 2. å®šä¹‰ä¿¡å·åŒºï¼ˆå³°å€¼å‰åå„500ä¸ªç‚¹ï¼‰
    signal_start = max(0, peak_idx - 500)
    signal_end = min(len(voltage), peak_idx + 500)
    signal = voltage[signal_start:signal_end]
    
    # 3. å®šä¹‰å™ªå£°åŒºï¼ˆæ³¢å½¢å‰1000ä¸ªç‚¹ï¼‰
    noise = voltage[:1000]
    
    # 4. è®¡ç®—ä¿¡å·åŠŸç‡å’Œå™ªå£°åŠŸç‡
    signal_power = np.mean(signal ** 2)
    noise_power = np.mean(noise ** 2)
    
    # 5. è®¡ç®—SNR (dB)
    if noise_power > 0:
        snr = 10 * np.log10(signal_power / noise_power)
    else:
        snr = 100.0  # å™ªå£°ä¸º0ï¼ŒSNRæé«˜
    
    return snr

def evaluate_waveform_quality(waveform, baseline_waveform=None):
    """è¯„ä¼°æ³¢å½¢è´¨é‡
    
    å‚æ•°:
        waveform: å½“å‰æ³¢å½¢ {"time": array, "voltage": array}
        baseline_waveform: åŸºå‡†æ³¢å½¢ï¼ˆå¯é€‰ï¼Œç”¨äºè®¡ç®—äº’ç›¸å…³ç³»æ•°ï¼‰
    
    è¿”å›:
        {
            "score": 0.95,              # ç»¼åˆè¯„åˆ† 0-1
            "grade": "ä¼˜ç§€",            # ç­‰çº§
            "color": "green",           # æ˜¾ç¤ºé¢œè‰²
            "snr": 28.5,               # ä¿¡å™ªæ¯” (dB)
            "peak_amplitude": 2.3,     # å³°å€¼å¹…åº¦ (V)
            "corr_coef": 0.98,         # äº’ç›¸å…³ç³»æ•°ï¼ˆä¸åŸºå‡†æ³¢å½¢ï¼‰
            "is_acceptable": True,     # æ˜¯å¦å¯æ¥å—
            "warnings": []             # è­¦å‘Šä¿¡æ¯
        }
    """
    voltage = waveform['voltage']
    
    # 1. è®¡ç®—ä¿¡å™ªæ¯”
    snr = calculate_snr(voltage)
    
    # 2. è®¡ç®—å³°å€¼å¹…åº¦
    peak_amplitude = np.max(np.abs(voltage))
    
    # 3. æ£€æŸ¥æ˜¯å¦æˆªæ–­
    is_clipped = (np.max(voltage) >= 4.9) or (np.min(voltage) <= -4.9)
    
    # 4. è®¡ç®—äº’ç›¸å…³ç³»æ•°ï¼ˆå¦‚æœæœ‰åŸºå‡†æ³¢å½¢ï¼‰
    corr_coef = 1.0
    if baseline_waveform is not None:
        from scipy.signal import correlate
        baseline_v = baseline_waveform['voltage']
        
        # å½’ä¸€åŒ–äº’ç›¸å…³
        corr = correlate(voltage, baseline_v, mode='valid')
        corr_coef = np.max(corr) / (np.linalg.norm(voltage) * np.linalg.norm(baseline_v))
    
    # 5. è®¡ç®—å„é¡¹å¾—åˆ†ï¼ˆ0-1ï¼‰
    snr_score = min(snr / 30.0, 1.0)           # SNR 30dB = æ»¡åˆ†
    amp_score = 1.0 if 0.5 <= peak_amplitude <= 4.0 else 0.5
    clip_score = 0.0 if is_clipped else 1.0
    corr_score = corr_coef
    
    # 6. ç»¼åˆè¯„åˆ†ï¼ˆåŠ æƒå¹³å‡ï¼‰
    score = (
        0.35 * snr_score +      # ä¿¡å™ªæ¯”æƒé‡ 35%
        0.15 * amp_score +      # å¹…åº¦æƒé‡ 15%
        0.15 * clip_score +     # æˆªæ–­æ£€æŸ¥æƒé‡ 15%
        0.35 * corr_score       # äº’ç›¸å…³æƒé‡ 35%
    )
    
    # 7. è´¨é‡ç­‰çº§
    if score >= 0.9:
        grade = "ä¼˜ç§€"
        color = "green"
        stars = "â˜…â˜…â˜…â˜…â˜…"
    elif score >= 0.75:
        grade = "è‰¯å¥½"
        color = "blue"
        stars = "â˜…â˜…â˜…â˜…â˜†"
    elif score >= 0.6:
        grade = "ä¸€èˆ¬"
        color = "orange"
        stars = "â˜…â˜…â˜…â˜†â˜†"
    else:
        grade = "è¾ƒå·®"
        color = "red"
        stars = "â˜…â˜…â˜†â˜†â˜†"
    
    # 8. æ˜¯å¦å¯æ¥å—ï¼ˆè¯„åˆ† â‰¥ 0.6ï¼‰
    is_acceptable = score >= 0.6
    
    # 9. ç”Ÿæˆè­¦å‘Šä¿¡æ¯
    warnings = []
    if snr < 20:
        warnings.append(f"ä¿¡å™ªæ¯”è¿‡ä½ ({snr:.1f} dB < 20 dB)")
    if peak_amplitude < 0.5:
        warnings.append(f"ä¿¡å·å¹…åº¦è¿‡å° ({peak_amplitude:.2f} V < 0.5 V)")
    if peak_amplitude > 4.0:
        warnings.append(f"ä¿¡å·å¹…åº¦è¿‡å¤§ ({peak_amplitude:.2f} V > 4.0 V)")
    if is_clipped:
        warnings.append("æ³¢å½¢æˆªæ–­ï¼Œè¯·é™ä½ç¤ºæ³¢å™¨å¢ç›Š")
    if corr_coef < 0.8:
        warnings.append(f"æ³¢å½¢ç›¸ä¼¼åº¦ä½ ({corr_coef:.2f} < 0.8)")
    
    return {
        "score": round(score, 2),
        "grade": grade,
        "color": color,
        "stars": stars,
        "snr": round(snr, 1),
        "peak_amplitude": round(peak_amplitude, 2),
        "corr_coef": round(corr_coef, 2),
        "is_clipped": is_clipped,
        "is_acceptable": is_acceptable,
        "warnings": warnings
    }
```

**è´¨é‡æ ‡å‡†æ€»ç»“**ï¼š

| ç­‰çº§ | è¯„åˆ†èŒƒå›´ | SNR | å¹…åº¦ | äº’ç›¸å…³ | æ˜¾ç¤º |
|------|---------|-----|------|--------|------|
| ä¼˜ç§€ | â‰¥ 0.9   | â‰¥ 27 dB | 0.5-4.0 V | â‰¥ 0.95 | â˜…â˜…â˜…â˜…â˜… ç»¿è‰² |
| è‰¯å¥½ | 0.75-0.9 | 20-27 dB | 0.5-4.0 V | 0.85-0.95 | â˜…â˜…â˜…â˜…â˜† è“è‰² |
| ä¸€èˆ¬ | 0.6-0.75 | 15-20 dB | 0.3-4.5 V | 0.75-0.85 | â˜…â˜…â˜…â˜†â˜† æ©™è‰² |
| è¾ƒå·® | < 0.6   | < 15 dB | < 0.3 V æˆ– > 4.5 V | < 0.75 | â˜…â˜…â˜†â˜†â˜† çº¢è‰² |

**å®æ—¶åé¦ˆæµç¨‹**ï¼š

```python
async def capture_point_with_quality_check(point_id):
    """é‡‡é›†æµ‹ç‚¹å¹¶è¿›è¡Œè´¨é‡æ£€æŸ¥"""
    # 1. é‡‡é›†æ³¢å½¢
    waveform = await capture_waveform()
    
    # 2. åŠ è½½åŸºå‡†æ³¢å½¢
    baseline = load_baseline_waveform()
    
    # 3. è¯„ä¼°è´¨é‡
    quality = evaluate_waveform_quality(waveform, baseline)
    
    # 4. è®¡ç®—æ—¶é—´å·®å’Œåº”åŠ›
    time_diff = calculate_cross_correlation(baseline, waveform)
    stress = calculate_stress(time_diff, calibration)
    
    # 5. ä¿å­˜æ•°æ®ï¼ˆåŒ…å«è´¨é‡ä¿¡æ¯ï¼‰
    save_point_data(point_id, {
        'waveform': waveform,
        'time_diff': time_diff,
        'stress': stress,
        'quality_score': quality['score'],
        'snr': quality['snr'],
        'is_suspicious': not quality['is_acceptable']
    })
    
    # 6. å®æ—¶åé¦ˆ
    if quality['is_acceptable']:
        # è´¨é‡åˆæ ¼ï¼Œæ˜¾ç¤ºç®€çŸ­æç¤º
        show_toast(f"âœ“ æµ‹ç‚¹ #{point_id} é‡‡é›†æˆåŠŸ ({quality['grade']} {quality['stars']})", 'success')
    else:
        # è´¨é‡ä¸åˆæ ¼ï¼Œå¼¹å‡ºè­¦å‘Šå¯¹è¯æ¡†
        show_quality_warning_dialog(point_id, quality)
    
    return quality
```

**å‰ç«¯è´¨é‡è­¦å‘Šå¯¹è¯æ¡†**ï¼š

```javascript
function showQualityWarningDialog(pointId, quality) {
    const html = `
        <div class="quality-warning-dialog">
            <h3>âš ï¸ æµ‹ç‚¹ #${pointId} è´¨é‡è¾ƒå·®</h3>
            
            <div class="quality-summary">
                <div class="quality-score">
                    <span class="score-value" style="color: ${quality.color}">
                        ${quality.score}
                    </span>
                    <span class="score-grade">${quality.grade}</span>
                    <span class="score-stars">${quality.stars}</span>
                </div>
            </div>
            
            <div class="quality-details">
                <h4>è´¨é‡æŒ‡æ ‡ï¼š</h4>
                <ul>
                    <li>ä¿¡å™ªæ¯”: ${quality.snr} dB ${quality.snr < 20 ? 'âŒ' : 'âœ“'}</li>
                    <li>å³°å€¼å¹…åº¦: ${quality.peak_amplitude} V ${quality.peak_amplitude < 0.5 ? 'âŒ' : 'âœ“'}</li>
                    <li>æ³¢å½¢ç›¸ä¼¼åº¦: ${quality.corr_coef} ${quality.corr_coef < 0.8 ? 'âŒ' : 'âœ“'}</li>
                    ${quality.is_clipped ? '<li>âš ï¸ æ³¢å½¢æˆªæ–­</li>' : ''}
                </ul>
            </div>
            
            ${quality.warnings.length > 0 ? `
                <div class="quality-warnings">
                    <h4>é—®é¢˜ï¼š</h4>
                    <ul>
                        ${quality.warnings.map(w => `<li>${w}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <div class="quality-suggestions">
                <h4>å»ºè®®ï¼š</h4>
                <ul>
                    ${quality.snr < 20 ? '<li>æ£€æŸ¥æ¢å¤´è€¦åˆï¼Œç¡®ä¿è€¦åˆå‰‚å……è¶³</li>' : ''}
                    ${quality.peak_amplitude < 0.5 ? '<li>å¢åŠ ç¤ºæ³¢å™¨å¢ç›Š</li>' : ''}
                    ${quality.peak_amplitude > 4.0 ? '<li>é™ä½ç¤ºæ³¢å™¨å¢ç›Š</li>' : ''}
                    ${quality.is_clipped ? '<li>é™ä½ç¤ºæ³¢å™¨å¢ç›Šï¼Œé¿å…æˆªæ–­</li>' : ''}
                    ${quality.corr_coef < 0.8 ? '<li>æ£€æŸ¥æ¢å¤´ä½ç½®æ˜¯å¦æ­£ç¡®</li>' : ''}
                </ul>
            </div>
            
            <div class="dialog-actions">
                <button class="btn btn-primary" onclick="retryPoint(${pointId})">
                    ğŸ”„ é‡æ–°æµ‹é‡
                </button>
                <button class="btn btn-warning" onclick="acceptAndContinue(${pointId})">
                    âš ï¸ æ¥å—å¹¶ç»§ç»­
                </button>
                <button class="btn btn-secondary" onclick="skipPoint(${pointId})">
                    â­ï¸ è·³è¿‡æ­¤ç‚¹
                </button>
            </div>
        </div>
    `;
    
    showDialog(html);
}
```

#### è´¨é‡æ£€æŸ¥æ¨¡å¼åˆ‡æ¢

**è®¾è®¡ç›®æ ‡**ï¼š
- ç”¨æˆ·å¯ä»¥æ ¹æ®æµ‹è¯•éœ€æ±‚é€‰æ‹©è´¨é‡æ£€æŸ¥æ¨¡å¼
- **ä¸¥æ ¼æ¨¡å¼**ï¼šç²¾ç»†æµ‹é‡ï¼Œè´¨é‡ä¸åˆæ ¼æ—¶å¼¹å‡ºè­¦å‘Šå¯¹è¯æ¡†
- **å¿«é€Ÿæ¨¡å¼**ï¼šç²—ç•¥æµ‹é‡ï¼Œåªæ˜¾ç¤ºç®€çŸ­æç¤ºï¼Œä¸ä¸­æ–­æµç¨‹

**å‰ç«¯ç•Œé¢ï¼ˆå·¦ä¾§æ§åˆ¶é¢æ¿ï¼‰**ï¼š

```html
<!-- è´¨é‡æ£€æŸ¥æ¨¡å¼åˆ‡æ¢ -->
<div class="config-section">
    <label class="config-label">è´¨é‡æ£€æŸ¥æ¨¡å¼</label>
    
    <div class="quality-mode-switch">
        <button class="mode-btn active" data-mode="strict" id="strictModeBtn">
            <span class="mode-icon">ğŸ”</span>
            <span class="mode-name">ä¸¥æ ¼æ¨¡å¼</span>
            <span class="mode-desc">ç²¾ç»†æµ‹é‡</span>
        </button>
        
        <button class="mode-btn" data-mode="fast" id="fastModeBtn">
            <span class="mode-icon">âš¡</span>
            <span class="mode-name">å¿«é€Ÿæ¨¡å¼</span>
            <span class="mode-desc">ç²—ç•¥æµ‹é‡</span>
        </button>
    </div>
    
    <div class="mode-description">
        <div id="strictModeDesc" class="mode-detail active">
            <p>âœ“ å®æ—¶è´¨é‡è¯„ä¼°</p>
            <p>âœ“ è´¨é‡ä¸åˆæ ¼æ—¶å¼¹å‡ºè­¦å‘Š</p>
            <p>âœ“ å¯é€‰æ‹©é‡æµ‹æˆ–è·³è¿‡</p>
            <p class="mode-note">é€‚åˆæ­£å¼å®éªŒå’Œé«˜ç²¾åº¦æµ‹é‡</p>
        </div>
        
        <div id="fastModeDesc" class="mode-detail">
            <p>âœ“ ä»…æ˜¾ç¤ºç®€çŸ­æç¤º</p>
            <p>âœ“ ä¸ä¸­æ–­é‡‡é›†æµç¨‹</p>
            <p>âœ“ è´¨é‡ä¿¡æ¯ä¿å­˜åˆ°è¡¨æ ¼</p>
            <p class="mode-note">é€‚åˆå¿«é€Ÿé¢„æµ‹å’Œç²—ç•¥æ‰«æ</p>
        </div>
    </div>
</div>
```

**CSS æ ·å¼**ï¼š

```css
/* è´¨é‡æ£€æŸ¥æ¨¡å¼åˆ‡æ¢ */
.quality-mode-switch {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
}

.mode-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 12px 8px;
    background: #f3f4f6;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.mode-btn:hover {
    background: #e5e7eb;
    border-color: #d1d5db;
}

.mode-btn.active {
    background: #dbeafe;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.mode-icon {
    font-size: 24px;
}

.mode-name {
    font-size: 13px;
    font-weight: 600;
    color: #333;
}

.mode-desc {
    font-size: 11px;
    color: #666;
}

.mode-btn.active .mode-name {
    color: #2563eb;
}

.mode-description {
    position: relative;
    min-height: 120px;
}

.mode-detail {
    display: none;
    padding: 12px;
    background: #f9fafb;
    border-radius: 6px;
    border-left: 3px solid #2563eb;
}

.mode-detail.active {
    display: block;
}

.mode-detail p {
    margin: 6px 0;
    font-size: 12px;
    color: #374151;
}

.mode-note {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #e5e7eb;
    color: #6b7280;
    font-style: italic;
}
```

**JavaScript å®ç°**ï¼š

```javascript
// è´¨é‡æ£€æŸ¥æ¨¡å¼çŠ¶æ€
let qualityCheckMode = 'strict';  // 'strict' | 'fast'

// åˆå§‹åŒ–æ¨¡å¼åˆ‡æ¢
function initQualityModeSwitch() {
    const strictBtn = document.getElementById('strictModeBtn');
    const fastBtn = document.getElementById('fastModeBtn');
    const strictDesc = document.getElementById('strictModeDesc');
    const fastDesc = document.getElementById('fastModeDesc');
    
    strictBtn.addEventListener('click', () => {
        qualityCheckMode = 'strict';
        strictBtn.classList.add('active');
        fastBtn.classList.remove('active');
        strictDesc.classList.add('active');
        fastDesc.classList.remove('active');
        
        showToast('å·²åˆ‡æ¢åˆ°ä¸¥æ ¼æ¨¡å¼ - è´¨é‡ä¸åˆæ ¼æ—¶å°†å¼¹å‡ºè­¦å‘Š', 'info');
    });
    
    fastBtn.addEventListener('click', () => {
        qualityCheckMode = 'fast';
        fastBtn.classList.add('active');
        strictBtn.classList.remove('active');
        fastDesc.classList.add('active');
        strictDesc.classList.remove('active');
        
        showToast('å·²åˆ‡æ¢åˆ°å¿«é€Ÿæ¨¡å¼ - ä¸ä¸­æ–­é‡‡é›†æµç¨‹', 'info');
    });
}

// ä¿®æ”¹åçš„é‡‡é›†æµç¨‹
async function capture_point_with_quality_check(point_id) {
    // 1. é‡‡é›†æ³¢å½¢
    const waveform = await captureWaveform();
    
    // 2. åŠ è½½åŸºå‡†æ³¢å½¢
    const baseline = await loadBaselineWaveform();
    
    // 3. è¯„ä¼°è´¨é‡
    const quality = await evaluateWaveformQuality(waveform, baseline);
    
    // 4. è®¡ç®—æ—¶é—´å·®å’Œåº”åŠ›
    const time_diff = calculateCrossCorrelation(baseline, waveform);
    const stress = calculateStress(time_diff, calibration);
    
    // 5. ä¿å­˜æ•°æ®
    await savePointData(point_id, {
        waveform: waveform,
        time_diff: time_diff,
        stress: stress,
        quality_score: quality.score,
        snr: quality.snr,
        is_suspicious: !quality.is_acceptable
    });
    
    // 6. æ›´æ–°è¡¨æ ¼æ˜¾ç¤ºï¼ˆå§‹ç»ˆæ˜¾ç¤ºè´¨é‡ä¿¡æ¯ï¼‰
    updateTableRow(point_id, {
        time_diff: time_diff,
        stress: stress,
        quality: quality
    });
    
    // 7. æ ¹æ®æ¨¡å¼å†³å®šåé¦ˆæ–¹å¼
    if (qualityCheckMode === 'strict') {
        // ä¸¥æ ¼æ¨¡å¼ï¼šè´¨é‡ä¸åˆæ ¼æ—¶å¼¹å‡ºè­¦å‘Š
        if (quality.is_acceptable) {
            showToast(`âœ“ æµ‹ç‚¹ #${point_id} é‡‡é›†æˆåŠŸ (${quality.grade} ${quality.stars})`, 'success');
        } else {
            // å¼¹å‡ºè­¦å‘Šå¯¹è¯æ¡†ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
            const action = await showQualityWarningDialog(point_id, quality);
            
            if (action === 'retry') {
                // é‡æ–°æµ‹é‡
                return await capture_point_with_quality_check(point_id);
            } else if (action === 'skip') {
                // è·³è¿‡æ­¤ç‚¹
                await markPointAsSkipped(point_id);
            }
            // 'accept' - æ¥å—å¹¶ç»§ç»­ï¼Œä¸åšé¢å¤–æ“ä½œ
        }
    } else {
        // å¿«é€Ÿæ¨¡å¼ï¼šåªæ˜¾ç¤ºç®€çŸ­æç¤ºï¼Œä¸ä¸­æ–­æµç¨‹
        if (quality.is_acceptable) {
            showToast(`âœ“ #${point_id} ${quality.stars}`, 'success', 1500);
        } else {
            showToast(`âš ï¸ #${point_id} ${quality.stars} (è´¨é‡è¾ƒå·®)`, 'warning', 2000);
        }
    }
    
    return quality;
}

// ä¿®æ”¹è­¦å‘Šå¯¹è¯æ¡†ï¼Œè¿”å›ç”¨æˆ·é€‰æ‹©
async function showQualityWarningDialog(pointId, quality) {
    return new Promise((resolve) => {
        const html = `
            <div class="quality-warning-dialog">
                <h3>âš ï¸ æµ‹ç‚¹ #${pointId} è´¨é‡è¾ƒå·®</h3>
                
                <div class="quality-summary">
                    <div class="quality-score">
                        <span class="score-value" style="color: ${quality.color}">
                            ${quality.score}
                        </span>
                        <span class="score-grade">${quality.grade}</span>
                        <span class="score-stars">${quality.stars}</span>
                    </div>
                </div>
                
                <div class="quality-details">
                    <h4>è´¨é‡æŒ‡æ ‡ï¼š</h4>
                    <ul>
                        <li>ä¿¡å™ªæ¯”: ${quality.snr} dB ${quality.snr < 20 ? 'âŒ' : 'âœ“'}</li>
                        <li>å³°å€¼å¹…åº¦: ${quality.peak_amplitude} V ${quality.peak_amplitude < 0.5 ? 'âŒ' : 'âœ“'}</li>
                        <li>æ³¢å½¢ç›¸ä¼¼åº¦: ${quality.corr_coef} ${quality.corr_coef < 0.8 ? 'âŒ' : 'âœ“'}</li>
                        ${quality.is_clipped ? '<li>âš ï¸ æ³¢å½¢æˆªæ–­</li>' : ''}
                    </ul>
                </div>
                
                ${quality.warnings.length > 0 ? `
                    <div class="quality-warnings">
                        <h4>é—®é¢˜ï¼š</h4>
                        <ul>
                            ${quality.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                
                <div class="quality-suggestions">
                    <h4>å»ºè®®ï¼š</h4>
                    <ul>
                        ${quality.snr < 20 ? '<li>æ£€æŸ¥æ¢å¤´è€¦åˆï¼Œç¡®ä¿è€¦åˆå‰‚å……è¶³</li>' : ''}
                        ${quality.peak_amplitude < 0.5 ? '<li>å¢åŠ ç¤ºæ³¢å™¨å¢ç›Š</li>' : ''}
                        ${quality.peak_amplitude > 4.0 ? '<li>é™ä½ç¤ºæ³¢å™¨å¢ç›Š</li>' : ''}
                        ${quality.is_clipped ? '<li>é™ä½ç¤ºæ³¢å™¨å¢ç›Šï¼Œé¿å…æˆªæ–­</li>' : ''}
                        ${quality.corr_coef < 0.8 ? '<li>æ£€æŸ¥æ¢å¤´ä½ç½®æ˜¯å¦æ­£ç¡®</li>' : ''}
                    </ul>
                </div>
                
                <div class="dialog-actions">
                    <button class="btn btn-primary" id="retryBtn">
                        ğŸ”„ é‡æ–°æµ‹é‡
                    </button>
                    <button class="btn btn-warning" id="acceptBtn">
                        âš ï¸ æ¥å—å¹¶ç»§ç»­
                    </button>
                    <button class="btn btn-secondary" id="skipBtn">
                        â­ï¸ è·³è¿‡æ­¤ç‚¹
                    </button>
                </div>
            </div>
        `;
        
        showDialog(html);
        
        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('retryBtn').addEventListener('click', () => {
            closeDialog();
            resolve('retry');
        });
        
        document.getElementById('acceptBtn').addEventListener('click', () => {
            closeDialog();
            resolve('accept');
        });
        
        document.getElementById('skipBtn').addEventListener('click', () => {
            closeDialog();
            resolve('skip');
        });
    });
}
```

**æ¨¡å¼å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | ä¸¥æ ¼æ¨¡å¼ ğŸ” | å¿«é€Ÿæ¨¡å¼ âš¡ |
|------|------------|------------|
| è´¨é‡è¯„ä¼° | âœ“ å®Œæ•´è¯„ä¼° | âœ“ å®Œæ•´è¯„ä¼° |
| è´¨é‡ä¸åˆæ ¼æ—¶ | å¼¹å‡ºè­¦å‘Šå¯¹è¯æ¡† | ä»…æ˜¾ç¤ºç®€çŸ­æç¤º |
| ç”¨æˆ·äº¤äº’ | éœ€è¦é€‰æ‹©æ“ä½œ | è‡ªåŠ¨ç»§ç»­ |
| é‡‡é›†é€Ÿåº¦ | è¾ƒæ…¢ï¼ˆéœ€ç¡®è®¤ï¼‰ | å¿«é€Ÿï¼ˆæ— ä¸­æ–­ï¼‰ |
| é€‚ç”¨åœºæ™¯ | æ­£å¼å®éªŒã€é«˜ç²¾åº¦æµ‹é‡ | å¿«é€Ÿé¢„æµ‹ã€ç²—ç•¥æ‰«æ |
| æ•°æ®ä¿å­˜ | è´¨é‡ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ | è´¨é‡ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ |

**æ³¨æ„**ï¼š
- æ— è®ºå“ªç§æ¨¡å¼ï¼Œè´¨é‡ä¿¡æ¯éƒ½ä¼šä¿å­˜åˆ°æ•°æ®åº“
- å¿«é€Ÿæ¨¡å¼ä¸‹ï¼Œç”¨æˆ·ä»å¯åœ¨è¡¨æ ¼ä¸­æŸ¥çœ‹æ¯ä¸ªç‚¹çš„è´¨é‡è¯„åˆ†
- å¯ä»¥åœ¨é‡‡é›†è¿‡ç¨‹ä¸­éšæ—¶åˆ‡æ¢æ¨¡å¼

#### é‡‡é›†æ•°æ®éªŒè¯

```python
class DataValidator:
    """æ•°æ®éªŒè¯å™¨"""
    
    def __init__(self):
        self.validation_rules = {
            'stress_range': (-500, 500),      # MPa
            'time_diff_range': (-1000, 1000), # ns
            'quality_score_min': 0.6,         # æœ€ä½å¯æ¥å—è´¨é‡è¯„åˆ†
            'snr_min': 15.0                   # æœ€ä½å¯æ¥å—ä¿¡å™ªæ¯” (dB)
        }
    
    def validate_point_data(self, point_data, neighbors=None):
        """éªŒè¯æµ‹ç‚¹æ•°æ®
        
        å‚æ•°:
            point_data: æµ‹ç‚¹æ•°æ®
            neighbors: ç›¸é‚»æµ‹ç‚¹æ•°æ®ï¼ˆç”¨äºæ£€æŸ¥è¿ç»­æ€§ï¼‰
        
        è¿”å›:
            {
                "is_valid": bool,
                "warnings": list,
                "errors": list,
                "quality": str  # 'excellent' | 'good' | 'fair' | 'poor'
            }
        """
        warnings = []
        errors = []
        
        # 1. æ£€æŸ¥åº”åŠ›å€¼èŒƒå›´
        stress = point_data['stress']
        if not self._check_range(stress, self.validation_rules['stress_range']):
            errors.append(f"åº”åŠ›å€¼è¶…å‡ºåˆç†èŒƒå›´: {stress:.2f} MPa")
        
        # 2. æ£€æŸ¥æ—¶é—´å·®èŒƒå›´
        time_diff = point_data['time_diff']
        if not self._check_range(time_diff, self.validation_rules['time_diff_range']):
            errors.append(f"æ—¶é—´å·®è¶…å‡ºåˆç†èŒƒå›´: {time_diff:.2f} ns")
        
        # 3. æ£€æŸ¥æ³¢å½¢è´¨é‡
        quality_score = point_data.get('quality_score', 0)
        if quality_score < self.validation_rules['quality_score_min']:
            warnings.append(f"æ³¢å½¢è´¨é‡è¾ƒå·®: {quality_score:.2f}")
        
        # 4. æ£€æŸ¥ä¿¡å™ªæ¯”
        snr = point_data.get('snr', 0)
        if snr < self.validation_rules['snr_min']:
            warnings.append(f"ä¿¡å™ªæ¯”è¿‡ä½: {snr:.1f} dB")
        
        # 5. æ£€æŸ¥ä¸ç›¸é‚»æµ‹ç‚¹çš„è¿ç»­æ€§
        if neighbors:
            continuity_check = self._check_continuity(point_data, neighbors)
            if not continuity_check['is_continuous']:
                warnings.append(continuity_check['message'])
        
        # 6. è¯„ä¼°æ•´ä½“è´¨é‡
        quality = self._assess_quality(point_data, warnings, errors)
        
        return {
            "is_valid": len(errors) == 0,
            "warnings": warnings,
            "errors": errors,
            "quality": quality
        }
    
    def _check_range(self, value, range_tuple):
        """æ£€æŸ¥å€¼æ˜¯å¦åœ¨èŒƒå›´å†…"""
        min_val, max_val = range_tuple
        return min_val <= value <= max_val
    
    def _check_continuity(self, point, neighbors, threshold=50):
        """æ£€æŸ¥ä¸ç›¸é‚»æµ‹ç‚¹çš„è¿ç»­æ€§
        
        å¦‚æœåº”åŠ›å€¼ä¸ç›¸é‚»æµ‹ç‚¹å·®å¼‚è¿‡å¤§ï¼Œå¯èƒ½æ˜¯å¼‚å¸¸å€¼
        """
        if not neighbors:
            return {"is_continuous": True}
        
        neighbor_stresses = [n['stress'] for n in neighbors]
        avg_neighbor_stress = np.mean(neighbor_stresses)
        
        diff = abs(point['stress'] - avg_neighbor_stress)
        
        if diff > threshold:
            return {
                "is_continuous": False,
                "message": f"åº”åŠ›å€¼ä¸ç›¸é‚»æµ‹ç‚¹å·®å¼‚è¿‡å¤§: {diff:.2f} MPa"
            }
        
        return {"is_continuous": True}
    
    def _assess_quality(self, point_data, warnings, errors):
        """è¯„ä¼°æ•°æ®è´¨é‡"""
        if errors:
            return 'poor'
        
        quality_score = point_data.get('quality_score', 0)
        snr = point_data.get('snr', 0)
        
        if quality_score >= 0.9 and snr >= 25 and not warnings:
            return 'excellent'
        elif quality_score >= 0.7 and snr >= 15:
            return 'good'
        elif quality_score >= 0.5 and snr >= 10:
            return 'fair'
        else:
            return 'poor'
    
    def validate_experiment_config(self, config):
        """éªŒè¯å®éªŒé…ç½®
        
        æ£€æŸ¥:
        - å½¢çŠ¶é…ç½®æ˜¯å¦æœ‰æ•ˆ
        - æµ‹ç‚¹æ•°æ˜¯å¦åˆç†
        - æ ‡å®šæ•°æ®æ˜¯å¦å¯é 
        """
        errors = []
        warnings = []
        
        # 1. æ£€æŸ¥å½¢çŠ¶é…ç½®
        shape = config.get('shape_config')
        if not shape:
            errors.append("ç¼ºå°‘å½¢çŠ¶é…ç½®")
        else:
            area = self._calculate_area(shape)
            if area < 100:
                errors.append(f"è¯•ä»¶é¢ç§¯è¿‡å°: {area:.2f} mmÂ²")
            elif area > 100000:
                warnings.append(f"è¯•ä»¶é¢ç§¯è¾ƒå¤§: {area:.2f} mmÂ²ï¼Œå»ºè®®å¢åŠ æµ‹ç‚¹æ•°")
        
        # 2. æ£€æŸ¥æµ‹ç‚¹æ•°
        points = config.get('point_layout', [])
        n_points = len(points)
        
        if n_points < 3:
            errors.append(f"æµ‹ç‚¹æ•°ä¸è¶³: {n_points} < 3")
        elif n_points < 9:
            warnings.append(f"æµ‹ç‚¹æ•°è¾ƒå°‘: {n_points}ï¼Œäº‘å›¾ç²¾åº¦æœ‰é™")
        elif n_points > 100:
            warnings.append(f"æµ‹ç‚¹æ•°è¾ƒå¤š: {n_points}ï¼Œé‡‡é›†æ—¶é—´è¾ƒé•¿")
        
        # 3. æ£€æŸ¥æ ‡å®šæ•°æ®
        calibration = config.get('calibration')
        if not calibration:
            errors.append("ç¼ºå°‘æ ‡å®šæ•°æ®")
        else:
            if calibration.get('r_squared', 0) < 0.95:
                warnings.append(f"æ ‡å®šæ•°æ®æ‹Ÿåˆä¼˜åº¦è¾ƒä½: RÂ² = {calibration['r_squared']:.4f}")
        
        return {
            "is_valid": len(errors) == 0,
            "warnings": warnings,
            "errors": errors
        }
    
    def _calculate_area(self, shape_config):
        """è®¡ç®—å½¢çŠ¶é¢ç§¯"""
        if shape_config['type'] == 'rectangle':
            return shape_config['width'] * shape_config['height']
        elif shape_config['type'] == 'circle':
            r = shape_config['outer_radius']
            return np.pi * r * r
        else:
            # ä½¿ç”¨shapelyè®¡ç®—å¤šè¾¹å½¢é¢ç§¯
            from shapely.geometry import Polygon
            vertices = shape_config['vertices']
            poly = Polygon(vertices)
            return poly.area

# ä½¿ç”¨ç¤ºä¾‹
validator = DataValidator()

# éªŒè¯æµ‹ç‚¹æ•°æ®
def capture_point_with_validation(exp_id, point_id):
    """é‡‡é›†æµ‹ç‚¹å¹¶éªŒè¯æ•°æ®"""
    # é‡‡é›†æ•°æ®
    result = capture_point(exp_id, point_id)
    
    if result['success']:
        point_data = result['data']
        
        # è·å–ç›¸é‚»æµ‹ç‚¹
        neighbors = get_neighbor_points(exp_id, point_id)
        
        # éªŒè¯æ•°æ®
        validation = validator.validate_point_data(point_data, neighbors)
        
        # æ˜¾ç¤ºéªŒè¯ç»“æœ
        if not validation['is_valid']:
            logger.error(f"æµ‹ç‚¹ #{point_id} æ•°æ®éªŒè¯å¤±è´¥: {validation['errors']}")
            return {
                "success": False,
                "message": "æ•°æ®éªŒè¯å¤±è´¥",
                "validation": validation
            }
        
        if validation['warnings']:
            logger.warning(f"æµ‹ç‚¹ #{point_id} æ•°æ®è´¨é‡è­¦å‘Š: {validation['warnings']}")
        
        # æ ‡è®°æ•°æ®è´¨é‡
        point_data['quality'] = validation['quality']
        point_data['is_suspicious'] = validation['quality'] == 'poor'
        
        return {
            "success": True,
            "data": point_data,
            "validation": validation
        }
```

#### å‰ç«¯éªŒè¯åé¦ˆ

```javascript
async function captureCurrentPoint() {
    const result = await pywebview.api.capture_field_point(exp_id, point_id);
    
    if (result.success) {
        const validation = result.validation;
        
        // æ˜¾ç¤ºéªŒè¯ç»“æœ
        if (validation.quality === 'excellent') {
            showToast(`âœ“ æµ‹ç‚¹ #${point_id} é‡‡é›†æˆåŠŸ - è´¨é‡ä¼˜ç§€`, 'success');
        } else if (validation.quality === 'good') {
            showToast(`âœ“ æµ‹ç‚¹ #${point_id} é‡‡é›†æˆåŠŸ - è´¨é‡è‰¯å¥½`, 'success');
        } else if (validation.quality === 'fair') {
            showToast(`âš ï¸ æµ‹ç‚¹ #${point_id} é‡‡é›†æˆåŠŸ - è´¨é‡ä¸€èˆ¬ï¼Œå»ºè®®é‡æµ‹`, 'warning');
        } else {
            showToast(`âŒ æµ‹ç‚¹ #${point_id} è´¨é‡è¾ƒå·®ï¼Œå¼ºçƒˆå»ºè®®é‡æµ‹`, 'error');
        }
        
        // æ˜¾ç¤ºè­¦å‘Š
        if (validation.warnings.length > 0) {
            validation.warnings.forEach(warning => {
                showToast(`âš ï¸ ${warning}`, 'warning', 5000);
            });
        }
        
        // åœ¨è¡¨æ ¼ä¸­æ ‡è®°è´¨é‡
        updateTableRowQuality(point_id, validation.quality);
    }
}

function updateTableRowQuality(pointId, quality) {
    const row = document.querySelector(`tr[data-point-id="${pointId}"]`);
    
    // ç§»é™¤æ—§çš„è´¨é‡ç±»
    row.classList.remove('quality-excellent', 'quality-good', 'quality-fair', 'quality-poor');
    
    // æ·»åŠ æ–°çš„è´¨é‡ç±»
    row.classList.add(`quality-${quality}`);
    
    // æ·»åŠ è´¨é‡å›¾æ ‡
    const qualityIcons = {
        'excellent': 'â­â­â­',
        'good': 'â­â­',
        'fair': 'â­',
        'poor': 'âš ï¸'
    };
    
    row.querySelector('.quality-indicator').textContent = qualityIcons[quality];
}
```

**CSSæ ·å¼**ï¼š
```css
/* æ•°æ®è´¨é‡æ ‡è¯† */
.quality-excellent {
    background: #E8F5E9 !important;
}

.quality-good {
    background: #F1F8E9 !important;
}

.quality-fair {
    background: #FFF9C4 !important;
}

.quality-poor {
    background: #FFEBEE !important;
}
```

---

**ğŸ“„ æ–‡æ¡£è¯´æ˜**ï¼šæœ¬æ–‡æ¡£ä¸ºç¬¬4éƒ¨åˆ†ï¼ˆæœ€åä¸€éƒ¨åˆ†ï¼‰ï¼ŒåŒ…å«ç¬¬9-10ç« å†…å®¹ã€‚  
**â¬…ï¸ ä¸Šä¸€éƒ¨åˆ†**ï¼š[å•è½´åº”åŠ›æ£€æµ‹æ¨¡å—è®¾è®¡æ–‡æ¡£-ç¬¬3éƒ¨åˆ†.md](./å•è½´åº”åŠ›æ£€æµ‹æ¨¡å—è®¾è®¡æ–‡æ¡£-ç¬¬3éƒ¨åˆ†.md)  
**ğŸ  è¿”å›é¦–é¡µ**ï¼š[å•è½´åº”åŠ›æ£€æµ‹æ¨¡å—è®¾è®¡æ–‡æ¡£.md](./å•è½´åº”åŠ›æ£€æµ‹æ¨¡å—è®¾è®¡æ–‡æ¡£.md)

---

**æ–‡æ¡£å®Œæˆï¼** ğŸ‰
