# 单轴应力检测模块设计文档 v1.0 - 第1.5-A部分

> **包含章节**：第3章 界面设计 (3.1-3.3 左侧控制栏)  
> **上一部分**：[第1部分](./单轴应力检测模块设计文档.md)  
> **下一部分**：[第1.5-B部分](./单轴应力检测模块设计文档-第1.5-B部分.md)

---

## 3. 界面设计

### 3.1 标签页结构

```
单轴应力检测模块
├── [单点检测] 标签（现有功能）
│   ├── 加载标定数据
│   ├── 采集基准波形
│   ├── 开始/停止波形监控
│   ├── 开始/停止应力检测
│   ├── 波形显示 Canvas
│   ├── 应力值显示
│   └── 记录和导出
│
└── [应力场测绘] 标签（新增功能）
    ├── 左侧控制栏 (30%)
    │   ├── 1. 标定数据选择
    │   ├── 2. 试件形状定义
    │   ├── 3. 布点设置
    │   ├── 4. 基准设置
    │   ├── 5. 采集控制
    │   └── 6. 云图设置
    │
    └── 右侧显示区 (70%)
        ├── 上半区域 (50%高度，可拖拽调节)
        │   ├── 数据表格 (左，50%宽度)
        │   │   └── 动态表头（根据形状和布点方式切换）
        │   └── 当前波形 (右，50%宽度)
        │       └── 采集阶段显示实时波形
        │
        └── 下半区域 (50%高度，可拖拽调节)
            ├── 预览画布 (左，50%宽度，可折叠)
            │   └── 显示试件形状 + 测点布局（静态）
            └── 应力云图 (右，50%宽度，可折叠)
                └── 显示试件形状 + 测点布局 + 应力云图（实时刷新）
```

---

### 3.2 实验管理区设计

#### 单实验模式说明

**设计原则**：同一时刻只能有一个活动实验，避免大量波形数据同时加载导致内存压力。

**数据保存策略**：
```
保存时机                    保存内容                    存储位置
─────────────────────────────────────────────────────────────
新建实验                  实验元数据                  SQLite
配置形状/布点             实验配置                    SQLite (自动保存)
采集测点 #1               波形数据 + 应力值           HDF5 + SQLite (立即保存)
采集测点 #2               波形数据 + 应力值           HDF5 + SQLite (立即保存)
...                       ...                         ...
点击"完成实验"            标记状态为"已完成"          SQLite
```

**自动保存机制**：
- ✅ 每采集一个测点，立即保存到数据库和HDF5文件
- ✅ 修改形状、布点配置后自动保存
- ✅ 防止意外关闭导致数据丢失
- ✅ 可随时中断，重新加载实验继续采集

**实验切换流程**：
```
当前实验进行中
    ↓
用户点击 [新建实验] 或 [加载实验]
    ↓
系统检测到当前实验未完成
    ↓
弹出确认对话框
    ↓
[确认切换]: 清空前台 → 加载新实验（数据已自动保存）
[取消]: 留在当前实验
```

**前台数据清空与加载机制**：

**场景1：新建实验**
```javascript
async function createNewExperiment(name, description) {
    // 1. 后端创建实验
    const response = await pywebview.api.create_field_experiment(name, description);
    
    if (response.success) {
        // 2. ✅ 清空前台所有数据
        clearAllFrontendData();
        
        // 3. ✅ 加载新实验
        loadExperiment(response.data.exp_id);
        
        showToast('✓ 实验创建成功', 'success');
    }
}

function clearAllFrontendData() {
    // 清空标定数据
    currentCalibration = null;
    document.querySelector('.calib-info').innerHTML = '未加载';
    
    // 清空形状配置
    currentShape = null;
    FieldCanvas.clear();
    
    // 清空测点列表
    currentPoints = [];
    
    // 清空表格
    document.querySelector('#point-table tbody').innerHTML = '';
    
    // 清空预览画布
    FieldCanvas.clearPreview();
    
    // 清空云图
    FieldContour.clear();
    
    // 清空波形显示
    WaveformCanvas.clear();
    
    // 重置所有面板状态
    resetAllPanels();
}
```

**场景2：加载已有实验**
```javascript
async function loadExperiment(expId) {
    // 1. 后端读取实验数据
    const response = await pywebview.api.load_field_experiment(expId);
    
    if (response.success) {
        const exp = response.data;
        
        // 2. ✅ 清空前台所有数据
        clearAllFrontendData();
        
        // 3. ✅ 展示加载的数据
        
        // 3.1 实验信息
        document.querySelector('.exp-name').textContent = exp.name;
        document.querySelector('.exp-status').textContent = exp.status;
        document.querySelector('.exp-progress').textContent = 
            `${exp.completed}/${exp.total}`;
        
        // 3.2 标定数据（如果已配置）
        if (exp.calibration) {
            currentCalibration = exp.calibration;
            displayCalibrationInfo(exp.calibration);
        }
        
        // 3.3 形状配置（如果已配置）
        if (exp.shape_config) {
            currentShape = exp.shape_config;
            FieldCanvas.drawShape(exp.shape_config);
        }
        
        // 3.4 测点布局（如果已生成）
        if (exp.points && exp.points.length > 0) {
            currentPoints = exp.points;
            FieldCanvas.drawPoints(exp.points);
        }
        
        // 3.5 已采集的测点数据（表格）
        if (exp.measured_points && exp.measured_points.length > 0) {
            renderPointTable(exp.measured_points);
        }
        
        // 3.6 云图（如果有足够数据）
        if (exp.measured_points && exp.measured_points.length >= 3) {
            await updateContour();
        }
        
        // 3.7 根据实验状态决定可用操作
        updateUIByStatus(exp.status);
        
        showToast('✓ 实验加载成功', 'success');
    }
}

function updateUIByStatus(status) {
    const isCompleted = (status === 'completed');
    
    // 已完成的实验：只读模式
    if (isCompleted) {
        // 禁用所有配置面板
        document.querySelectorAll('.config-panel input, .config-panel button')
            .forEach(el => el.disabled = true);
        
        // 只允许查看和导出
        document.querySelector('#btn-export').disabled = false;
        
        showToast('ℹ️ 实验已完成，处于只读模式', 'info');
    } else {
        // 进行中的实验：可继续采集
        enableCaptureControls();
    }
}
```

**场景3：切换实验时的保护机制**
```javascript
async function handleExperimentSwitch(action) {
    // action: 'create' | 'load'
    
    // 检查当前是否有未完成的实验
    if (currentExperiment && currentExperiment.status !== 'completed') {
        const confirmed = await showConfirmDialog({
            title: '⚠️ 切换实验',
            message: `
                当前实验: ${currentExperiment.name}
                状态: ${currentExperiment.status} (${currentExperiment.completed}/${currentExperiment.total} 已完成)
                
                💾 所有数据已自动保存
                
                确认要切换到新实验吗？
                （可随时通过"实验管理"重新加载）
            `,
            confirmText: '确认切换',
            cancelText: '取消'
        });
        
        if (!confirmed) {
            return false;  // 用户取消
        }
    }
    
    // 用户确认切换
    if (action === 'create') {
        showCreateExperimentDialog();
    } else if (action === 'load') {
        showExperimentManagerDialog();
    }
    
    return true;
}

// 新建实验按钮
document.querySelector('#btn-new-experiment').addEventListener('click', () => {
    handleExperimentSwitch('create');
});

// 实验管理按钮
document.querySelector('#btn-manage-experiments').addEventListener('click', () => {
    handleExperimentSwitch('load');
});
```

#### 实验管理区界面

位于左侧控制栏顶部，固定显示（不可折叠）：

```
╔═══════════════════════════════════════════════════════════════╗
║ 📊 实验管理                                                    ║
╠═══════════════════════════════════════════════════════════════╣
║                                                                ║
║  当前实验: FIELD001 - 铝板应力分布测试                         ║
║  状态: 🟢 采集中 (15/25 已完成)                                ║
║  💾 自动保存: 最后保存于 14:35:22                              ║
║                                                                ║
║  ┌──────────┐ ┌──────────┐ ┌──────────┐                       ║
║  │ 新建实验 │ │实验管理  │ │ 完成实验 │                       ║
║  └──────────┘ └──────────┘ └──────────┘                       ║
║                                                                ║
╚═══════════════════════════════════════════════════════════════╝
```

**状态显示**：
- ⚪ 未开始 (0/25)
- 🟡 进行中 (15/25) - 部分采集完成
- 🟢 采集中 (15/25) - 正在采集某个测点
- ✓ 已完成 (25/25) - 实验完成并锁定

**按钮功能说明**：
- **新建实验**：创建新的应力场实验
- **实验管理**：打开实验管理对话框，可加载、导出、删除历史实验
- **完成实验**：标记实验为"已完成"状态，锁定数据，生成最终云图

#### 新建实验对话框

点击"新建实验"按钮后弹出：

```
┌─────────────────────────────────────────────────────────────┐
│  ✨ 新建应力场实验                                           │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  实验名称: [_________________________________]               │
│            💡 例如: 铝板应力分布测试                         │
│                                                               │
│  备注 (可选):                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
│  💡 创建后可在主界面配置标定数据、试件形状和测点布局         │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │   创建实验   │  │     取消     │                        │
│  └──────────────┘  └──────────────┘                        │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

#### 实验管理对话框

点击"实验管理"按钮后弹出：

```
┌─────────────────────────────────────────────────────────────┐
│  📊 实验管理                                                 │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  实验列表:                                                   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ FIELD001 - 铝板应力分布测试 (25/25) ✓ 已完成         │  │
│  │ 创建时间: 2025-12-19 10:30                            │  │
│  │ [加载] [导出] [删除]                                  │  │
│  ├───────────────────────────────────────────────────────┤  │
│  │ FIELD002 - 复材板0°方向 (15/25) 🟡 进行中            │  │
│  │ 创建时间: 2025-12-19 14:20                            │  │
│  │ [加载] [导出] [删除]                                  │  │
│  ├───────────────────────────────────────────────────────┤  │
│  │ FIELD003 - 复材板45°方向 (0/25) ⚪ 未开始            │  │
│  │ 创建时间: 2025-12-19 15:00                            │  │
│  │ [加载] [导出] [删除]                                  │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                               │
│  💡 提示:                                                    │
│    • 加载: 将实验加载到主界面，可继续采集或查看数据         │
│    • 导出: 导出实验数据（CSV/Excel、云图图片、报告）        │
│    • 删除: 永久删除实验数据（不可恢复）                     │
│                                                               │
│  ┌──────────────┐                                           │
│  │     关闭     │                                           │
│  └──────────────┘                                           │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**实验管理对话框 - 导出操作**：

点击某个实验的"导出"按钮后弹出：

```
┌─────────────────────────────────────┐
│  📤 导出实验数据                     │
├─────────────────────────────────────┤
│                                      │
│ 实验: FIELD001 - 铝板应力分布测试    │
│                                      │
│ 导出内容:                            │
│   ☑ 测点数据 (CSV/Excel)             │
│   ☑ 云图图片 (PNG)                   │
│   ☐ 原始波形 (HDF5)                  │
│   ☐ 实验报告 (PDF)                   │
│                                      │
│ 保存位置: [选择文件夹...]            │
│                                      │
│ [开始导出] [取消]                    │
└─────────────────────────────────────┘
```

**实验管理对话框 - 删除操作**：

点击某个实验的"删除"按钮后弹出确认：

```
┌─────────────────────────────────────┐
│  ⚠️  删除实验？                      │
├─────────────────────────────────────┤
│                                      │
│ 确定要删除实验吗？                   │
│                                      │
│ 实验: FIELD001 - 铝板应力分布测试    │
│ 状态: 已完成 (25/25)                 │
│                                      │
│ ⚠️ 此操作不可恢复！                 │
│                                      │
│ [确认删除] [取消]                    │
└─────────────────────────────────────┘
```

#### 切换实验确认对话框

当从实验管理对话框点击"加载"时，如果当前有未完成实验，弹出：

```
┌─────────────────────────────────────────────────────┐
│  ⚠️  切换实验？                                      │
├─────────────────────────────────────────────────────┤
│                                                       │
│  当前实验 "FIELD001 - 铝板应力分布测试" 尚未完成     │
│  (15/25 测点已采集)。                                │
│                                                       │
│  💾 已采集的数据已自动保存，可稍后继续。             │
│                                                       │
│  是否切换到新实验？                                  │
│                                                       │
│  ┌──────────────┐  ┌──────────────┐                │
│  │   继续切换   │  │     取消     │                │
│  └──────────────┘  └──────────────┘                │
│                                                       │
└─────────────────────────────────────────────────────┘
```

---

### 3.3 左侧控制栏详细设计

#### 控制栏结构（30%宽度，6个折叠面板）

**1️⃣ 标定数据选择**（必填）

**设计原则**：采用单选按钮 + 动态内容区，选择哪种数据来源就只显示对应的配置项，节省空间且直观。

**界面布局**：
```
▼ 标定数据选择
  
  数据来源:
    ● 从本地实验加载  ○ 从文件导入
    ○ 手动输入系数    ○ 从材料库选择
  
  ┌───────────────────────────────────────────────────────┐
  │ 【动态内容区 - 根据选择显示对应配置】                  │
  └───────────────────────────────────────────────────────┘
  
  ✓ 已加载信息: ...
```

**选项1：从本地实验加载**（默认，推荐）

**实现原理**：
- 通过 `ExperimentDataManager` 访问 `experiments.db` 数据库
- 查询 `fitting_results` 表获取标定实验的拟合结果
- 应力系数 k = 1/斜率（斜率单位：ns/MPa，k单位：MPa/ns）

**数据流程**：
```
前端选择实验和方向
    ↓
pywebview.api.load_calibration_from_experiment(exp_id, direction)
    ↓
后端查询数据库:
    SELECT 斜率, 截距, R方
    FROM fitting_results fr
    JOIN test_directions td ON fr.方向ID = td.id
    WHERE td.实验ID = ? AND td.方向名称 = ?
    ↓
计算应力系数: k = 1/斜率
    ↓
返回标定数据给前端
```

**界面布局**：
```
▼ 标定数据选择
  
  数据来源:
    ● 从本地实验加载  ○ 从文件导入
    ○ 手动输入系数    ○ 从材料库选择
  
  ┌───────────────────────────────────────────────────────┐
  │ 【从本地实验加载】                                     │
  │                                                         │
  │ 标定实验: [EXP003 - 铝板标定 ▼]                         │
  │              ↑ 自动加载所有已完成标定的实验             │
  │                                                         │
  │ 测试方向: [0° ▼]                                        │
  │            ↑ 根据选择的实验，显示其包含的方向           │
  │                                                         │
  │ ┌──────────────┐                                       │
  │ │ 加载标定数据 │                                       │
  │ └──────────────┘                                       │
  └───────────────────────────────────────────────────────┘
  
  ✓ 已加载信息:
    实验ID: EXP003
    测试方向: 0°
    应力系数 k: 3.67 MPa/ns
    拟合优度 R²: 0.9987
    来源: 本地实验
```

**前端实现**：
```javascript
// 加载可用的标定实验列表
async function loadCalibrationExperimentList() {
    const response = await pywebview.api.get_calibration_experiment_list();
    
    if (response.success) {
        const select = document.querySelector('#calib-exp-select');
        select.innerHTML = '';
        
        response.data.forEach(exp => {
            const option = document.createElement('option');
            option.value = exp.exp_id;
            option.textContent = `EXP${String(exp.exp_id).padStart(3, '0')} - ${exp.name}`;
            select.appendChild(option);
        });
    }
}

// 加载选中实验的测试方向
async function loadExperimentDirections(expId) {
    const response = await pywebview.api.get_experiment_directions(expId);
    
    if (response.success) {
        const select = document.querySelector('#calib-direction-select');
        select.innerHTML = '';
        
        response.data.forEach(dir => {
            const option = document.createElement('option');
            option.value = dir;
            option.textContent = dir;
            select.appendChild(option);
        });
    }
}

// 加载标定数据
async function loadFromLocal() {
    const expId = document.querySelector('#calib-exp-select').value;
    const direction = document.querySelector('#calib-direction-select').value;
    
    const response = await pywebview.api.load_calibration_from_experiment(
        expId, direction
    );
    
    if (response.success) {
        const data = response.data;
        
        // 显示标定信息
        document.querySelector('.calib-info').innerHTML = `
            ✓ 已加载信息:<br>
            实验ID: EXP${String(expId).padStart(3, '0')}<br>
            测试方向: ${direction}<br>
            应力系数 k: ${data.k.toFixed(3)} MPa/ns<br>
            拟合优度 R²: ${data.r_squared.toFixed(4)}<br>
            来源: 本地实验
        `;
        
        // 保存到当前实验配置
        currentCalibration = data;
        
        showToast('✓ 标定数据加载成功', 'success');
    } else {
        showToast(`❌ 加载失败: ${response.message}`, 'error');
    }
}
```

**后端实现**（在 field_experiment.py 中）：
```python
def load_calibration_from_experiment(self, calib_exp_id, direction):
    """从本地标定实验加载标定系数"""
    try:
        cursor = self.dm.conn.cursor()
        
        # 1. 获取方向ID
        cursor.execute('''
            SELECT id FROM test_directions 
            WHERE 实验ID=? AND 方向名称=?
        ''', (calib_exp_id, direction))
        
        result = cursor.fetchone()
        if not result:
            return {"success": False, "message": "未找到该方向的标定数据"}
        
        方向ID = result[0]
        
        # 2. 获取拟合结果（应力系数）
        cursor.execute('''
            SELECT 斜率, 截距, R方
            FROM fitting_results
            WHERE 方向ID = ?
            ORDER BY id DESC
            LIMIT 1
        ''', (方向ID,))
        
        result = cursor.fetchone()
        
        if not result:
            return {"success": False, "message": "该方向尚未完成拟合"}
        
        斜率, 截距, R方 = result
        
        # 3. 计算应力系数 k = 1/斜率
        # 斜率单位: s/MPa，k单位: MPa/s
        if abs(斜率) < 1e-12:
            return {"success": False, "message": "斜率为零，无法计算应力系数"}
        
        k = 1.0 / 斜率
        
        # 4. 转换单位: s -> ns
        k_ns = k * 1e9  # MPa/ns
        
        return {
            "success": True,
            "data": {
                "k": k_ns,              # MPa/ns
                "slope": 斜率 * 1e9,    # ns/MPa
                "intercept": 截距 * 1e9, # ns
                "r_squared": R方,
                "source": "local",
                "exp_id": calib_exp_id,
                "direction": direction
            }
        }
    except Exception as e:
        return {"success": False, "message": f"加载失败: {str(e)}"}

def get_calibration_experiment_list(self):
    """获取可用的标定实验列表"""
    try:
        cursor = self.dm.conn.cursor()
        
        # 查询所有有拟合结果的实验
        cursor.execute('''
            SELECT DISTINCT e.id, e.材料名称, e.创建时间
            FROM experiments e
            JOIN test_directions td ON e.id = td.实验ID
            JOIN fitting_results fr ON td.id = fr.方向ID
            ORDER BY e.id DESC
        ''')
        
        experiments = []
        for row in cursor.fetchall():
            exp_id, name, created_at = row
            
            # 获取该实验的所有方向
            cursor.execute('''
                SELECT DISTINCT td.方向名称
                FROM test_directions td
                JOIN fitting_results fr ON td.id = fr.方向ID
                WHERE td.实验ID = ?
                ORDER BY td.方向名称
            ''', (exp_id,))
            
            directions = [r[0] for r in cursor.fetchall()]
            
            experiments.append({
                "exp_id": exp_id,
                "name": name,
                "directions": directions,
                "created_at": created_at
            })
        
        return {"success": True, "data": experiments}
    except Exception as e:
        return {"success": False, "message": f"查询失败: {str(e)}"}

def get_experiment_directions(self, exp_id):
    """获取实验的所有测试方向"""
    try:
        cursor = self.dm.conn.cursor()
        
        cursor.execute('''
            SELECT DISTINCT td.方向名称
            FROM test_directions td
            JOIN fitting_results fr ON td.id = fr.方向ID
            WHERE td.实验ID = ?
            ORDER BY td.方向名称
        ''', (exp_id,))
        
        directions = [row[0] for row in cursor.fetchall()]
        
        return {"success": True, "data": directions}
    except Exception as e:
        return {"success": False, "message": f"查询失败: {str(e)}"}
```

**选项2：从文件导入**
```
▼ 标定数据选择
  
  数据来源:
    ○ 从本地实验加载  ● 从文件导入
    ○ 手动输入系数    ○ 从材料库选择
  
  ┌───────────────────────────────────────────────────────┐
  │ 【从文件导入】                                         │
  │                                                         │
  │ 支持格式: .json, .csv                                   │
  │                                                         │
  │ ┌──────────────┐                                       │
  │ │ 选择文件...  │                                       │
  │ └──────────────┘                                       │
  │                                                         │
  │ 已选择: calibration_data.json                           │
  └───────────────────────────────────────────────────────┘
  
  ✓ 已加载信息:
    应力系数 k: 3.67 MPa/ns
    来源: 文件导入 - calibration_data.json
```

**选项3：手动输入系数**
```
▼ 标定数据选择
  
  数据来源:
    ○ 从本地实验加载  ○ 从文件导入
    ● 手动输入系数    ○ 从材料库选择
  
  ┌───────────────────────────────────────────────────────┐
  │ 【手动输入系数】                                       │
  │                                                         │
  │ 应力系数 k (MPa/ns): [3.67]                             │
  │                                                         │
  │ 💡 正值: 拉应力增加声时                                 │
  │ 💡 负值: 拉应力减少声时                                 │
  │                                                         │
  │ ┌──────────────┐                                       │
  │ │   确认输入   │                                       │
  │ └──────────────┘                                       │
  └───────────────────────────────────────────────────────┘
  
  ✓ 已加载信息:
    应力系数 k: 3.67 MPa/ns
    来源: 手动输入
```

**选项4：从材料库选择**
```
▼ 标定数据选择
  
  数据来源:
    ○ 从本地实验加载  ○ 从文件导入
    ○ 手动输入系数    ● 从材料库选择
  
  ┌───────────────────────────────────────────────────────┐
  │ 【从材料库选择】                                       │
  │                                                         │
  │ 材料类型: [6061铝合金 ▼]                                │
  │   • 6061铝合金 (k=3.67)                                 │
  │   • 7075铝合金 (k=3.82)                                 │
  │   • 304不锈钢 (k=2.45)                                  │
  │   • 碳纤维复材 (k=4.23)                                 │
  │                                                         │
  │ ⚠️ 仅供快速测试，正式实验建议使用实际标定数据           │
  │                                                         │
  │ ┌──────────────┐                                       │
  │ │ 加载材料数据 │                                       │
  │ └──────────────┘                                       │
  └───────────────────────────────────────────────────────┘
  
  ✓ 已加载信息:
    应力系数 k: 3.67 MPa/ns
    来源: 材料库 - 6061铝合金
```

**交互逻辑**：
```javascript
/**
 * 根据选择的数据来源，动态显示对应内容区
 */
function updateCalibrationSource(source) {
    // 隐藏所有内容区
    document.querySelectorAll('.calibration-content').forEach(el => {
        el.style.display = 'none';
    });
    
    // 显示选中的内容区
    const contentMap = {
        'local': '.calibration-local',
        'file': '.calibration-file',
        'manual': '.calibration-manual',
        'library': '.calibration-library'
    };
    
    document.querySelector(contentMap[source]).style.display = 'block';
}

// 单选按钮切换事件
document.querySelectorAll('input[name="calibration-source"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        updateCalibrationSource(e.target.value);
    });
});
```

**标定数据文件格式**：
```json
// calibration_data.json
{
  "material": "6061铝合金",
  "direction": "0°",
  "stress_coefficient": 3.67,
  "unit": "MPa/ns",
  "date": "2025-12-19",
  "notes": "标准试样标定"
}
```

```csv
# calibration_data.csv
material,direction,stress_coefficient,unit,date,notes
6061铝合金,0°,3.67,MPa/ns,2025-12-19,标准试样标定
```

**材料库说明**：
- 预置常见材料的标定系数
- 用户可自定义添加材料（通过配置文件）
- 仅供快速测试，正式实验建议使用实际标定数据
- 材料库数据存储在 `data/material_library.json`

---

**2️⃣ 试件形状定义**（必填）

**设计原则**：布尔运算功能采用动态显示，勾选后才显示相关选项，保持界面简洁。

**未勾选"启用布尔运算"时**：
```
▼ 试件形状定义
  形状类型: [●矩形] [○圆形] [○自定义]
  
  宽度 (mm): [100]
  高度 (mm): [150]
  
  ☐ 启用布尔运算
  
  ┌──────────────┐  ┌──────────────┐
  │  验证形状    │  │    预览      │
  └──────────────┘  └──────────────┘
  
  ✓ 形状有效: 面积 15000 mm²
```

**勾选"启用布尔运算"后（未添加任何孔洞/缺口）**：
```
▼ 试件形状定义
  形状类型: [●矩形] [○圆形] [○自定义]
  
  宽度 (mm): [100]
  高度 (mm): [150]
  
  ☑ 启用布尔运算
    ┌─────────────┐  ┌─────────────┐
    │+ 添加孔洞   │  │+ 添加缺口   │
    └─────────────┘  └─────────────┘
  
  已添加: (无)
  
  ┌──────────────┐  ┌──────────────┐
  │  验证形状    │  │    预览      │
  └──────────────┘  └──────────────┘
  
  ✓ 形状有效: 面积 15000 mm²
```

**勾选"启用布尔运算"后（已添加孔洞/缺口）**：
```
▼ 试件形状定义
  形状类型: [●矩形] [○圆形] [○自定义]
  
  宽度 (mm): [100]
  高度 (mm): [150]
  
  ☑ 启用布尔运算
    ┌─────────────┐  ┌─────────────┐
    │+ 添加孔洞   │  │+ 添加缺口   │
    └─────────────┘  └─────────────┘
  
  已添加:
    ● 圆形孔 - 中心(50,75) 半径20mm [编辑] [删除]
    ● 矩形缺口 - 左上(0,60) 宽20 高30 [编辑] [删除]
  
  ┌──────────────┐  ┌──────────────┐
  │  验证形状    │  │    预览      │
  └──────────────┘  └──────────────┘
  
  ✓ 形状有效: 面积 13500 mm²
```

**圆形模式**：
```
▼ 试件形状定义
  形状类型: [○矩形] [●圆形] [○自定义]
  
  圆心 X (mm): [50] 💡点击画布设置
  圆心 Y (mm): [50]
  外半径 (mm): [40]
  
  ☐ 启用扇形区域
  ☐ 启用圆环区域
  ☐ 启用布尔运算
  
  ┌──────────────┐  ┌──────────────┐
  │  验证形状    │  │    预览      │
  └──────────────┘  └──────────────┘
  
  ✓ 形状有效: 面积 5026 mm²
```

**自定义模式**：
```
▼ 试件形状定义
  形状类型: [○矩形] [○圆形] [●自定义]
  
  绘制方式: [●点击画布] [○输入坐标]
  
  顶点列表: (3个顶点)
    1. (0, 0)
    2. (100, 0)
    3. (50, 150)
  
  ☐ 启用布尔运算
  
  ┌──────────────┐  ┌──────────────┐
  │  验证形状    │  │    预览      │
  └──────────────┘  └──────────────┘
  
  ✓ 形状有效: 面积 7500 mm²
```

**交互逻辑**：
```javascript
/**
 * 布尔运算复选框切换事件
 */
document.querySelector('#enable-boolean').addEventListener('change', (e) => {
    const booleanControls = document.querySelector('.boolean-controls');
    const booleanList = document.querySelector('.boolean-list');
    
    if (e.target.checked) {
        // 显示布尔运算控制区
        booleanControls.style.display = 'block';
        booleanList.style.display = 'block';
    } else {
        // 隐藏布尔运算控制区
        booleanControls.style.display = 'none';
        booleanList.style.display = 'none';
    }
});

/**
 * 添加孔洞/缺口后更新列表
 */
function updateBooleanList(items) {
    const listElement = document.querySelector('.boolean-list');
    
    if (items.length === 0) {
        listElement.innerHTML = '已添加: (无)';
    } else {
        let html = '已添加:<br>';
        items.forEach(item => {
            html += `● ${item.description} [编辑] [删除]<br>`;
        });
        listElement.innerHTML = html;
    }
}
```

**3️⃣ 布点设置**（必填）
```
▼ 布点设置
  布点方式: [网格布点 ▼]
  
  【网格布点】
    行数: [5]
    列数: [5]
    行间距 (mm): [10] [变距]
    列间距 (mm): [10] [变距]
    边距 (mm): [10] [分别设置]
  
  【极坐标布点】
    圆心 X (mm): [50]
    圆心 Y (mm): [50]
    径向层数: [3]
    起始半径 (mm): [0]
    半径步长 (mm): [10]
    
    角度范围:
      起始角度 (°): [0]
      结束角度 (°): [360]
    
    角度分布:
      ○ 固定角度步长: [45] °
      ● 固定每层点数: [8] [每层不同]
  
  【变间距布点】
    密集区中心 X (mm): [50]
    密集区中心 Y (mm): [30]
    密集半径 (mm): [20]
    密集区测点数: [16]
    外围测点数: [12]
  
  【自定义布点】
    操作方式: [○点击画布] [○导入CSV]
    测点列表: ...
  
  [生成测点] [优化顺序]
```

**4️⃣ 基准设置**（必填）
```
▼ 基准设置
  基准测点: [#1 ▼]
  
  应力计算模式:
    ● 相对应力模式（基准点 = 0 MPa）
    ○ 绝对应力模式
      基准点应力值 (MPa): [0]
      💡 正值=拉应力，负值=压应力
  
  💡 说明:
    • 相对模式：测量应力分布，基准点为零点
    • 绝对模式：输入基准点真实应力，计算绝对值
```

**5️⃣ 采集控制**（操作区）

**设计原则**：半自动采集模式，用户手动移动探头到每个测点位置，系统采集后需用户确认才保存。

**状态1：等待采集**
```
▼ 采集控制
  测点总数: 25
  已完成: 0
  进度: [░░░░░░░░░░░░░░░░░░░░] 0%
  
  📍 当前测点: #1 (10.0, 10.0) - 基准点
  状态: 等待采集
  
  ┌──────────────────┐  ┌──────────────────┐
  │  采集当前测点    │  │  跳过此测点      │
  └──────────────────┘  └──────────────────┘
  
  💡 右上角波形区显示实时监控，调整探头位置后点击"采集当前测点"
  
  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
  │  暂停采集    │ │  结束采集    │ │    重置      │
  └──────────────┘ └──────────────┘ └──────────────┘
  
  采集选项:
    ☑ 采集后自动降噪
    ☑ 测量失败自动重试
    ☐ 保存原始波形（降噪前）
  
  ┌──────────────────────────────────────┐
  │  🔧 降噪设置 (sym6小波, 5层)         │
  └──────────────────────────────────────┘
```

**状态2：已采集，等待确认**
```
▼ 采集控制
  测点总数: 25
  已完成: 5
  进度: [████░░░░░░░░░░░░] 20%
  
  📍 当前测点: #6 (50.0, 10.0)
  状态: 已采集，等待确认
  
  测量结果:
    时间差: 12.35 ns
    应力值: 45.3 MPa
    波形质量: ⭐⭐⭐⭐☆ (良好)
    已应用降噪: ✓ 小波降噪 (sym6, 5层, heursure)
  
  ┌──────────────────┐  ┌──────────────────┐
  │  确认并继续      │  │  重新采集        │
  └──────────────────┘  └──────────────────┘
  
  💡 请检查右侧波形质量，确认无误后点击"确认并继续"
  
  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
  │  暂停采集    │ │  结束采集    │ │    重置      │
  └──────────────┘ └──────────────┘ └──────────────┘
```

**状态3：选择测点（重新采集已完成的测点）**
```
▼ 采集控制
  测点总数: 25
  已完成: 15
  
  📋 重测已完成测点:
  
  输入测点编号: [20___] 🔍
  
  💡 输入测点编号（1-25），按回车或点击🔍查询
  
  测点信息:
    #20 (50.0, 30.0)
    状态: ✓ 已完成
    应力值: 45.2 MPa
    采集时间: 2025-12-20 14:35:22
  
  ┌──────────────────┐  ┌──────────────────┐
  │  重新采集此测点  │  │  查看历史波形    │
  └──────────────────┘  └──────────────────┘
  
  💡 点击"重新采集此测点"后，系统将切换到该测点的采集状态
```

**重测流程说明**：

当用户发现某个已完成的测点数据有问题，需要重新测量时：

1. **输入测点编号**：在"输入测点编号"框中输入需要重测的测点号（如 20）
2. **查询测点**：按回车键或点击🔍按钮，系统显示该测点的详细信息
3. **验证信息**：确认测点坐标和当前数据
4. **点击重测按钮**：点击"重新采集此测点"按钮
5. **系统切换状态**：
   - 当前测点索引切换为 #20
   - 采集控制面板切换到"等待采集"状态
   - 右上角"当前波形"区域显示该测点的历史波形（如果有）
   - 预览画布中第20个测点标记变为黄色"当前"状态
6. **移动探头**：用户将探头移动到第20个测点的物理位置
7. **采集波形**：点击"采集当前测点"按钮，获取新的波形数据
8. **确认保存**：查看波形质量，点击"确认并继续"
9. **数据更新**：
   - 覆盖保存到 HDF5 和 SQLite
   - 数据表格第20行自动刷新（Δt、σ值更新）
   - 预览画布中第20个测点恢复绿色"已测"状态
   - 云图自动重新生成（如果已生成）
10. **继续采集**：系统不会自动跳到下一测点，用户可以：
    - 继续输入其他测点编号重测
    - 或点击"采集当前测点"继续顺序采集未完成的测点

**输入验证**：
- 只接受数字输入
- 范围检查：1 ≤ 测点编号 ≤ 总测点数
- 状态检查：只能重测"已完成"或"已跳过"的测点
- 无效输入提示：显示错误信息（如"测点 #50 不存在"或"测点 #16 尚未采集"）
```

**6️⃣ 云图设置**（可选）
```
▼ 云图设置
  插值方法: [线性 ▼]
    - 线性
    - 三次样条
    - 径向基函数
  
  网格密度: [50 ▼] 点/边
    - 30（粗糙）
    - 50（标准）
    - 100（精细）
  
  色标范围:
    ○ 自动
    ● 手动
      最小值 (MPa): [0]
      最大值 (MPa): [100]
  
  [生成云图] [导出数据]
```

---

#### 采集流程说明

**完整采集流程**：

```
【阶段1：实时监控】
用户点击 [开始监控]
    ↓
订阅实时采集模块的波形更新
    ↓
右上角"当前波形"区域持续显示实时波形（NORM模式，快速刷新）
    ↓
用户调整探头位置，观察波形质量
    ↓

【阶段2：采集测点】
用户配置降噪参数（点击"降噪设置"按钮，可选）
    ↓
用户点击 [采集当前测点]
    ↓
系统获取RAW模式高精度波形（12bit，完整存储深度）
    ↓
【如果勾选了"采集后自动降噪"】
    ↓ 自动应用降噪（使用预设参数）
    ↓ 显示降噪后的波形
【如果未勾选】
    ↓ 直接显示原始波形
    ↓
计算测量结果：
    • 与基准测点进行互相关
    • 计算时间差 Δt
    • 计算应力值 σ = k × Δt
    • 评估波形质量
    ↓
显示测量结果在左侧控制栏
显示采集的波形在右侧波形区（覆盖实时波形）
    ↓
用户查看波形和结果
    ↓
【选择1】满意 → 点击 [确认并继续]
    ↓ 保存波形到 HDF5
    ↓ 保存测量结果到 SQLite
    ↓ 自动进入下一测点（测点编号+1）
    ↓ 恢复实时波形显示
    ↓ 返回"等待采集"状态
【选择2】不满意 → 点击 [重新采集]
    ↓ 重新采集当前测点
    ↓ 返回采集流程开始
```

**基准测点说明**：
- 第一个采集的测点（通常是 #1）自动作为基准点
- 基准点的应力值固定为 0 MPa（相对应力模式）
- 后续所有测点都与基准点进行互相关计算
- 可以在"基准设置"面板中更换基准点，系统会重新计算所有应力值

**自动保存机制**：
- 每个测点确认后立即保存到数据库和 HDF5 文件
- 防止意外关闭导致数据丢失
- 可随时中断，重新加载实验继续采集

---

#### 降噪设置对话框

点击"降噪设置"按钮后弹出：

```
┌─────────────────────────────────────────────────────────┐
│  🔧 信号降噪设置                                         │
├─────────────────────────────────────────────────────────┤
│                                                           │
│ 降噪方法: [小波降噪 ▼]                                   │
│   • 小波降噪（推荐）                                     │
│   • 移动平均                                              │
│   • 高斯滤波                                              │
│                                                           │
│ 小波类型: [sym6 ▼]                                       │
│   • sym6 (Symlets 6) - 默认                              │
│   • db4 (Daubechies 4)                                   │
│   • sym5 (Symlets 5)                                     │
│   • coif3 (Coiflets 3)                                   │
│                                                           │
│ 分解层数: [5]                                             │
│   💡 推荐范围: 3-7层                                     │
│                                                           │
│ 阈值模式: [soft ▼]                                       │
│   • soft (软阈值，更平滑) - 默认                         │
│   • hard (硬阈值，保留细节)                              │
│                                                           │
│ 阈值选择: [heursure ▼]                                   │
│   • heursure (启发式SURE) - 默认                         │
│   • rigrsure (SURE)                                      │
│   • sqtwolog (固定阈值)                                  │
│   • minimaxi (极小极大)                                  │
│                                                           │
│ ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│ │  测试效果    │  │  恢复默认    │  │  应用并关闭  │   │
│ └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                           │
│ 💡 此设置将应用于所有测点，建议在采集前测试效果         │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

**点击"测试效果"后，对话框扩展显示测试结果**：

```
┌─────────────────────────────────────────────────────────┐
│  🔧 信号降噪设置                                         │
├─────────────────────────────────────────────────────────┤
│                                                           │
│ 降噪方法: [小波降噪 ▼]                                   │
│ 小波类型: [sym6 ▼]                                       │
│ 分解层数: [5]                                             │
│ 阈值模式: [soft ▼]                                       │
│ 阈值选择: [heursure ▼]                                   │
│                                                           │
│ ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│ │  测试效果    │  │  恢复默认    │  │  应用并关闭  │   │
│ └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                           │
│ ─────────────────────────────────────────────────────── │
│ 测试结果:                                                │
│                                                           │
│ 原始波形 SNR: 18.5 dB                                    │
│ 降噪后 SNR: 30.8 dB                                      │
│ 信噪比提升: +12.3 dB ✓                                   │
│                                                           │
│ 💡 降噪效果良好，可以应用                                │
│ 💡 详细波形对比请查看右侧显示区                          │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

**测试效果功能说明**：
1. 点击"测试效果"按钮
2. 系统从示波器采集一次波形
3. 应用当前降噪参数
4. 在右侧波形显示区同时显示：
   - 上半部分：原始波形（灰色）
   - 下半部分：降噪后波形（蓝色）
5. 在对话框中显示信噪比对比
6. 用户可以调整参数，再次点击"测试效果"查看效果
7. 满意后点击"应用并关闭"

**默认降噪参数**：
- 降噪方法：小波降噪
- 小波类型：sym6 (Symlets 6)
- 分解层数：5
- 阈值模式：soft (软阈值)
- 阈值选择：heursure

---

#### 按钮状态切换逻辑

**采集控制按钮状态**：

| 状态 | 可用按钮 | 禁用按钮 |
|------|---------|---------|
| **等待采集** | 采集当前测点、跳过此测点、暂停采集、结束采集、重置 | - |
| **采集中** | - | 全部禁用（显示"采集中..."） |
| **已采集，等待确认** | 确认并继续、重新采集、暂停采集、结束采集 | 重置 |
| **已暂停** | 继续采集、结束采集、重置 | - |
| **已结束** | 重新开始、重置 | 结束采集 |

**结束采集功能**：
- 提前终止采集流程
- 保留已采集的数据
- 可用部分数据生成云图
- 适用于用户想提前结束的场景

**跳过测点功能**：
- 某些测点无法测量时可以跳过
- 跳过的测点标记为"已跳过"状态
- 不参与云图插值计算
- 可以稍后重新采集

---

#### 弹窗设计

**变距输入弹窗（网格布点 - 行间距）**
```
┌─────────────────────────────────┐
│ 行间距变距设置                   │
├─────────────────────────────────┤
│ 行间距数组 (共4个间距):          │
│   第1-2行间距 (mm): [10]        │
│   第2-3行间距 (mm): [15]        │
│   第3-4行间距 (mm): [15]        │
│   第4-5行间距 (mm): [10]        │
│                                  │
│ [确定] [取消] [恢复等距]         │
└─────────────────────────────────┘
```

**边距设置弹窗（网格布点）**
```
┌─────────────────────────────────┐
│ 边距设置                         │
├─────────────────────────────────┤
│ ○ 统一边距: [10] mm              │
│                                  │
│ ● 分别设置:                      │
│   上边距 (mm): [10]              │
│   下边距 (mm): [10]              │
│   左边距 (mm): [15]              │
│   右边距 (mm): [15]              │
│                                  │
│ 💡 边距是指测点区域到试件边缘的距离 │
│                                  │
│ [确定] [取消]                    │
└─────────────────────────────────┘
```

**每层不同点数弹窗（极坐标布点）**
```
┌─────────────────────────────────┐
│ 每层点数设置                     │
├─────────────────────────────────┤
│ 每层点数配置 (共3层):            │
│   第1层点数: [6]                │
│   第2层点数: [8]                │
│   第3层点数: [12]               │
│                                  │
│ 提示: 通常外层点数 ≥ 内层点数    │
│                                  │
│ [确定] [取消] [恢复统一]         │
└─────────────────────────────────┘
```

---

#### 交互提示

**圆心坐标填写**：
- 手动输入：直接在输入框填数值
- 画布点击：在右侧预览画布上点击，自动填入坐标
- 实时预览：输入时画布实时显示圆的位置

**半径步长说明**：
- 相邻两层圆环之间的径向距离
- 示例：起始半径0mm，步长10mm，3层 → 生成0mm、10mm、20mm三层

**角度步长自动计算**：
- 完整圆：(360 - 0) / 点数
- 半圆：(180 - 0) / 点数
- 扇形：(结束角度 - 起始角度) / 点数

---

### 3.3 右侧显示区布局设计


---

**📄 文档说明**：本文档为第1.5-A部分，包含第3章前半部分内容（左侧控制栏设计）。  
**⬅️ 上一部分**：[单轴应力检测模块设计文档.md](./单轴应力检测模块设计文档.md)  
**➡️ 下一部分**：[单轴应力检测模块设计文档-第1.5-B部分.md](./单轴应力检测模块设计文档-第1.5-B部分.md)
