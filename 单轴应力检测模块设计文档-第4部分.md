# 单轴应力检测模块设计文档 v1.0 - 第4部分

> **包含章节**：第9章 API接口设计、第10章 实现计划  
> **上一部分**：[第3部分](./单轴应力检测模块设计文档-第3部分.md)  
> **返回首页**：[第1部分](./单轴应力检测模块设计文档.md)

---

## 9. API 接口设计

### 9.1 后端 API（Python）

#### 实验管理
```python
class StressDetectionUniaxial:
    """应力检测模块 API"""
    
    def create_field_experiment(self, name, calibration_exp_id, 
                               calibration_direction, shape_config):
        """创建应力场实验"""
        return {
            "success": True,
            "data": {
                "experiment_id": "FIELD001",
                "name": name,
                "created_at": "2025-12-19 14:30:00"
            }
        }
    
    def load_field_experiment(self, experiment_id):
        """加载实验"""
        return {
            "success": True,
            "data": {
                "experiment_id": experiment_id,
                "name": "平板应力分布测试",
                "shape_config": {...},
                "point_layout": [...],
                "measured_points": [...]
            }
        }
    
    def delete_field_experiment(self, experiment_id):
        """删除实验"""
        return {"success": True, "message": "实验已删除"}
```

#### 形状和布点
```python
    def validate_shape(self, shape_config):
        """验证形状配置"""
        return {
            "success": True,
            "data": {
                "is_valid": True,
                "area": 15000.0,
                "warnings": []
            }
        }
    
    def generate_point_layout(self, shape_config, layout_type, params):
        """生成测点布局"""
        return {
            "success": True,
            "data": {
                "points": [
                    {"id": 1, "x": 10.0, "y": 10.0},
                    {"id": 2, "x": 30.0, "y": 10.0},
                    # ...
                ],
                "total_count": 25,
                "valid_count": 23
            }
        }
    
    def optimize_point_order(self, points, strategy='zigzag'):
        """优化测点顺序"""
        return {
            "success": True,
            "data": {
                "optimized_points": [...],
                "total_distance": 450.5
            }
        }
```

#### 数据采集
```python
    def capture_field_point(self, experiment_id, point_id):
        """采集单个测点"""
        return {
            "success": True,
            "data": {
                "point_id": point_id,
                "time_diff": 45.23,
                "stress": 120.5,
                "quality_score": 0.95
            }
        }
    
    def skip_field_point(self, experiment_id, point_id):
        """跳过测点"""
        return {"success": True, "message": f"测点 #{point_id} 已跳过"}
    
    def retry_field_point(self, experiment_id, point_id):
        """重测测点"""
        return {
            "success": True,
            "data": {
                "point_id": point_id,
                "time_diff": 46.12,
                "stress": 125.3
            }
        }
```

#### 云图生成
```python
    def update_field_contour(self, experiment_id):
        """更新云图"""
        return {
            "success": True,
            "data": {
                "mode": "contour",  # 'points_only' | 'contour'
                "grid": {
                    "xi": [[...]],
                    "yi": [[...]],
                    "zi": [[...]]
                },
                "method": "cubic",
                "confidence": "full"
            }
        }
    
    def export_field_contour_image(self, experiment_id, format='png'):
        """导出云图图片"""
        return {
            "success": True,
            "data": {
                "file_path": "data/exports/field_001.png"
            }
        }
    
    def export_field_data(self, experiment_id, format='csv'):
        """导出数据"""
        return {
            "success": True,
            "data": {
                "file_path": "data/exports/field_001_data.csv"
            }
        }
```

#### 统计分析
```python
    def get_field_statistics(self, experiment_id):
        """获取统计信息"""
        return {
            "success": True,
            "data": {
                "n_measured": 23,
                "n_total": 25,
                "max_stress": 158.7,
                "max_stress_point": 3,
                "min_stress": 0.0,
                "min_stress_point": 1,
                "mean_stress": 78.3,
                "std_stress": 42.1
            }
        }
```

### 9.2 前端调用示例

#### 创建实验
```javascript
async function createFieldExperiment() {
    const result = await pywebview.api.create_field_experiment(
        "平板应力分布测试",
        "EXP003",
        "0°",
        shapeConfig
    );
    
    if (result.success) {
        experimentId = result.data.experiment_id;
        console.log("实验创建成功:", experimentId);
    }
}
```

#### 生成测点
```javascript
async function generatePoints() {
    const result = await pywebview.api.generate_point_layout(
        shapeConfig,
        'grid',
        {rows: 5, cols: 5, margin: 10}
    );
    
    if (result.success) {
        points = result.data.points;
        drawPointsPreview(points);
    }
}
```

#### 采集循环
```javascript
async function startCapture() {
    for (const point of points) {
        if (point.status === 'pending') {
            // 提示用户
            showMessage(`请移动探头到测点 #${point.id} (${point.x}, ${point.y})`);
            
            // 采集
            const result = await pywebview.api.capture_field_point(experimentId, point.id);
            
            if (result.success) {
                // 更新数据
                point.stress = result.data.stress;
                point.status = 'measured';
                updateTable(point);
                
                // 更新云图
                await updateContour();
            }
        }
    }
}
```

#### 实时云图更新
```javascript
async function updateContour() {
    const result = await pywebview.api.update_field_contour(experimentId);
    
    if (result.success) {
        if (result.data.mode === 'contour') {
            ContourDrawing.drawContourMap(canvas, result.data.grid, shapeConfig);
            
            if (result.data.confidence === 'preview') {
                showWarning('数据点较少，云图仅供参考');
            }
        } else {
            drawDiscretePoints(points);
        }
    }
}
```

---

## 10. 实施计划

### 10.0 前置准备：清理旧代码

⚠️ **重要**：本模块为完全重写版本，需先删除旧代码，再创建新文件。

#### 第0步：删除旧文件

**后端（2个文件）**：
```bash
# 删除旧的单点检测代码
rm modules/stress_detection_uniaxial/stress_detection_uniaxial.py
rm -rf modules/stress_detection_uniaxial/__pycache__
```

**前端（1个文件）**：
```bash
# 删除旧的单点检测UI
rm static/js/stress-detection-uniaxial/stress-detection-uniaxial.js
```

**说明**：
- 旧版本为单点实时检测功能，已废弃
- 新版本为应力场测绘功能，完全重新设计
- `__init__.py` 保留但需要更新导出内容

---

### 10.1 MVP 版本（第一版）

#### 核心功能
- ✅ 矩形试件形状定义
- ✅ 网格布点（支持均匀间距和变间距）
- ✅ 网格布点支持分别设置四边边距
- ✅ 手动逐点采集（半自动模式）
- ✅ 自动降噪（sym6小波，5层，soft阈值，heursure模式）
- ✅ 基础云图显示（cubic插值）
- ✅ 数据表格显示
- ✅ CSV 导出

#### 技术实现
```
后端模块（6个文件）:
  modules/stress_detection_uniaxial/
    ├── __init__.py                  (更新导出)
    ├── field_experiment.py          (新建 - 实验管理)
    ├── field_capture.py             (新建 - 采集控制)
    ├── shape_utils.py               (新建 - 形状工具)
    ├── point_generator.py           (新建 - 测点生成)
    ├── interpolation.py             (新建 - 插值算法)
    └── contour_generator.py         (新建 - 云图生成)

前端模块（7个文件）:
  static/js/stress-detection-uniaxial/
    ├── stress-detection-uniaxial.js      (新建 - 主模块)
    ├── field-experiment-manager.js       (新建 - 实验管理UI)
    ├── field-calibration-panel.js        (新建 - 标定面板)
    ├── field-shape-panel.js              (新建 - 形状面板)
    ├── field-layout-panel.js             (新建 - 布点面板)
    ├── field-capture-panel.js            (新建 - 采集面板)
    ├── field-canvas.js                   (新建 - 预览画布)
    └── field-contour.js                  (新建 - 云图显示)

样式:
  static/css/stress-detection.css
```

#### 文件更新清单

**需要更新的现有文件**：
1. `modules/stress_detection_uniaxial/__init__.py` - 更新模块导出
2. `web_gui.py` - 删除旧API，添加新API
3. `static/index.html` - 更新模块引用和HTML结构

**完全替换，一点不留！**

#### 数据库
```sql
-- 新增三个表
CREATE TABLE field_experiments (...);
CREATE TABLE field_points (...);
CREATE TABLE field_metadata (...);
```

#### 开发时间估算
- 后端 API：2-3天
- 前端 UI：3-4天
- 云图算法：2天
- 测试调试：2天
- **总计：9-11天**

### 10.2 第二版功能

#### 新增功能
- ✅ 圆形试件支持
- ✅ 布尔运算（孔洞/缺口）
- ✅ 极坐标布点
- ✅ 变间距布点
- ✅ 绝对应力模式（支持输入基准点应力值）
- ✅ 实时云图更新（采集过程中）
- ✅ 测点顺序优化
- ✅ 自动采集模式
- ✅ 异常检测和重测
- ✅ 等值线显示
- ✅ Excel 导出
- ✅ 预览画布网格显示（自适应间距 + 刻度标注）

#### 技术增强
```python
# 新增依赖
requirements.txt:
  shapely>=2.0.0      # 几何运算
  openpyxl>=3.0.0     # Excel导出
```

#### 开发时间估算
- 形状编辑器：3天
- 高级布点：2天
- 实时更新：2天
- 自动化功能：2天
- 网格显示：0.5天
- 绝对应力模式：0.5天
- **总计：10天**

### 10.3 第三版功能（可选）

#### 高级功能
- ✅ 自定义多边形
- ✅ 导入 DXF/SVG 轮廓
- ✅ 手动绘制轮廓
- ✅ 多次测量对比
- ✅ 历史记录管理
- ✅ 3D 应力场显示
- ✅ 动画演示（采集过程回放）
- ✅ 报告自动生成（PDF）

#### 技术栈扩展
```python
# 新增依赖
requirements.txt:
  ezdxf>=1.0.0        # DXF文件读取
  svgpathtools>=1.5.0 # SVG路径解析
  reportlab>=4.0.0    # PDF生成
  matplotlib>=3.5.0   # 高级绘图
```

#### 开发时间估算
- 文件导入：3天
- 多次对比：2天
- 3D显示：4天
- 报告生成：3天
- **总计：12天**

### 10.4 开发优先级

#### P0（必须）- MVP
1. 矩形 + 网格布点
2. 手动采集
3. 基础云图
4. 数据表格

#### P1（重要）- 第二版
1. 圆形支持
2. 孔洞/缺口
3. 实时更新
4. 自动模式

#### P2（可选）- 第三版
1. 自定义多边形
2. 文件导入
3. 3D显示
4. 高级报告

### 10.5 注意事项

#### 相对应力说明
⚠️ **本模块测量的是相对应力分布，而非绝对应力值**

- 以基准测点（默认#1）为参考零点
- 显示各测点相对于基准点的应力差
- 如需绝对应力，请在"基准应力"中输入已知值进行校准
- 对于残余应力未知的复材板，建议关注应力梯度而非绝对值

#### 应力正负说明

**物理意义**：
- **拉应力**：正值（+），材料受拉伸
- **压应力**：负值（-），材料受压缩
- **零应力**：基准点，相对应力为0

**计算公式**：
```
σ = k × Δt

其中:
- σ: 应力值（MPa）
- k: 应力系数（由标定实验拟合得到，可正可负）
- Δt: 声时差（ns，相对于基准波形）
```

**系数正负由标定决定**：

**情况1**（常见材料）：
- 标定时：拉应力 → 声时增加 → Δt > 0
- 拟合得到：k > 0（正系数）
- 检测时：
  - Δt > 0 → σ > 0（拉应力）
  - Δt < 0 → σ < 0（压应力）

**情况2**（特殊材料）：
- 标定时：拉应力 → 声时减少 → Δt < 0
- 拟合得到：k < 0（负系数）
- 检测时：
  - Δt > 0 → σ < 0（压应力）
  - Δt < 0 → σ > 0（拉应力）

**系统处理**：
- 标定模块自动拟合应力系数 k（保留正负）
- 检测模块直接使用 σ = k × Δt 计算
- 自动保留应力值的正负号
- 云图根据应力正负显示不同颜色

**云图配色方案**：
```
拉应力区域（正值）：
  +100 MPa ■ 红色（最大拉应力）
   +50 MPa ■ 橙色
   +25 MPa ■ 黄色
  
零应力区域：
     0 MPa ■ 绿色（基准）
  
压应力区域（负值）：
   -25 MPa ■ 青色
   -50 MPa ■ 蓝色
  -100 MPa ■ 紫色（最大压应力）
```

**表格显示示例**：
```
# │ X(mm) │ Y(mm) │ Δt(ns) │ σ(MPa) │状态│
1 │ 10.0  │ 10.0  │  0.00  │   0.0  │ ✓  │ ← 基准点
2 │ 30.0  │ 10.0  │ +12.3  │ +45.2  │ ✓  │ ← 拉应力
3 │ 50.0  │ 10.0  │ -8.5   │ -28.5  │ ✓  │ ← 压应力
```

**注意事项**：
- 系统不假设应力与声时差的正负关系
- 完全由标定数据决定应力系数的正负
- 适用于各种材料和测试条件
- 云图自动适配正负值范围

#### 数据质量
- 前3个测点：不生成云图，仅显示离散点
- 4-8个测点：使用线性插值，标注"预览模式"
- 9个以上测点：使用三次插值，完整云图

#### 测点布置建议
- 应力梯度大的区域增加测点密度
- 边距建议 ≥ 5mm（避免边界效应）
- 孔洞周围建议加密布点
- 总测点数建议 16-49 个（平衡精度和效率）

---

**📄 文档说明**：本文档为第4部分（最后一部分），包含第9-10章内容。  
**⬅️ 上一部分**：[单轴应力检测模块设计文档-第3部分.md](./单轴应力检测模块设计文档-第3部分.md)  
**🏠 返回首页**：[单轴应力检测模块设计文档.md](./单轴应力检测模块设计文档.md)

---

**文档完成！** 🎉
