# 普源示波器实时波形显示系统 - 完整项目文档

## 目录
- [项目概述](#项目概述)
- [核心功能](#核心功能)
- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [快速开始](#快速开始)
- [代码规范](#代码规范)
- [数据管理](#数据管理)
- [UI设计模式](#ui设计模式)
- [开发指南](#开发指南)

---

## 项目概述

基于 pywebview 的桌面应用，用于实时显示和分析普源（RIGOL）示波器波形数据

### 特性亮点
- ✅ **无框架依赖**：纯原生技术栈，轻量高效；
- ✅ **模块化设计**：前后端分离，职责清晰
- ✅ **中文友好**：全中文命名和注释
- ✅ **专业显示**：实时采集黑色背景，分析白色背景
- ✅ **多格式支持**：NPY、CSV、HDF5 三种格式
- ✅ **智能单位**：时间延迟自动选择 ns/μs/ms 显示
- ✅ **高性能**：FFT 加速互相关计算

---

## 核心功能

### 1. 实时采集
- 通过 VISA 协议连接示波器
- 实时显示波形数据（黑色背景，示波器风格）
- 支持远程控制（运行/停止、自动设置）
- 多格式保存（NPY、CSV、HDF5）
- 可调节存储深度、时基、水平/垂直位置、垂直灵敏度

### 2. 波形分析
- 加载已保存的波形文件（NPY、CSV、HDF5）
- 专业白色背景显示
- 交互式工具栏（截图、拖动、框选放大、缩小、适应窗口、重置视图）
- 信号处理功能：
  - 小波降噪（可配置小波类型、分解层数、阈值方法）
  - Hilbert变换（显示信号包络线）
  - 时间差计算（支持0点起始和自定义起点，自动检测波峰）
  - 互相关分析（多文件对比，FFT加速计算，智能单位显示）

### 3. 应力系数标定
- 基于互相关算法计算声时差
- 应力-声时差曲线拟合
- 数据导出（HDF5、CSV）
- 支持手动采集和自动实验模式
- 多方向测试支持（可为同一材料添加多个测试方向）
- 实验数据管理（查看和删除历史实验数据）

### 4. 单轴应力检测
- 加载已标定的应力系数
- 采集基准波形
- 实时监控波形并计算应力值
- 使用互相关算法计算声时差
- 自动应用标定系数计算应力
- 记录和导出检测数据

---

## 技术栈

### 后端技术
- **Python 3.x** - 主要编程语言
- **pywebview** - 桌面应用框架，提供原生窗口（Windows 使用 EdgeChromium 后端）
- **pyvisa** - VISA 通信协议，用于示波器连接
- **numpy** - 数值计算和数组操作
- **scipy** - 科学计算（小波降噪、Hilbert变换、互相关）
- **pywavelets** - 小波变换库
- **h5py** - HDF5 格式支持

### 前端技术
- **纯原生 HTML/CSS/JavaScript** - 无框架依赖
- **Canvas API** - 波形绘制
- **IIFE 模块化** - 立即执行函数封装，避免全局污染

### 架构模式
- **前后端分离** - pywebview 提供桥接层，JavaScript 通过 `pywebview.api.方法名()` 调用后端
- **模块化设计** - 后端功能独立模块，前端 IIFE 封装
- **路由层** - `WebAPI` 类作为路由层，统一管理所有后端接口

---

## 项目结构

```
PythonLearning/
├── main.py                      # 程序入口
├── web_gui.py                   # 后端 API 路由层
├── requirements.txt             # Python 依赖
├── 项目文档.md                  # 完整项目文档（本文件）
│
├── modules/                     # 后端功能模块
│   ├── __init__.py              # 模块导出
│   ├── core/                    # 核心基础设施
│   │   ├── __init__.py
│   │   ├── oscilloscope.py      # 示波器基础通信
│   │   ├── data_manager.py      # 数据管理（SQLite + HDF5）
│   │   ├── signal_processing.py # 信号处理算法
│   │   └── signal_processing_wrapper.py  # 信号处理API包装
│   ├── realtime_capture/        # 实时采集模块
│   │   ├── __init__.py
│   │   └── realtime_capture.py
│   ├── waveform_analysis/       # 波形分析模块
│   │   ├── __init__.py
│   │   └── waveform_analysis.py
│   ├── stress_calibration/      # 应力标定模块
│   │   ├── __init__.py
│   │   └── stress_calibration.py
│   └── stress_detection_uniaxial/  # 单轴应力检测模块
│       ├── __init__.py
│       └── stress_detection_uniaxial.py
│
├── static/                      # 前端资源
│   ├── index.html               # 主界面
│   ├── style.css                # 全局样式
│   ├── css/                     # 样式模块
│   │   ├── base.css             # 基础样式
│   │   ├── components.css       # 组件样式
│   │   └── realtime.css         # 实时采集样式
│   └── js/                      # 前端模块
│       ├── common.js            # 通用工具函数
│       ├── main.js              # 主入口
│       ├── realtime-capture.js  # 实时采集
│       ├── waveform-analysis.js # 波形分析
│       ├── waveform-drawing.js  # 波形绘制
│       ├── waveform-processing.js # 波形处理
│       ├── realtime-capture/    # 实时采集模块
│       │   └── realtime-capture.js  # 实时采集主模块
│       ├── waveform-analysis/   # 波形分析模块
│       │   ├── waveform-analysis.js # 主模块
│       │   ├── waveform-drawing.js  # 绘图
│       │   ├── waveform-zoom.js     # 缩放交互
│       │   ├── waveform-processing.js # 信号处理
│       │   └── waveform-crosscorr.js # 互相关
│       ├── stress-calibration/  # 应力系数标定模块
│       │   ├── stress-calibration.js # 主模块
│       │   ├── stress-calibration-manager.js # 实验管理
│       │   └── stress-calibration-capture.js # 数据采集
│       └── stress-detection-uniaxial/  # 单轴应力检测模块
│           └── stress-detection-uniaxial.js  # 单轴应力检测主模块
│
├── data/                        # 数据目录
│   ├── experiments.db           # SQLite 数据库
│   └── waveforms/               # 波形数据（HDF5）
│
└── .kiro/                       # Kiro AI 配置
    └── steering/                # 项目规范文档
```

### 架构设计

#### 后端架构
- **入口层**（main.py）：程序启动入口，异常处理
- **路由层**（web_gui.py）：`WebAPI` 类统一管理所有后端接口
- **功能模块层**（modules/）：各功能独立封装

#### 前端架构
- **主入口**（main.js）：标签页切换逻辑，初始化各功能模块
- **功能模块**（IIFE 封装）：各功能独立封装，避免全局污染

---

## 快速开始

### 1. 环境要求
- **Python 3.x**
- **Windows 系统**需要 Edge WebView2 Runtime
- **VISA 驱动**（NI-VISA 或 Keysight IO Libraries）

### 2. 安装依赖

```bash
# Windows - 激活虚拟环境（如果使用）
.venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 3. 运行程序

```bash
python main.py
```

### 4. 使用流程

#### 实时采集
1. 点击"搜索设备"连接示波器
2. 选择通道、存储深度、时基
3. 点击"开始采集"实时显示波形
4. 使用控制按钮调整参数
5. 点击"保存波形"保存文件

#### 波形分析
1. 点击"选择文件"加载波形文件
2. 使用工具栏功能（截图、拖动、缩放等）
3. 使用信号处理功能（降噪、Hilbert、时间差、互相关）

#### 应力标定
1. 输入材料名称
2. 添加测试方向（可添加多个方向，如 0°、45°、90°）
3. 点击"开始实验"并连接示波器
4. 采集基准波形
5. 设置应力值并采集应力波形（支持自动递增）
6. 点击"拟合曲线"查看应力-声时差关系
7. 导出数据（HDF5或CSV格式）
8. 通过"实验管理"查看和删除历史数据

#### 单轴应力检测
1. 点击"加载标定数据"选择已标定的HDF5文件
2. 查看标定系数（斜率、截距、R²）
3. 连接示波器并点击"采集基准波形"
4. 点击"开始监控"实时显示波形
5. 点击"开始检测"实时计算应力值
6. 点击"记录"保存当前应力值
7. 点击"导出记录"保存所有检测数据到CSV

---

## 代码规范

### 命名约定

#### 中文命名原则
- **所有变量、函数、类名使用中文**
- **清晰注释使用中文说明意图**
- **数据库字段名使用中文**
- 例外：保留关键字、第三方库接口、标准协议名称可使用英文

#### Python 命名示例
```python
class ExperimentDataManager:
    def 创建实验(self, 材料名称):
        cursor = self.conn.cursor()
        cursor.execute('INSERT INTO experiments (材料名称) VALUES (?)', (材料名称,))
```

#### JavaScript 命名示例
```javascript
const StressCalibrationModule = (function() {
    let 实验状态 = {
        实验ID: null,
        材料名称: "",
        测试方向列表: []
    };
    
    function 采集基准波形() {
        // 实现代码
    }
})();
```

### 模块化规范

#### 后端模块（Python）
- 每个功能独立为一个模块文件（`modules/` 目录）
- 使用类封装功能，类名使用英文（如 `OscilloscopeBase`）
- 方法名使用中文（如 `连接示波器`、`获取波形数据`）

#### 前端模块（JavaScript）
- 所有前端模块使用 IIFE（立即执行函数）封装，避免全局污染
- 模块常量使用 PascalCase（如 `CommonUtils`、`WaveformAnalysis`）
- 内部变量和函数使用中文

### 代码清洁原则

#### 禁止调试代码
- **生产代码中不包含 `console.log` 或 `print` 语句**
- 开发时可临时添加，但发布前必须删除

#### 错误处理
- **后端**：返回统一格式 `{"success": bool, "message": str, "data": any}`
- **前端**：通过 alert() 向用户显示错误信息

---

## 数据管理

### 双层存储架构
- **SQLite**：存储元数据、实验配置、关系数据
- **HDF5**：存储大容量波形数据（时间序列、电压数据）

### 数据库设计

#### experiments（实验表）
```sql
CREATE TABLE experiments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    材料名称 TEXT NOT NULL,
    创建时间 DATETIME DEFAULT CURRENT_TIMESTAMP,
    状态 TEXT DEFAULT 'running'
)
```

#### test_directions（测试方向表）
```sql
CREATE TABLE test_directions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    实验ID INTEGER NOT NULL,
    方向名称 TEXT NOT NULL,
    应力范围起始 REAL DEFAULT 0,
    应力范围结束 REAL DEFAULT 100,
    应力步长 REAL DEFAULT 10,
    基准波形路径 TEXT,
    FOREIGN KEY (实验ID) REFERENCES experiments(id),
    UNIQUE(实验ID, 方向名称)
)
```

#### stress_data（应力数据表）
```sql
CREATE TABLE stress_data (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    方向ID INTEGER NOT NULL,
    应力值 REAL NOT NULL,
    时间差 REAL,
    波形路径 TEXT,
    采集时间 DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (方向ID) REFERENCES test_directions(id),
    UNIQUE(方向ID, 应力值)
)
```

### HDF5 文件组织

#### 文件路径规范
```
data/
├── experiments.db                          # SQLite 数据库
└── waveforms/                              # 波形数据目录
    └── EXP001/                             # 实验ID（3位数字）
        ├── 0°/                             # 测试方向
        │   ├── baseline.h5                 # 基准波形
        │   ├── stress_10.0MPa.h5          # 应力波形
        │   └── stress_20.0MPa.h5
        └── 45°/
            ├── baseline.h5
            └── stress_10.0MPa.h5
```

### 数据文件格式

#### NPY 格式（推荐用于单个波形）
- 高精度：保留12bit原始数据
- 文件小：二进制压缩存储
- 加载快：直接映射到内存

#### CSV 格式（推荐用于导出和分析）
- 通用性好：可用 Excel、MATLAB 等打开
- 纯文本：易于查看和编辑
- 两列数据：时间（秒）和电压（伏特）

#### HDF5 格式（推荐用于实验数据集）
- 大数据集：适合存储大量波形
- 层次结构：支持多组数据和元数据
- 压缩存储：节省磁盘空间

### 实验数据管理

#### 数据组织方式
- 一个实验可以包含多个测试方向
- 每个方向独立保存基准波形和应力波形
- 实验ID自动递增（EXP001、EXP002...）

#### 删除逻辑
- **删除方向**：删除单个方向的所有数据（基准波形、应力数据、拟合结果）
- **智能清理**：如果删除后该实验没有其他方向，自动删除整个实验记录
- **ID重置**：当数据库完全清空时，自动重置ID计数器，下次从EXP001开始

#### 实验管理界面
- 点击"实验管理"按钮查看所有历史实验
- 显示格式：`EXP001 - 材料名称 - 方向名称`
- 每个方向显示创建时间和数据点数
- 点击"删除"按钮删除该方向的所有数据

---

## UI设计模式

### 界面布局

#### 标签页架构
应用使用标签页（Tab）架构组织四大功能模块：
- 📊 实时采集
- 📈 波形分析
- 🔬 应力系数标定
- 🔍 单轴应力检测

#### 左右分栏布局
每个功能模块采用左右分栏：
- **左侧**：配置面板（控制参数、按钮）
- **右侧**：显示区域（Canvas 波形图、数据表格）

### Canvas 绘图规范

#### 波形绘制样式

**实时采集模式（示波器风格）**
- 背景色：黑色 `#0a0a0a`
- 网格线：深灰色 `#1a1a1a`，中心线 `#333333`
- 波形线：绿色 `#00ff00`，线宽 2px
- 刻度文字：灰色 `#999999`，等宽字体 `Consolas`

**波形分析模式（专业风格）**
- 背景色：白色 `#ffffff`
- 网格线：浅灰色 `#e0e0e0`
- 波形线：蓝色 `#2563eb`，线宽 1.5px
- 刻度文字：深灰色 `#333`

### 按钮设计

#### 按钮类型
- **主要操作**：`btn btn-primary`
- **成功操作**：`btn btn-success`
- **危险操作**：`btn btn-danger`
- **次要操作**：`btn btn-secondary`

#### Emoji 图标使用
- 📊 实时采集
- 📈 波形分析
- 🔬 应力系数标定
- 🔍 单轴应力检测
- 💾 保存
- ✕ 关闭/断开
- ▶️ 开始/运行
- ⏹️ 停止
- 📂 文件管理

### 颜色规范

#### 主题色
- 主色调：蓝色 `#2563eb`
- 成功色：绿色 `#22c55e`
- 警告色：黄色 `#eab308`
- 危险色：红色 `#ef4444`
- 中性色：灰色 `#6b7280`

---

## 开发指南

### 添加新功能

#### 后端新功能
1. 在 `modules/` 创建新模块文件
2. 在 `modules/__init__.py` 中导出
3. 在 `web_gui.py` 的 `WebAPI` 类中添加方法
4. 返回统一格式：`{"success": bool, "message": str, "data": any}`

#### 前端新功能
1. 在 `static/js/` 创建对应模块（IIFE 封装）
2. 通过 `pywebview.api.方法名()` 调用后端
3. 在 `index.html` 添加 UI 元素
4. 在 `main.js` 中初始化模块

### 调试技巧
- 使用浏览器开发者工具（F12）查看控制台
- 检查 Python 终端输出
- **发布前删除所有调试代码**

### 常见问题

#### 1. 找不到示波器
- 检查 USB 连接是否正常
- 确认已安装 VISA 驱动
- 检查示波器是否开机

#### 2. 波形显示异常
- 检查文件格式是否正确
- 尝试重新加载文件
- 点击"重置视图"恢复默认显示

#### 3. 互相关计算失败
- 确保所有文件的采样率一致
- 检查信号长度是否相近
- 确保至少有2个有效文件

---

## 许可证

本项目仅供学习和研究使用。

## 致谢

感谢所有开源项目的贡献者。
