# 普源示波器实时波形显示系统 - 完整项目文档

---

## ⚠️ 开发铁律 - 必读！

### 🚫 禁止"表面功能"

**问题描述：**
- ✅ UI显示正常（按钮、状态徽章、提示信息）
- ❌ 实际逻辑缺失（回调未调用、状态未更新、后端未实现）
- 💥 用户体验极差（看起来能用，点了没反应）

**典型案例：**
1. **状态显示与实际不符** - 显示"✅ 已设置"，但内部标志未设置
2. **按钮点击无响应** - 前端有按钮，后端API未实现
3. **数据加载不完整** - 只恢复了UI显示，未恢复内部状态
4. **回调链断裂** - A调用B，B显示成功，但C依赖的状态未更新

**开发要求：**
1. ✅ **完整实现功能** - UI + 逻辑 + 前后端打通
2. ✅ **测试关键路径** - 正常流程 + 加载恢复流程
3. ✅ **状态一致性** - UI显示 = 内部状态 = 数据库数据
4. ✅ **不留半成品** - 要么完整实现，要么明确标注"未实现"

**检查清单：**
- [ ] UI显示是否与内部状态一致？
- [ ] 点击按钮后，相关状态是否正确更新？
- [ ] 从数据库加载后，所有状态是否完整恢复？
- [ ] 依赖此功能的其他模块是否能正常工作？

---

## 目录
- [项目概述](#项目概述)
- [核心功能](#核心功能)
- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [快速开始](#快速开始)
- [代码规范](#代码规范)
- [数据管理](#数据管理)
- [UI设计模式](#ui设计模式)
- [开发指南](#开发指南)

---

## 项目概述

基于 pywebview 的桌面应用，用于实时显示和分析普源（RIGOL）示波器波形数据

### 特性亮点
- ✅ **无框架依赖**：纯原生技术栈，轻量高效
- ✅ **模块化设计**：前后端分离，职责清晰
- ✅ **中文友好**：全中文命名和注释
- ✅ **专业显示**：实时采集黑色背景，分析白色背景
- ✅ **多格式支持**：NPY、CSV、HDF5、Excel 多种格式
- ✅ **智能单位**：时间延迟自动选择 ns/μs/ms 显示
- ✅ **高性能**：FFT 加速互相关计算
- ⭐ **应力场测绘**：完整的二维应力分布测量解决方案

---

## 核心功能

### 1. 实时采集
- 通过 VISA 协议连接示波器
- 实时显示波形数据（黑色背景，示波器风格）
- 支持远程控制（运行/停止、自动设置）
- 多格式保存（NPY、CSV、HDF5）
- 可调节存储深度、时基、水平/垂直位置、垂直灵敏度

### 2. 波形分析
- 加载已保存的波形文件（NPY、CSV、HDF5）
- 专业白色背景显示
- 交互式工具栏（截图、拖动、框选放大、缩小、适应窗口、重置视图）
- 信号处理功能：
  - 小波降噪（可配置小波类型、分解层数、阈值方法）
  - Hilbert变换（显示信号包络线）
  - 时间差计算（支持0点起始和自定义起点，自动检测波峰）
  - 互相关分析（多文件对比，FFT加速计算，智能单位显示）

### 3. 应力系数标定
- 基于互相关算法计算声时差
- 应力-声时差曲线拟合
- 数据导出（HDF5、CSV）
- 支持手动采集和自动实验模式
- 多方向测试支持（可为同一材料添加多个测试方向）
- 实验数据管理（查看和删除历史实验数据）

### 4. 单轴应力检测
- 加载已标定的应力系数
- 采集基准波形
- 实时监控波形并计算应力值
- 使用互相关算法计算声时差
- 自动应用标定系数计算应力
- 记录和导出检测数据

### 5. 应力场测绘 ⭐ 新增功能
完整的二维应力分布测量解决方案，包含以下子功能：

#### 5.1 实验管理
- 创建实验（名称、材料、厚度、测试目的等）
- 加载历史实验
- 删除实验（含数据清理）
- 导出实验数据（CSV/Excel/HDF5）

#### 5.2 试件形状定义
- **基本形状**：矩形、圆形（含扇形）、多边形
- **布尔运算**：支持挖孔（subtract），可添加多个孔洞
- **形状验证**：自动检查面积、长宽比、自相交等
- **实时预览**：Canvas 可视化显示

#### 5.3 测点布局
- **网格布点**：
  - 均匀网格（行数×列数）
  - 变间距网格（自定义行/列间距数组）
  - 边距设置（统一边距或分别设置上下左右）
- **极坐标布点**：
  - 多层圆环布点（最小/最大半径，层数）
  - 每层点数可配置
  - 圆心自动判断（是否在孔洞内）
- **自定义布点**：CSV 文件导入
- **路径优化**：之字形、最近邻、螺旋扫描
- **自动过滤**：形状外和孔洞内的点自动排除

#### 5.4 标定数据加载
- 从本地标定实验加载系数
- 质量检查模式：
  - 快速模式：仅检查 SNR
  - 标准模式：SNR + 相关系数
  - 严格模式：SNR + 相关系数 + 峰值质量
- 质量警告提示

#### 5.5 数据采集
- 基准波形采集（单次）
- 多点顺序采集（自动/手动）
- 实时进度显示
- 质量检查（SNR、相关系数）
- 支持跳过、重测、暂停/继续

#### 5.6 应力云图
- **插值算法**：IDW（反距离权重）、Kriging（克里金）、RBF（径向基函数）
- **可视化**：彩色等高线图，可调色阶数量
- **图例**：自动生成色标
- **导出**：PNG/JPG 图片导出

#### 5.7 数据导出
- CSV：测点坐标和应力值
- Excel：完整报告（含统计信息）
- HDF5：含波形数据
- 云图图片：PNG/JPG

---

## 技术栈

### 后端技术
- **Python 3.x** - 主要编程语言
- **pywebview** - 桌面应用框架，提供原生窗口（Windows 使用 EdgeChromium 后端）
- **pyvisa** - VISA 通信协议，用于示波器连接
- **numpy** - 数值计算和数组操作
- **scipy** - 科学计算（小波降噪、Hilbert变换、互相关、RBF插值）
- **pywavelets** - 小波变换库
- **h5py** - HDF5 格式支持
- **shapely** - 几何运算库，用于形状验证和布尔运算（应力场测绘）
- **scikit-learn** - 机器学习库，用于 Kriging 插值（应力场测绘）

### 前端技术
- **纯原生 HTML/CSS/JavaScript** - 无框架依赖
- **Canvas API** - 波形绘制
- **IIFE 模块化** - 立即执行函数封装，避免全局污染

### 架构模式
- **前后端分离** - pywebview 提供桥接层，JavaScript 通过 `pywebview.api.方法名()` 调用后端
- **模块化设计** - 后端功能独立模块，前端 IIFE 封装
- **路由层** - `WebAPI` 类作为路由层，统一管理所有后端接口


---

## 项目结构

```
PythonLearning/
├── main.py                      # 程序入口
├── web_gui.py                   # 后端 API 路由层
├── requirements.txt             # Python 依赖
├── 项目文档.md                  # 完整项目文档（本文件）
│
├── modules/                     # 后端功能模块
│   ├── __init__.py              # 模块导出
│   ├── core/                    # 核心基础设施
│   │   ├── __init__.py
│   │   ├── oscilloscope.py      # 示波器基础通信（VISA/SCPI）
│   │   ├── data_manager.py      # 数据管理（SQLite + HDF5）
│   │   ├── signal_processing.py # 信号处理算法
│   │   └── signal_processing_wrapper.py  # 信号处理API包装
│   ├── realtime_capture/        # 实时采集模块
│   │   ├── __init__.py
│   │   └── realtime_capture.py
│   ├── waveform_analysis/       # 波形分析模块
│   │   ├── __init__.py
│   │   └── waveform_analysis.py
│   ├── stress_calibration/      # 应力标定模块
│   │   ├── __init__.py
│   │   └── stress_calibration.py
│   └── stress_detection_uniaxial/  # 单轴应力检测模块
│       ├── __init__.py
│       ├── field_experiment.py   # 应力场实验管理
│       ├── field_database.py     # 应力场数据库操作
│       ├── field_hdf5.py         # 应力场HDF5存储
│       ├── field_capture.py      # 应力场数据采集
│       ├── point_generator.py    # 测点生成器（网格/极坐标/自定义）
│       ├── shape_utils.py        # 形状工具（验证/判断/布尔运算）
│       ├── interpolation.py      # 插值算法（IDW/Kriging/RBF）
│       ├── contour_generator.py  # 云图生成器
│       ├── data_export.py        # 数据导出（CSV/Excel/HDF5）
│       └── error_codes.py        # 错误码定义
│
├── static/                      # 前端资源
│   ├── index.html               # 主界面
│   ├── splash.html              # 启动画面
│   ├── style.css                # 全局样式
│   ├── css/                     # 样式模块
│   │   ├── base.css             # 基础样式
│   │   ├── components.css       # 组件样式
│   │   ├── realtime.css         # 实时采集样式
│   │   ├── analysis.css         # 分析模块样式
│   │   ├── responsive.css       # 响应式设计
│   │   ├── stress-calibration.css    # 应力标定样式
│   │   ├── stress-common.css         # 应力模块公共样式
│   │   └── stress-detection-uniaxial/  # 单轴应力检测样式
│   │       ├── layout.css       # 布局样式
│   │       ├── panels.css       # 面板样式
│   │       ├── capture.css      # 采集面板样式
│   │       ├── display.css      # 显示区域样式
│   │       └── modals.css       # 弹窗样式
│   └── js/                      # 前端模块
│       ├── common.js            # 通用工具函数
│       ├── main.js              # 主入口
│       ├── realtime-capture/    # 实时采集模块
│       │   └── realtime-capture.js
│       ├── waveform-analysis/   # 波形分析模块
│       │   ├── waveform-analysis.js # 主模块
│       │   ├── waveform-drawing.js  # 绘图
│       │   ├── waveform-zoom.js     # 缩放交互
│       │   ├── waveform-processing.js # 信号处理
│       │   └── waveform-crosscorr.js # 互相关
│       ├── stress-calibration/  # 应力系数标定模块
│       │   ├── stress-calibration.js # 主模块
│       │   ├── stress-calibration-manager.js # 实验管理
│       │   └── stress-calibration-capture.js # 数据采集
│       └── stress-detection-uniaxial/  # 单轴应力检测模块
│           ├── stress-detection-uniaxial.js  # 主模块
│           ├── field-experiment-manager.js   # 应力场实验管理
│           ├── field-shape-panel.js          # 形状设置面板
│           ├── field-layout-panel.js         # 测点布局面板
│           ├── field-calibration-panel.js    # 标定数据面板
│           ├── field-capture-panel.js        # 数据采集面板
│           ├── field-canvas.js               # 预览画布
│           ├── field-contour.js              # 云图画布
│           └── field-resizer.js              # 布局调整器
│
├── data/                        # 数据目录
│   ├── experiments.db           # SQLite 数据库
│   ├── waveforms/               # 波形数据（HDF5）
│   │   └── EXP001/              # 实验文件夹
│   │       └── 0°/              # 测试方向
│   │           ├── baseline.h5  # 基准波形
│   │           └── stress_*.h5  # 应力波形
│   └── uniaxial_field/          # 应力场测绘数据
│       └── FLDXXX/              # 应力场实验文件夹
│           ├── shape.json       # 形状配置
│           ├── points.json      # 测点布局
│           ├── baseline.h5      # 基准波形
│           └── point_*.h5       # 各测点波形
│
└── .kiro/                       # Kiro AI 配置
    └── steering/                # 项目规范文档
```

### 模块职责

#### 后端模块

**核心基础设施（core/）：**
- **oscilloscope.py**：底层 VISA 通信、SCPI 命令、波形数据采集
- **data_manager.py**：数据库操作、HDF5 文件管理、实验 CRUD
- **signal_processing.py**：核心算法（小波降噪、Hilbert 变换、峰值检测）
- **signal_processing_wrapper.py**：信号处理 API 包装器

**功能模块：**
- **realtime_capture.py**：实时显示逻辑、文件保存（NPY/CSV/HDF5）
- **waveform_analysis.py**：文件加载、多文件管理、互相关
- **stress_calibration.py**：实验创建、基准/应力波形管理、曲线拟合

**应力场测绘模块（stress_detection_uniaxial/）：**
- **field_experiment.py**：实验生命周期管理、状态控制
- **field_database.py**：SQLite数据库操作（实验/测点/结果）
- **field_hdf5.py**：HDF5文件管理（波形数据存储）
- **field_capture.py**：数据采集流程、质量检查
- **point_generator.py**：测点生成（网格/极坐标/自定义/自适应）
- **shape_utils.py**：形状验证、点位判断、布尔运算
- **interpolation.py**：空间插值（IDW/Kriging/RBF）
- **contour_generator.py**：应力云图生成
- **data_export.py**：数据导出（CSV/Excel/HDF5/图片）
- **error_codes.py**：统一错误码定义

#### 前端模块

- **main.js**：标签页切换、模块初始化
- **realtime-capture.js**：实时显示 UI、示波器控制
- **waveform-analysis.js**：文件选择、分析 UI 协调
- **waveform-drawing.js**：Canvas 渲染、网格绘制、波形绘图
- **waveform-processing.js**：信号处理 UI（降噪、Hilbert、时间差）
- **waveform-zoom.js**：交互式缩放、平移、重置视图
- **waveform-crosscorr.js**：多文件互相关 UI
- **stress-calibration.js**：实验工作流、数据采集、曲线拟合 UI
- **stress-calibration-manager.js**：实验数据管理 UI
- **stress-calibration-capture.js**：标定实时波形采集

**应力场测绘前端模块：**
- **field-experiment-manager.js**：实验创建、加载、删除、导出
- **field-shape-panel.js**：试件形状设置（矩形/圆形/多边形/布尔运算）
- **field-layout-panel.js**：测点布局（网格/极坐标/自定义/优化）
- **field-calibration-panel.js**：标定数据加载、质量检查模式
- **field-capture-panel.js**：数据采集控制、进度管理
- **field-canvas.js**：预览画布（形状绘制、测点标记、交互）
- **field-contour.js**：云图画布（插值、渲染、图例）
- **field-resizer.js**：布局拖拽调整

---

## 快速开始

### 1. 环境要求
- **Python 3.x**
- **Windows 系统**需要 Edge WebView2 Runtime
- **VISA 驱动**（NI-VISA 或 Keysight IO Libraries）

### 2. 安装依赖

```bash
# Windows - 激活虚拟环境（如果使用）
.venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 3. 运行程序

```bash
python main.py
```

### 4. 使用流程

#### 实时采集
1. 点击"搜索设备"连接示波器
2. 选择通道、存储深度、时基
3. 点击"开始采集"实时显示波形
4. 使用控制按钮调整参数
5. 点击"保存波形"保存文件

#### 波形分析
1. 点击"选择文件"加载波形文件
2. 使用工具栏功能（截图、拖动、缩放等）
3. 使用信号处理功能（降噪、Hilbert、时间差、互相关）

#### 应力标定
1. 输入材料名称
2. 添加测试方向（可添加多个方向，如 0°、45°、90°）
3. 点击"开始实验"并连接示波器
4. 采集基准波形
5. 设置应力值并采集应力波形（支持自动递增）
6. 点击"拟合曲线"查看应力-声时差关系
7. 导出数据（HDF5或CSV格式）
8. 通过"实验管理"查看和删除历史数据

#### 单轴应力检测
1. 点击"加载标定数据"选择已标定的HDF5文件
2. 查看标定系数（斜率、截距、R²）
3. 连接示波器并点击"采集基准波形"
4. 点击"开始监控"实时显示波形
5. 点击"开始检测"实时计算应力值
6. 点击"记录"保存当前应力值
7. 点击"导出记录"保存所有检测数据到CSV

#### 应力场测绘
1. **创建实验**：输入实验名称、材料、厚度等信息
2. **定义形状**：选择试件形状（矩形/圆形/多边形），可添加孔洞
3. **布置测点**：选择布点方式（网格/极坐标/自定义），设置参数
4. **加载标定**：选择已有的标定实验数据
5. **采集数据**：
   - 先采集基准波形
   - 然后按顺序采集各测点数据
   - 支持自动/手动模式
6. **生成云图**：选择插值算法，生成应力分布云图
7. **导出数据**：导出CSV/Excel/HDF5/图片

---

## 代码规范

### 命名约定

#### 中文命名原则
- **所有变量、函数、类名使用中文**
- **清晰注释使用中文说明意图**
- **数据库字段名使用中文**
- 例外：保留关键字、第三方库接口、标准协议名称可使用英文

#### Python 命名示例
```python
class ExperimentDataManager:
    def 创建实验(self, 材料名称):
        cursor = self.conn.cursor()
        cursor.execute('INSERT INTO experiments (材料名称) VALUES (?)', (材料名称,))
```

#### JavaScript 命名示例
```javascript
const StressCalibrationModule = (function() {
    let 实验状态 = {
        实验ID: null,
        材料名称: "",
        测试方向列表: []
    };
    
    function 采集基准波形() {
        // 实现代码
    }
})();
```

### 模块化规范

#### 后端模块（Python）
- 每个功能独立为一个模块文件（`modules/` 目录）
- 使用类封装功能，类名使用英文（如 `OscilloscopeBase`）
- 方法名使用中文（如 `连接示波器`、`获取波形数据`）

#### 前端模块（JavaScript）
- 所有前端模块使用 IIFE（立即执行函数）封装，避免全局污染
- 模块常量使用 PascalCase（如 `CommonUtils`、`WaveformAnalysis`）
- 内部变量和函数使用中文

### 代码清洁原则

#### 禁止调试代码
- **生产代码中不包含 `console.log` 或 `print` 语句**
- 开发时可临时添加，但发布前必须删除

#### 错误处理
- **后端**：返回统一格式 `{"success": bool, "message": str, "data": any}`
- **前端**：通过 alert() 向用户显示错误信息

---

## 数据管理

### 双层存储架构
- **SQLite**：存储元数据、实验配置、关系数据
- **HDF5**：存储大容量波形数据（时间序列、电压数据）

### 数据库设计

#### experiments（实验表）
```sql
CREATE TABLE experiments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    材料名称 TEXT NOT NULL,
    创建时间 DATETIME DEFAULT CURRENT_TIMESTAMP,
    状态 TEXT DEFAULT 'running'
)
```

#### test_directions（测试方向表）
```sql
CREATE TABLE test_directions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    实验ID INTEGER NOT NULL,
    方向名称 TEXT NOT NULL,
    应力范围起始 REAL DEFAULT 0,
    应力范围结束 REAL DEFAULT 100,
    应力步长 REAL DEFAULT 10,
    基准波形路径 TEXT,
    FOREIGN KEY (实验ID) REFERENCES experiments(id),
    UNIQUE(实验ID, 方向名称)
)
```

#### stress_data（应力数据表）
```sql
CREATE TABLE stress_data (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    方向ID INTEGER NOT NULL,
    应力值 REAL NOT NULL,
    时间差 REAL,
    波形路径 TEXT,
    采集时间 DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (方向ID) REFERENCES test_directions(id),
    UNIQUE(方向ID, 应力值)
)
```

#### field_experiments（应力场实验表）
```sql
CREATE TABLE field_experiments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    实验名称 TEXT NOT NULL,
    材料名称 TEXT,
    厚度 REAL,
    测试目的 TEXT,
    状态 TEXT DEFAULT 'created',
    创建时间 DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

#### field_points（应力场测点表）
```sql
CREATE TABLE field_points (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    实验ID INTEGER NOT NULL,
    点序号 INTEGER NOT NULL,
    x坐标 REAL NOT NULL,
    y坐标 REAL NOT NULL,
    状态 TEXT DEFAULT 'pending',
    时间差 REAL,
    应力值 REAL,
    采集时间 DATETIME,
    FOREIGN KEY (实验ID) REFERENCES field_experiments(id)
)
```

### HDF5 文件组织

#### 标定实验文件路径
```
data/waveforms/
└── EXP001/                             # 实验ID（3位数字）
    ├── 0°/                             # 测试方向
    │   ├── baseline.h5                 # 基准波形
    │   ├── stress_10.0MPa.h5          # 应力波形
    │   └── stress_20.0MPa.h5
    └── 45°/
        ├── baseline.h5
        └── stress_10.0MPa.h5
```

#### 应力场测绘文件路径
```
data/uniaxial_field/
└── FLD001/                             # 应力场实验ID
    ├── shape.json                      # 形状配置
    ├── points.json                     # 测点布局
    ├── baseline.h5                     # 基准波形
    ├── point_001.h5                    # 测点1波形
    ├── point_002.h5                    # 测点2波形
    └── ...
```

### 数据文件格式

#### NPY 格式（推荐用于单个波形）
- 高精度：保留12bit原始数据
- 文件小：二进制压缩存储
- 加载快：直接映射到内存

#### CSV 格式（推荐用于导出和分析）
- 通用性好：可用 Excel、MATLAB 等打开
- 纯文本：易于查看和编辑
- 两列数据：时间（秒）和电压（伏特）

#### HDF5 格式（推荐用于实验数据集）
- 大数据集：适合存储大量波形
- 层次结构：支持多组数据和元数据
- 压缩存储：节省磁盘空间

---

## UI设计模式

### 界面布局

#### 标签页架构
应用使用标签页（Tab）架构组织五大功能模块：
- 📊 实时采集
- 📈 波形分析
- 🔬 应力系数标定
- 🔍 单轴应力检测（含应力场测绘）

#### 左右分栏布局
每个功能模块采用左右分栏：
- **左侧**：配置面板（控制参数、按钮）
- **右侧**：显示区域（Canvas 波形图、数据表格）

#### 应力场测绘布局
采用三栏布局：
- **左侧**：配置面板（形状、测点、标定、采集）
- **中间**：预览画布（形状和测点可视化）
- **右侧**：云图画布（应力分布可视化）

### Canvas 绘图规范

#### 波形绘制样式

**实时采集模式（示波器风格）**
- 背景色：黑色 `#0a0a0a`
- 网格线：深灰色 `#1a1a1a`，中心线 `#333333`
- 波形线：绿色 `#00ff00`，线宽 2px
- 刻度文字：灰色 `#999999`，等宽字体 `Consolas`

**波形分析模式（专业风格）**
- 背景色：白色 `#ffffff`
- 网格线：浅灰色 `#e0e0e0`
- 波形线：蓝色 `#2563eb`，线宽 1.5px
- 刻度文字：深灰色 `#333`

**应力云图**
- 使用彩虹色阶（蓝→绿→黄→红）
- 支持自定义色阶数量
- 自动生成图例色标

### 按钮设计

#### 按钮类型
- **主要操作**：`btn btn-primary`
- **成功操作**：`btn btn-success`
- **危险操作**：`btn btn-danger`
- **次要操作**：`btn btn-secondary`

#### Emoji 图标使用
- 📊 实时采集
- 📈 波形分析
- 🔬 应力系数标定
- 🔍 单轴应力检测
- 💾 保存
- ✕ 关闭/断开
- ▶️ 开始/运行
- ⏹️ 停止
- 📂 文件管理

### 颜色规范

#### 主题色
- 主色调：蓝色 `#2563eb`
- 成功色：绿色 `#22c55e`
- 警告色：黄色 `#eab308`
- 危险色：红色 `#ef4444`
- 中性色：灰色 `#6b7280`

---

## 开发指南

### 添加新功能

#### 后端新功能
1. 在 `modules/` 创建新模块文件
2. 在 `modules/__init__.py` 中导出
3. 在 `web_gui.py` 的 `WebAPI` 类中添加方法
4. 返回统一格式：`{"success": bool, "message": str, "data": any}`

#### 前端新功能
1. 在 `static/js/` 创建对应模块（IIFE 封装）
2. 通过 `pywebview.api.方法名()` 调用后端
3. 在 `index.html` 添加 UI 元素
4. 在 `main.js` 中初始化模块

### 数据流

1. **用户操作**（前端）→ JavaScript 事件处理器
2. **API 调用** → `pywebview.api.方法名()` 桥接到 Python
3. **路由** → `web_gui.py` 中的 `WebAPI` 类方法
4. **模块** → `modules/` 中的特定模块方法
5. **响应** → 返回 `{"success": bool, "message": str, "data": any}`
6. **UI 更新** → JavaScript 更新 DOM/Canvas

### 调试技巧
- 使用浏览器开发者工具（F12）查看控制台
- 检查 Python 终端输出
- **发布前删除所有调试代码**

### 常见问题

#### 1. 找不到示波器
- 检查 USB 连接是否正常
- 确认已安装 VISA 驱动
- 检查示波器是否开机

#### 2. 波形显示异常
- 检查文件格式是否正确
- 尝试重新加载文件
- 点击"重置视图"恢复默认显示

#### 3. 互相关计算失败
- 确保所有文件的采样率一致
- 检查信号长度是否相近
- 确保至少有2个有效文件

#### 4. 应力场测绘问题
- **测点生成失败**：检查形状是否有效（面积>0，无自相交）
- **插值结果异常**：确保有足够的有效测点数据
- **云图不显示**：检查是否已完成数据采集

---

## 文件命名约定

- 后端模块：小写加下划线（例如：`signal_processing.py`）
- 前端模块：短横线命名（例如：`waveform-analysis.js`）
- CSS 模块：短横线命名（例如：`base.css`）
- 数据文件：描述性名称加扩展名（例如：`experiments.db`、`baseline.h5`）

---

## 许可证

本项目仅供学习和研究使用。

## 致谢

感谢所有开源项目的贡献者。


---

## 更新日志

### 2024-12-23 - 代码优化与清理

#### 🧹 代码清理
1. **删除未使用的缓存系统**
   - 删除 `ContourCache` 类（约60行）
   - 删除 `needs_full_regeneration` 方法（约25行）
   - 删除 `clear_cache` 方法（约5行）
   - 删除相关导入和实例化（约5行）
   - **原因**：过度设计的 LRU 缓存系统从未被使用，当前的简单缓存机制已足够

2. **删除调试代码**
   - 删除所有 `console.log` 调试语句（前端62个）
   - 删除所有 `print()` 调试语句（后端多处）
   - 保留 `console.error` 和 `console.warn`（用于错误追踪）
   - 删除测试文件 `check_h5_content.py`

3. **代码清理成果**
   - 总计删除约 **100+ 行未使用代码**
   - 代码更简洁，维护成本更低
   - 控制台输出更清晰
   - 所有文件通过语法检查

#### 🐛 Bug 修复
1. **修复等高线功能错误**
   - 修复 `contour_generator.py` 中的导入错误
     - 错误：`from .interpolation import SpatialInterpolator`
     - 正确：`from .interpolation import StressFieldInterpolation`
   
2. **修复 None 值处理问题**
   - 在 `contour_generator.py` 的 3 个方法中添加 None → np.nan 转换
   - 修复 `ufunc 'isnan' not supported` 错误
   - 影响方法：`generate_contour`, `export_contour_image`, `generate_contour_lines`

3. **修复 matplotlib 版本兼容性**
   - 在 `interpolation.py` 中添加等高线提取的版本兼容代码
   - 支持新版本的 `allsegs` 属性
   - 支持旧版本的 `collections` 属性
   - 修复 `'QuadContourSet' object has no attribute 'collections'` 错误

#### 📝 代码质量提升
- 所有 Python 文件通过 `getDiagnostics` 检查
- 所有 JavaScript 文件语法正确
- 删除了所有调试输出，日志更清晰
- 代码结构更简洁，易于维护

#### 🎯 性能优化
- 移除了未使用的缓存逻辑，减少内存占用
- 简化了云图生成流程
- 保持了现有的高性能（插值计算 < 1秒）

---

## 维护说明

### 代码规范
1. **调试代码**
   - ❌ 不要提交 `console.log` 到生产代码
   - ✅ 使用 `console.error` 和 `console.warn` 记录错误
   - ❌ 不要提交 `print()` 调试语句
   - ✅ 使用 Python 的 `logging` 模块（如需日志）

2. **未使用代码**
   - 定期检查并删除未使用的类、方法、函数
   - 避免过度设计（YAGNI 原则）
   - 保持代码简洁，只实现当前需要的功能

3. **错误处理**
   - 前端使用 `console.error` 记录错误
   - 后端返回结构化错误信息
   - 使用 `ErrorCode` 统一错误码

### 测试建议
1. **功能测试**
   - 测试等高线显示功能
   - 测试云图生成和导出
   - 测试应力场测绘完整流程

2. **兼容性测试**
   - 测试不同版本的 matplotlib
   - 测试不同的数据格式（None/NaN）
   - 测试边界情况（0个测点、1个测点等）

### 已知限制
1. **等高线功能**
   - 需要至少 3 个测点才能生成
   - 依赖 matplotlib 库（可选）
   - 不同版本的 matplotlib 可能有不同的 API

2. **云图缓存**
   - 当前使用简单的单实验缓存
   - 不支持多实验缓存（已删除 ContourCache）
   - 每次切换实验都会重新计算

3. **性能考虑**
   - 插值计算复杂度：O(n²)，n 为测点数
   - 建议测点数 < 100 以保持流畅
   - 大数据集可能需要优化

---

## 贡献指南

### 提交代码前检查清单
- [ ] 删除所有 `console.log` 调试语句
- [ ] 删除所有 `print()` 调试语句
- [ ] 运行语法检查（Python: `getDiagnostics`, JS: 浏览器控制台）
- [ ] 测试修改的功能
- [ ] 更新相关文档
- [ ] 检查是否有未使用的代码

### 代码审查要点
1. 是否有调试代码残留
2. 是否有未使用的导入
3. 是否有未使用的方法/类
4. 错误处理是否完善
5. 代码是否符合项目规范

---

**最后更新**: 2024-12-23
**文档版本**: 1.1
**项目状态**: 稳定运行，持续优化中
