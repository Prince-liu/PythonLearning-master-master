# 单轴应力检测模块设计文档 v1.0 - 第1.5部分

> **包含章节**：第3章 界面设计  
> **上一部分**：[第1部分](./单轴应力检测模块设计文档.md)  
> **下一部分**：[第2部分](./单轴应力检测模块设计文档-第2部分.md)

---

## 3. 界面设计

### 3.1 标签页结构

```
单轴应力检测模块
├── [单点检测] 标签（现有功能）
│   ├── 加载标定数据
│   ├── 采集基准波形
│   ├── 开始/停止波形监控
│   ├── 开始/停止应力检测
│   ├── 波形显示 Canvas
│   ├── 应力值显示
│   └── 记录和导出
│
└── [应力场测绘] 标签（新增功能）
    ├── 左侧控制栏 (30%)
    │   ├── 1. 标定数据选择
    │   ├── 2. 试件形状定义
    │   ├── 3. 布点设置
    │   ├── 4. 基准设置
    │   ├── 5. 采集控制
    │   └── 6. 云图设置
    │
    └── 右侧显示区 (70%)
        ├── 上半区域 (50%高度，可拖拽调节)
        │   ├── 数据表格 (左，50%宽度)
        │   │   └── 动态表头（根据形状和布点方式切换）
        │   └── 当前波形 (右，50%宽度)
        │       └── 采集阶段显示实时波形
        │
        └── 下半区域 (50%高度，可拖拽调节)
            ├── 预览画布 (左，50%宽度，可折叠)
            │   └── 显示试件形状 + 测点布局（静态）
            └── 应力云图 (右，50%宽度，可折叠)
                └── 显示试件形状 + 测点布局 + 应力云图（实时刷新）
```

---

### 3.2 左侧控制栏详细设计

#### 控制栏结构（30%宽度，6个折叠面板）

**1️⃣ 标定数据选择**（必填）
```
▼ 标定数据选择
  标定实验: [EXP001 - 铝板标定 ▼]
  测试方向: [0° ▼]
  
  [加载标定数据]
```

**2️⃣ 试件形状定义**（必填）
```
▼ 试件形状定义
  形状类型: [●矩形] [○圆形] [○自定义]
  
  【矩形模式】
    宽度 (mm): [100]
    高度 (mm): [150]
    ☑ 启用布尔运算
      [+ 添加孔洞/缺口] [+ 添加凸起]
  
  【圆形模式】
    圆心 X (mm): [50] 💡点击画布设置
    圆心 Y (mm): [50]
    外半径 (mm): [40]
    ☑ 启用扇形区域
      起始角度 (°): [0]
      结束角度 (°): [360]
    ☑ 启用圆环区域
      内半径 (mm): [0]
  
  【自定义模式】
    绘制方式: [○点击画布] [○输入坐标]
    顶点列表: ...
  
  [验证形状] [预览]
```

**3️⃣ 布点设置**（必填）
```
▼ 布点设置
  布点方式: [网格布点 ▼]
  
  【网格布点】
    行数: [5]
    列数: [5]
    行间距 (mm): [10] [变距]
    列间距 (mm): [10] [变距]
    边距 (mm): [10]
  
  【极坐标布点】
    圆心 X (mm): [50]
    圆心 Y (mm): [50]
    径向层数: [3]
    起始半径 (mm): [0]
    半径步长 (mm): [10]
    
    角度范围:
      起始角度 (°): [0]
      结束角度 (°): [360]
    
    角度分布:
      ○ 固定角度步长: [45] °
      ● 固定每层点数: [8] [每层不同]
  
  【变间距布点】
    密集区中心 X (mm): [50]
    密集区中心 Y (mm): [30]
    密集半径 (mm): [20]
    密集区测点数: [16]
    外围测点数: [12]
  
  【自定义布点】
    操作方式: [○点击画布] [○导入CSV]
    测点列表: ...
  
  [生成测点] [优化顺序]
```

**4️⃣ 基准设置**（必填）
```
▼ 基准设置
  基准测点: [#1 ▼]
  
  应力计算模式:
    ● 相对应力模式（基准点 = 0 MPa）
    ○ 绝对应力模式
      基准点应力值 (MPa): [0]
      💡 正值=拉应力，负值=压应力
  
  💡 说明:
    • 相对模式：测量应力分布，基准点为零点
    • 绝对模式：输入基准点真实应力，计算绝对值
```

**5️⃣ 采集控制**（操作区）
```
▼ 采集控制
  测点总数: 25
  已完成: 0
  进度: [████░░░░░░] 0%
  
  当前测点: #1 (10.0, 10.0)
  状态: 待测
  
  [开始采集/暂停] [结束采集] [重置]
  
  采集选项:
    ☑ 自动进入下一测点
    ☑ 测量失败自动重试
    ☐ 保存原始波形
```

**6️⃣ 云图设置**（可选）
```
▼ 云图设置
  插值方法: [线性 ▼]
    - 线性
    - 三次样条
    - 径向基函数
  
  网格密度: [50 ▼] 点/边
    - 30（粗糙）
    - 50（标准）
    - 100（精细）
  
  色标范围:
    ○ 自动
    ● 手动
      最小值 (MPa): [0]
      最大值 (MPa): [100]
  
  [生成云图] [导出数据]
```

---

#### 按钮状态切换逻辑

**采集控制按钮**：
- **未开始**：[开始采集] [重置]（结束按钮禁用）
- **采集中**：[暂停] [结束采集] [重置]（重置禁用）
- **已暂停**：[继续采集] [结束采集] [重置]
- **已结束**：[重新开始] [重置]（结束按钮禁用）

**结束采集功能**：
- 提前终止采集流程
- 保留已采集的数据
- 可用部分数据生成云图
- 适用于用户想提前结束的场景

---

#### 弹窗设计

**变距输入弹窗（网格布点）**
```
┌─────────────────────────────────┐
│ 行间距变距设置                   │
├─────────────────────────────────┤
│ 行间距数组 (共4个间距):          │
│   第1-2行间距 (mm): [10]        │
│   第2-3行间距 (mm): [15]        │
│   第3-4行间距 (mm): [15]        │
│   第4-5行间距 (mm): [10]        │
│                                  │
│ [确定] [取消] [恢复等距]         │
└─────────────────────────────────┘
```

**每层不同点数弹窗（极坐标布点）**
```
┌─────────────────────────────────┐
│ 每层点数设置                     │
├─────────────────────────────────┤
│ 每层点数配置 (共3层):            │
│   第1层点数: [6]                │
│   第2层点数: [8]                │
│   第3层点数: [12]               │
│                                  │
│ 提示: 通常外层点数 ≥ 内层点数    │
│                                  │
│ [确定] [取消] [恢复统一]         │
└─────────────────────────────────┘
```

---

#### 交互提示

**圆心坐标填写**：
- 手动输入：直接在输入框填数值
- 画布点击：在右侧预览画布上点击，自动填入坐标
- 实时预览：输入时画布实时显示圆的位置

**半径步长说明**：
- 相邻两层圆环之间的径向距离
- 示例：起始半径0mm，步长10mm，3层 → 生成0mm、10mm、20mm三层

**角度步长自动计算**：
- 完整圆：(360 - 0) / 点数
- 半圆：(180 - 0) / 点数
- 扇形：(结束角度 - 起始角度) / 点数

---

### 3.3 右侧显示区布局设计

#### 默认状态（采集阶段）
```
┌─────────────┬──────────────────────────────────────────────────────────┐
│             │ 右上 (50%高度)                                            │
│  左侧控制栏 ├────────────────┬─────────────────────────────────────────┤
│   (30%)     │ 数据表格 (50%) │ 当前波形 (50%)                          │
│             │ # │X │Y │σ    │  ╱╲╱╲╱╲                                │
│             │ 1 │..│..│..   │                                         │
│             ├────────────────┴─────────────────────────────────────────┤ ← 可拖拽调节
│             │ 右下 (50%高度)                                            │
│             ├────────────────┬─────────────────────────────────────────┤
│             │ [▼预览] (50%)  │ [▼云图] (50%)                           │
│             │ ┌────────────┐ │ ┌────────────┐                          │
│             │ │▶网格       │ │ │▶测点       │                          │
│             │ └────────────┘ │ └────────────┘                          │
│             │  ┌──────────┐  │  ┌──────────┐                           │
│             │  │ ● ● ● ●  │  │  │🔴🟠🟡🟢 │ ← 相同的形状+测点        │
│             │  │ ● ● ● ●  │  │  │🟢🟡🟠🔴 │   叠加应力云图          │
│             │  └──────────┘  │  └──────────┘                           │
└─────────────┴────────────────┴─────────────────────────────────────────┘
                    ↑                      ↑
              预览画布：静态          云图画布：实时刷新
              网格+刻度+密度          只控制测点显示/隐藏
              形状+测点布局           形状+测点+应力云图
              浮动控制面板
```

#### 折叠预览后
```
┌─────────────┬──────────────────────────────────────────────┐
│             │ 右上 (50%高度)                                │
│  左侧控制栏 ├────────────────┬─────────────────────────────┤
│   (30%)     │ 数据表格 (50%) │ 当前波形 (50%)              │
│             │                │                             │
│             ├────────────────┴─────────────────────────────┤ ← 可拖拽调节
│             │ 右下 (50%高度)                                │
│             ├─┬──────────────────────────────────────────┬─┤
│             │▲│ [▶预览]  [▼云图] (100%)                 │▲│
│             │ │  ┌──────────────────────────────────┐   │ │
│             │ │  │ 🔴🟠🟡🟢                        │   │ │
│             │▼│  │ 🟢🟡🟠🔴  (形状+测点+云图)    │   │▼│
│             │ │  └──────────────────────────────────┘   │ │
└─────────────┴─┴──────────────────────────────────────────┴─┘
```

#### 折叠云图后
```
┌─────────────┬──────────────────────────────────────────────┐
│             │ 右上 (50%高度)                                │
│  左侧控制栏 ├────────────────┬─────────────────────────────┤
│   (30%)     │ 数据表格 (50%) │ 当前波形 (50%)              │
│             │                │                             │
│             ├────────────────┴─────────────────────────────┤ ← 可拖拽调节
│             │ 右下 (50%高度)                                │
│             ├─┬──────────────────────────────────────────┬─┤
│             │▲│ [▼预览] (100%)  [▶云图]                 │▲│
│             │ │  ┌──────────────────────────────────┐   │ │
│             │ │  │ ● ● ● ● ● ● ●                  │   │ │
│             │▼│  │ ● ● ● ● ● ● ●  (形状+测点)     │   │▼│
│             │ │  └──────────────────────────────────┘   │ │
└─────────────┴─┴──────────────────────────────────────────┴─┘
```

#### 拖拽调整后（强调云图）
```
┌─────────────┬──────────────────────────────────────────────┐
│             │ 右上 (30%高度)                                │
│  左侧控制栏 ├────────────────┬─────────────────────────────┤
│   (30%)     │ 数据表格 (50%) │ 当前波形 (50%)              │
│             ├────────────────┴─────────────────────────────┤ ← 拖拽到这里
│             │ 右下 (70%高度)                                │
│             ├────────────────┬─────────────────────────────┤
│             │ [▶预览]        │ [▼云图] (100%)              │
│             │                │  ┌────────────────────────┐ │
│             │                │  │  🔴🟠🟡🟢            │ │
│             │                │  │  🟢🟡🟠🔴            │ │
│             │                │  │                        │ │
│             │                │  │  (形状+测点+云图)      │ │
│             │                │  │  (更大显示)            │ │
│             │                │  └────────────────────────┘ │
└─────────────┴────────────────┴─────────────────────────────┘
```

---

### 3.4 交互规则

#### 折叠/展开
- **点击标题栏**：折叠/展开面板（▼ 展开，▶ 折叠）
- **至少显示一项**：预览和云图不能同时折叠
- **折叠后**：另一项自动占满下半区域

#### 拖拽调节
- **上下拖拽**：调整上半/下半高度比例
- **左右拖拽**（上半）：调整表格/波形宽度比例
- **左右拖拽**（下半）：调整预览/云图宽度比例（展开时）

#### 默认比例
- **上下**：50% / 50%（可调范围 30%-70%）
- **上半左右**：50% / 50%（表格/波形）
- **下半左右**：50% / 50%（预览/云图，展开时）

---

### 3.5 数据表格动态表头设计

#### 设计原则
表头根据**形状类型**和**布点方式**动态切换，提供最直观的坐标显示。

#### 表头切换规则

**矩形试件 + 网格布点**
```
形状: 矩形 100×150mm | 布点: 网格 5×5

# │ X(mm) │ Y(mm) │ Δt(ns) │ σ(MPa) │状态│
1 │ 10.0  │ 10.0  │ 0.00   │ 0.0    │ ✓  │
2 │ 30.0  │ 10.0  │ 12.3   │ 45.2   │ ✓  │
3 │ 50.0  │ 10.0  │ 18.5   │ 62.1   │ ✓  │
```

**圆形试件 + 极坐标布点**
```
形状: 圆形 r=40mm | 布点: 极坐标 4圈×8点

# │ R(mm) │ θ(°)  │ Δt(ns) │ σ(MPa) │状态│
1 │ 0.0   │ -     │ 0.00   │ 0.0    │ ✓  │ ← 圆心
2 │ 10.0  │ 0     │ 12.3   │ 45.2   │ ✓  │
3 │ 10.0  │ 45    │ 15.1   │ 52.3   │ ✓  │
4 │ 10.0  │ 90    │ 18.2   │ 61.5   │ ✓  │
```

**圆形试件 + 网格布点（混合情况）**
```
形状: 圆形 r=40mm | 布点: 网格 5×5

# │ X(mm) │ Y(mm) │ Δt(ns) │ σ(MPa) │状态│
1 │ 10.0  │ 10.0  │ 0.00   │ 0.0    │ ✓  │
2 │ 30.0  │ 10.0  │ 12.3   │ 45.2   │ ✓  │
```

**自定义多边形**
```
形状: 自定义多边形 | 布点: 网格 5×5

# │ X(mm) │ Y(mm) │ Δt(ns) │ σ(MPa) │状态│
1 │ 10.0  │ 10.0  │ 0.00   │ 0.0    │ ✓  │
2 │ 25.5  │ 15.3  │ 12.3   │ 45.2   │ ✓  │
```

#### 实现逻辑

```javascript
function getTableHeaders(shapeType, layoutType) {
    /**
     * 根据形状和布点方式返回表头
     * 
     * 规则:
     * - 圆形 + 极坐标 → 使用 R、θ
     * - 其他情况 → 使用 X、Y
     */
    if (shapeType === 'circle' && layoutType === 'polar') {
        return ['#', 'R(mm)', 'θ(°)', 'Δt(ns)', 'σ(MPa)', '状态'];
    } else {
        return ['#', 'X(mm)', 'Y(mm)', 'Δt(ns)', 'σ(MPa)', '状态'];
    }
}

function renderTableRow(point, shapeType, layoutType) {
    /**
     * 渲染表格行
     * 根据表头类型显示对应的坐标
     */
    if (shapeType === 'circle' && layoutType === 'polar') {
        // 显示极坐标
        return [
            point.id,
            point.r.toFixed(1),
            point.theta === null ? '-' : point.theta.toFixed(0),
            point.timeDiff ? point.timeDiff.toFixed(2) : '-',
            point.stress ? point.stress.toFixed(2) : '-',
            getStatusIcon(point.status)
        ];
    } else {
        // 显示笛卡尔坐标
        return [
            point.id,
            point.x.toFixed(1),
            point.y.toFixed(1),
            point.timeDiff ? point.timeDiff.toFixed(2) : '-',
            point.stress ? point.stress.toFixed(2) : '-',
            getStatusIcon(point.status)
        ];
    }
}
```

#### 数据存储

**数据库中始终存储完整坐标**
```sql
CREATE TABLE field_points (
    id INTEGER PRIMARY KEY,
    experiment_id TEXT,
    point_index INTEGER,
    x_coord REAL,          -- 笛卡尔 X
    y_coord REAL,          -- 笛卡尔 Y
    r_coord REAL,          -- 极坐标 R（可选）
    theta_coord REAL,      -- 极坐标 θ（可选）
    time_diff REAL,
    stress_value REAL,
    status TEXT
);
```

**导出文件包含所有坐标**
```csv
#,X(mm),Y(mm),R(mm),θ(°),Δt(ns),σ(MPa),状态
1,50.0,50.0,0.0,-,0.00,0.0,已测
2,60.0,50.0,10.0,0,12.3,45.2,已测
3,50.0,60.0,10.0,90,15.1,52.3,已测
```

#### 用户体验优化

1. **表头提示**：鼠标悬停显示坐标系说明
   - X/Y：笛卡尔坐标系，原点在左下角
   - R/θ：极坐标系，R为半径，θ为角度（0°为正东方向）

2. **坐标转换**：提供"切换坐标显示"按钮
   - 用户可以在 X/Y 和 R/θ 之间手动切换
   - 切换时自动计算转换

3. **排序支持**：点击表头排序
   - X/Y 模式：按 X 或 Y 排序
   - R/θ 模式：按 R 或 θ 排序

---

### 3.6 实现要点

```javascript
// 面板状态管理
const panelState = {
    upperHeight: 50,        // 上半高度百分比
    upperLeftWidth: 50,     // 上半左侧宽度（表格）
    lowerLeftWidth: 50,     // 下半左侧宽度（预览）
    previewCollapsed: false,
    contourCollapsed: false
};

// 折叠逻辑
function togglePreview() {
    if (!panelState.previewCollapsed) {
        // 折叠预览
        panelState.previewCollapsed = true;
        panelState.lowerLeftWidth = 0;
    } else {
        // 展开预览
        panelState.previewCollapsed = false;
        panelState.lowerLeftWidth = 50;
    }
    updateLayout();
}

function toggleContour() {
    if (!panelState.contourCollapsed) {
        // 折叠云图
        panelState.contourCollapsed = true;
        panelState.lowerLeftWidth = 100;
    } else {
        // 展开云图
        panelState.contourCollapsed = false;
        panelState.lowerLeftWidth = 50;
    }
    updateLayout();
}

// 拖拽逻辑
function onDragVertical(deltaY) {
    // 调整上下比例
    panelState.upperHeight += deltaY;
    panelState.upperHeight = Math.max(30, Math.min(70, panelState.upperHeight));
    updateLayout();
}

function onDragHorizontalUpper(deltaX) {
    // 调整上半左右比例（表格/波形）
    panelState.upperLeftWidth += deltaX;
    panelState.upperLeftWidth = Math.max(30, Math.min(70, panelState.upperLeftWidth));
    updateLayout();
}

function onDragHorizontalLower(deltaX) {
    // 调整下半左右比例（预览/云图）
    if (!panelState.previewCollapsed && !panelState.contourCollapsed) {
        panelState.lowerLeftWidth += deltaX;
        panelState.lowerLeftWidth = Math.max(30, Math.min(70, panelState.lowerLeftWidth));
        updateLayout();
    }
}
```

---

### 3.7 配色方案

#### 预览画布配色

**画布底色**：
- 浅灰色 `#F5F5F5` 或纯白 `#FFFFFF`
- 营造工程图纸的专业感

**试件形状**：
- 填充：半透明浅蓝 `rgba(100, 150, 255, 0.1)`
- 边框：深蓝色 `#2196F3`，2px实线
- 孔洞：白色填充 + 红色虚线边框 `#F44336`

**网格线**（可开关）：
- 主网格：浅灰色 `#E0E0E0`，1px实线，透明度70%
- 次网格：更浅灰 `#F0F0F0`，1px虚线，透明度50%
- 刻度文字：深灰色 `#666666`，10px字号
- 原点标记：深灰色 `#424242`

**测点标记**：
- 待测：空心圆（半径4px），灰色边框 `#9E9E9E`
- 已测：实心圆（半径4px），绿色 `#4CAF50`
- 当前：高亮圆（半径6px），黄色 `#FFC107`，带2px白色光晕
- 跳过：叉号标记，橙色 `#FF9800`
- 错误：叉号标记，红色 `#F44336`
- 测点编号：黑色文字 `#212121`，12px字号

**视觉层级**（从下到上）：
```
第1层: 画布底色（浅灰/白）
第2层: 网格线（最淡，可关闭）
第3层: 试件形状（半透明蓝）
第4层: 测点标记（醒目）
第5层: 鼠标交互（最上层）
```

#### 云图配色

**色图选项**：
- Rainbow（彩虹）：红→橙→黄→绿→蓝→紫
- Jet：蓝→青→绿→黄→红
- Viridis：紫→蓝→绿→黄（色盲友好）

**色标**：
- 背景：白色半透明 `rgba(255, 255, 255, 0.9)`
- 边框：浅灰色 `#E0E0E0`
- 刻度文字：深灰色 `#424242`

#### 控制开关

**预览画布内嵌控制（右上角浮动面板）**：

**预览画布控制面板**（展开状态）：
```
┌─────────────────────────────────────────────┐
│ 预览画布                  ┌─────────────────┐│
│                           │▼网格 ☑显示网格  ││
│                           │     ☑显示刻度   ││
│                           │  ○粗 ●中 ○细   ││
│                           └─────────────────┘│
│                                              │
│   ●  ●  ●  ●  ●                             │
│                                              │
│   ●  ●  ●  ●  ●                             │
│                                              │
│   ●  ●  ●  ●  ●    (画布内容：试件形状+测点) │
│                                              │
│   ●  ●  ●  ●  ●                             │
│                                              │
│   ●  ●  ●  ●  ●                             │
│                                              │
└─────────────────────────────────────────────┘
```

**预览画布控制面板**（折叠状态）：
```
┌─────────────────────────────────────────────┐
│ 预览画布                          ┌────────┐│
│                                   │▶网格   ││
│                                   └────────┘│
│                                              │
│   ●  ●  ●  ●  ●                             │
│                                              │
│   ●  ●  ●  ●  ●                             │
│                                              │
│   ●  ●  ●  ●  ●    (画布内容完全可见)       │
│                                              │
│   ●  ●  ●  ●  ●                             │
│                                              │
│   ●  ●  ●  ●  ●                             │
│                                              │
└─────────────────────────────────────────────┘
```

**云图画布控制面板**（展开状态）：
```
┌─────────────────────────────────────────────┐
│ 应力云图                  ┌─────────────────┐│
│                           │▼测点 ☑显示测点  ││
│                           └─────────────────┘│
│                                              │
│   🔴🟠🟡🟢                                  │
│                                              │
│   🟢🟡🟠🔴                                  │
│                                              │
│   🟡🟢🔴🟠    (云图+形状+测点)             │
│                                              │
│   🟠🔴🟢🟡                                  │
│                                              │
│   🔴🟠🟡🟢                                  │
│                                              │
└─────────────────────────────────────────────┘
```

**云图画布控制面板**（折叠状态）：
```
┌─────────────────────────────────────────────┐
│ 应力云图                          ┌────────┐│
│                                   │▶测点   ││
│                                   └────────┘│
│                                              │
│   🔴🟠🟡🟢                                  │
│                                              │
│   🟢🟡🟠🔴                                  │
│                                              │
│   🟡🟢🔴🟠    (纯云图，测点隐藏)           │
│                                              │
│   🟠🔴🟢🟡                                  │
│                                              │
│   🔴🟠🟡🟢                                  │
│                                              │
└─────────────────────────────────────────────┘
```

**控制面板对比**：

| 画布类型 | 控制内容 | 选项 |
|---------|---------|------|
| **预览画布** | 网格显示 | ☑显示网格、☑显示刻度、密度（粗/中/细） |
| **云图画布** | 测点显示 | ☑显示测点（开/关） |

**交互说明**：
- **展开/折叠**：点击标题栏切换
- **半透明背景**：展开时 opacity: 0.9，鼠标悬停时 opacity: 1.0
- **默认状态**：首次打开时为折叠状态
- **记忆状态**：记住用户的展开/折叠选择

**设计理由**：
1. **预览画布**：需要网格和刻度辅助定位，帮助验证测点位置
2. **云图画布**：不需要网格（会干扰云图观察），只需控制是否显示测点标记
3. **简洁原则**：云图画布控制更简单，只有一个开关
```

#### 设计原则

1. **不干扰主体**：网格和刻度使用低对比度颜色，不抢眼
2. **层次分明**：通过透明度和颜色深浅区分不同元素
3. **状态清晰**：测点状态用颜色直观表达（绿=完成，黄=当前，灰=待测）
4. **可关闭**：网格和刻度可独立开关，保持画面干净
5. **专业感**：参考CAD和工程软件的配色风格

---

**📄 文档说明**：本文档为第1.5部分，包含第3章内容。  
**⬅️ 上一部分**：[单轴应力检测模块设计文档.md](./单轴应力检测模块设计文档.md)  
**➡️ 下一部分**：[单轴应力检测模块设计文档-第2部分.md](./单轴应力检测模块设计文档-第2部分.md)
